<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fpica</title>
  <meta name="keywords" content="fpica">
  <meta name="description" content="FPICA - Fixed point ICA. Main algorithm of FASTICA.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">FastICA_25</a> &gt; fpica.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for FastICA_25&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>fpica
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>FPICA - Fixed point ICA. Main algorithm of FASTICA.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [A, W] = fpica(X, whiteningMatrix, dewhiteningMatrix, approach,numOfIC, g, finetune, a1, a2, myy, stabilization,epsilon, maxNumIterations, maxFinetune, initState,guess, sampleSize, displayMode, displayInterval,s_verbose); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">FPICA - Fixed point ICA. Main algorithm of FASTICA.

 [A, W] = fpica(whitesig, whiteningMatrix, dewhiteningMatrix, approach,
        numOfIC, g, finetune, a1, a2, mu, stabilization, epsilon, 
        maxNumIterations, maxFinetune, initState, guess, sampleSize,
        displayMode, displayInterval, verbose);
 
 Perform independent component analysis using Hyvarinen's fixed point
 algorithm. Outputs an estimate of the mixing matrix A and its inverse W.

 whitesig                              :the whitened data as row vectors
 whiteningMatrix                       :can be obtained with function whitenv
 dewhiteningMatrix                     :can be obtained with function whitenv
 approach      [ 'symm' | 'defl' ]     :the approach used (deflation or symmetric)
 numOfIC       [ 0 - Dim of whitesig ] :number of independent components estimated
 g             [ 'pow3' | 'tanh' |     :the nonlinearity used
                 'gaus' | 'skew' ]     
 finetune      [same as g + 'off']     :the nonlinearity used in finetuning.
 a1                                    :parameter for tuning 'tanh'
 a2                                    :parameter for tuning 'gaus'
 mu                                    :step size in stabilized algorithm
 stabilization [ 'on' | 'off' ]        :if mu &lt; 1 then automatically on
 epsilon                               :stopping criterion
 maxNumIterations                      :maximum number of iterations 
 maxFinetune                           :maximum number of iteretions for finetuning
 initState     [ 'rand' | 'guess' ]    :initial guess or random initial state. See below
 guess                                 :initial guess for A. Ignored if initState = 'rand'
 sampleSize    [ 0 - 1 ]               :percentage of the samples used in one iteration
 displayMode   [ 'signals' | 'basis' | :plot running estimate
                 'filters' | 'off' ]
 displayInterval                       :number of iterations we take between plots
 verbose       [ 'on' | 'off' ]        :report progress in text format

 EXAMPLE
       [E, D] = pcamat(vectors);
       [nv, wm, dwm] = whitenv(vectors, E, D);
       [A, W] = fpica(nv, wm, dwm);


 This function is needed by FASTICA and FASTICAG

   See also <a href="fastica.html" class="code" title="function [Out1, Out2, Out3] = fastica(mixedsig, varargin)">FASTICA</a>, <a href="fasticag.html" class="code" title="function fasticag(mixedsig, InitialGuess)">FASTICAG</a>, <a href="whitenv.html" class="code" title="function [newVectors, whiteningMatrix, dewhiteningMatrix] = whitenv(vectors, E, D, s_verbose);">WHITENV</a>, <a href="pcamat.html" class="code" title="function [E, D] = pcamat(vectors, firstEig, lastEig, s_interactive,s_verbose);">PCAMAT</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>	ICAPLOT - plot signals in various ways</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="fastica.html" class="code" title="function [Out1, Out2, Out3] = fastica(mixedsig, varargin)">fastica</a>	FASTICA - Fast Independent Component Analysis</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function y=tanh(x)</a></li><li><a href="#_sub2" class="code">function Samples = getSamples(max, percentage)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [A, W] = fpica(X, whiteningMatrix, dewhiteningMatrix, approach, </a><span class="keyword">...</span>
0002             numOfIC, g, finetune, a1, a2, myy, stabilization, <span class="keyword">...</span>
0003             epsilon, maxNumIterations, maxFinetune, initState, <span class="keyword">...</span>
0004             guess, sampleSize, displayMode, displayInterval, <span class="keyword">...</span>
0005             s_verbose);
0006 <span class="comment">%FPICA - Fixed point ICA. Main algorithm of FASTICA.</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% [A, W] = fpica(whitesig, whiteningMatrix, dewhiteningMatrix, approach,</span>
0009 <span class="comment">%        numOfIC, g, finetune, a1, a2, mu, stabilization, epsilon,</span>
0010 <span class="comment">%        maxNumIterations, maxFinetune, initState, guess, sampleSize,</span>
0011 <span class="comment">%        displayMode, displayInterval, verbose);</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Perform independent component analysis using Hyvarinen's fixed point</span>
0014 <span class="comment">% algorithm. Outputs an estimate of the mixing matrix A and its inverse W.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% whitesig                              :the whitened data as row vectors</span>
0017 <span class="comment">% whiteningMatrix                       :can be obtained with function whitenv</span>
0018 <span class="comment">% dewhiteningMatrix                     :can be obtained with function whitenv</span>
0019 <span class="comment">% approach      [ 'symm' | 'defl' ]     :the approach used (deflation or symmetric)</span>
0020 <span class="comment">% numOfIC       [ 0 - Dim of whitesig ] :number of independent components estimated</span>
0021 <span class="comment">% g             [ 'pow3' | 'tanh' |     :the nonlinearity used</span>
0022 <span class="comment">%                 'gaus' | 'skew' ]</span>
0023 <span class="comment">% finetune      [same as g + 'off']     :the nonlinearity used in finetuning.</span>
0024 <span class="comment">% a1                                    :parameter for tuning 'tanh'</span>
0025 <span class="comment">% a2                                    :parameter for tuning 'gaus'</span>
0026 <span class="comment">% mu                                    :step size in stabilized algorithm</span>
0027 <span class="comment">% stabilization [ 'on' | 'off' ]        :if mu &lt; 1 then automatically on</span>
0028 <span class="comment">% epsilon                               :stopping criterion</span>
0029 <span class="comment">% maxNumIterations                      :maximum number of iterations</span>
0030 <span class="comment">% maxFinetune                           :maximum number of iteretions for finetuning</span>
0031 <span class="comment">% initState     [ 'rand' | 'guess' ]    :initial guess or random initial state. See below</span>
0032 <span class="comment">% guess                                 :initial guess for A. Ignored if initState = 'rand'</span>
0033 <span class="comment">% sampleSize    [ 0 - 1 ]               :percentage of the samples used in one iteration</span>
0034 <span class="comment">% displayMode   [ 'signals' | 'basis' | :plot running estimate</span>
0035 <span class="comment">%                 'filters' | 'off' ]</span>
0036 <span class="comment">% displayInterval                       :number of iterations we take between plots</span>
0037 <span class="comment">% verbose       [ 'on' | 'off' ]        :report progress in text format</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% EXAMPLE</span>
0040 <span class="comment">%       [E, D] = pcamat(vectors);</span>
0041 <span class="comment">%       [nv, wm, dwm] = whitenv(vectors, E, D);</span>
0042 <span class="comment">%       [A, W] = fpica(nv, wm, dwm);</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% This function is needed by FASTICA and FASTICAG</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%   See also FASTICA, FASTICAG, WHITENV, PCAMAT</span>
0048 
0049 <span class="comment">% @(#)$Id: fpica.m,v 1.7 2005/06/16 12:52:55 jarmo Exp $</span>
0050 
0051 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0052 <span class="comment">% Global variable for stopping the ICA calculations from the GUI</span>
0053 <span class="keyword">global</span> g_FastICA_interrupt;
0054 <span class="keyword">if</span> isempty(g_FastICA_interrupt)
0055   clear <span class="keyword">global</span> g_FastICA_interrupt;
0056   interruptible = 0;
0057 <span class="keyword">else</span>
0058   interruptible = 1;
0059 <span class="keyword">end</span>
0060 
0061 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0062 <span class="comment">% Default values</span>
0063 
0064 <span class="keyword">if</span> nargin &lt; 3, error(<span class="string">'Not enough arguments!'</span>); <span class="keyword">end</span>
0065 [vectorSize, numSamples] = size(X);
0066 <span class="keyword">if</span> nargin &lt; 20, s_verbose = <span class="string">'on'</span>; <span class="keyword">end</span>
0067 <span class="keyword">if</span> nargin &lt; 19, displayInterval = 1; <span class="keyword">end</span>
0068 <span class="keyword">if</span> nargin &lt; 18, displayMode = <span class="string">'on'</span>; <span class="keyword">end</span>
0069 <span class="keyword">if</span> nargin &lt; 17, sampleSize = 1; <span class="keyword">end</span>
0070 <span class="keyword">if</span> nargin &lt; 16, guess = 1; <span class="keyword">end</span>
0071 <span class="keyword">if</span> nargin &lt; 15, initState = <span class="string">'rand'</span>; <span class="keyword">end</span>
0072 <span class="keyword">if</span> nargin &lt; 14, maxFinetune = 100; <span class="keyword">end</span>
0073 <span class="keyword">if</span> nargin &lt; 13, maxNumIterations = 1000; <span class="keyword">end</span>
0074 <span class="keyword">if</span> nargin &lt; 12, epsilon = 0.0001; <span class="keyword">end</span>
0075 <span class="keyword">if</span> nargin &lt; 11, stabilization = <span class="string">'on'</span>; <span class="keyword">end</span>
0076 <span class="keyword">if</span> nargin &lt; 10, myy = 1; <span class="keyword">end</span>
0077 <span class="keyword">if</span> nargin &lt; 9, a2 = 1; <span class="keyword">end</span>
0078 <span class="keyword">if</span> nargin &lt; 8, a1 = 1; <span class="keyword">end</span>
0079 <span class="keyword">if</span> nargin &lt; 7, finetune = <span class="string">'off'</span>; <span class="keyword">end</span>
0080 <span class="keyword">if</span> nargin &lt; 6, g = <span class="string">'pow3'</span>; <span class="keyword">end</span>
0081 <span class="keyword">if</span> nargin &lt; 5, numOfIC = vectorSize; <span class="keyword">end</span>     <span class="comment">% vectorSize = Dim</span>
0082 <span class="keyword">if</span> nargin &lt; 4, approach = <span class="string">'defl'</span>; <span class="keyword">end</span>
0083 
0084 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0085 <span class="comment">% Checking the data</span>
0086 
0087 <span class="keyword">if</span> ~isreal(X)
0088   error(<span class="string">'Input has an imaginary part.'</span>);
0089 <span class="keyword">end</span>
0090 
0091 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0092 <span class="comment">% Checking the value for verbose</span>
0093 
0094 <span class="keyword">switch</span> lower(s_verbose)
0095  <span class="keyword">case</span> <span class="string">'on'</span>
0096   b_verbose = 1;
0097  <span class="keyword">case</span> <span class="string">'off'</span>
0098   b_verbose = 0;
0099  <span class="keyword">otherwise</span>
0100   error(sprintf(<span class="string">'Illegal value [ %s ] for parameter: ''verbose''\n'</span>, s_verbose));
0101 <span class="keyword">end</span>
0102 
0103 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0104 <span class="comment">% Checking the value for approach</span>
0105 
0106 <span class="keyword">switch</span> lower(approach)
0107  <span class="keyword">case</span> <span class="string">'symm'</span>
0108   approachMode = 1;
0109  <span class="keyword">case</span> <span class="string">'defl'</span>
0110   approachMode = 2;
0111  <span class="keyword">otherwise</span>
0112   error(sprintf(<span class="string">'Illegal value [ %s ] for parameter: ''approach''\n'</span>, approach));
0113 <span class="keyword">end</span>
0114 <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Used approach [ %s ].\n'</span>, approach); <span class="keyword">end</span>
0115 
0116 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0117 <span class="comment">% Checking the value for numOfIC</span>
0118 
0119 <span class="keyword">if</span> vectorSize &lt; numOfIC
0120   error(<span class="string">'Must have numOfIC &lt;= Dimension!'</span>);
0121 <span class="keyword">end</span>
0122 
0123 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0124 <span class="comment">% Checking the sampleSize</span>
0125 <span class="keyword">if</span> sampleSize &gt; 1
0126   sampleSize = 1;
0127   <span class="keyword">if</span> b_verbose
0128     fprintf(<span class="string">'Warning: Setting ''sampleSize'' to 1.\n'</span>);
0129   <span class="keyword">end</span>  
0130 <span class="keyword">elseif</span> sampleSize &lt; 1
0131   <span class="keyword">if</span> (sampleSize * numSamples) &lt; 1000
0132     sampleSize = min(1000/numSamples, 1);
0133     <span class="keyword">if</span> b_verbose
0134       fprintf(<span class="string">'Warning: Setting ''sampleSize'' to %0.3f (%d samples).\n'</span>, <span class="keyword">...</span>
0135           sampleSize, floor(sampleSize * numSamples));
0136     <span class="keyword">end</span>  
0137   <span class="keyword">end</span>
0138 <span class="keyword">end</span>
0139 <span class="keyword">if</span> b_verbose
0140   <span class="keyword">if</span>  b_verbose &amp; (sampleSize &lt; 1)
0141     fprintf(<span class="string">'Using about %0.0f%% of the samples in random order in every step.\n'</span>,sampleSize*100);
0142   <span class="keyword">end</span>
0143 <span class="keyword">end</span>
0144 
0145 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0146 <span class="comment">% Checking the value for nonlinearity.</span>
0147 
0148 <span class="keyword">switch</span> lower(g)
0149  <span class="keyword">case</span> <span class="string">'pow3'</span>
0150   gOrig = 10;
0151  <span class="keyword">case</span> <span class="string">'tanh'</span>
0152   gOrig = 20;
0153  <span class="keyword">case</span> {<span class="string">'gaus'</span>, <span class="string">'gauss'</span>}
0154   gOrig = 30;
0155  <span class="keyword">case</span> <span class="string">'skew'</span>
0156   gOrig = 40;
0157  <span class="keyword">otherwise</span>
0158   error(sprintf(<span class="string">'Illegal value [ %s ] for parameter: ''g''\n'</span>, g));
0159 <span class="keyword">end</span>
0160 <span class="keyword">if</span> sampleSize ~= 1
0161   gOrig = gOrig + 2;
0162 <span class="keyword">end</span>
0163 <span class="keyword">if</span> myy ~= 1
0164   gOrig = gOrig + 1;
0165 <span class="keyword">end</span>
0166 
0167 <span class="keyword">if</span> b_verbose,
0168   fprintf(<span class="string">'Used nonlinearity [ %s ].\n'</span>, g);
0169 <span class="keyword">end</span>
0170 
0171 finetuningEnabled = 1;
0172 <span class="keyword">switch</span> lower(finetune)
0173  <span class="keyword">case</span> <span class="string">'pow3'</span>
0174   gFine = 10 + 1;
0175  <span class="keyword">case</span> <span class="string">'tanh'</span>
0176   gFine = 20 + 1;
0177  <span class="keyword">case</span> {<span class="string">'gaus'</span>, <span class="string">'gauss'</span>}
0178   gFine = 30 + 1;
0179  <span class="keyword">case</span> <span class="string">'skew'</span>
0180   gFine = 40 + 1;
0181  <span class="keyword">case</span> <span class="string">'off'</span>
0182   <span class="keyword">if</span> myy ~= 1
0183     gFine = gOrig;
0184   <span class="keyword">else</span> 
0185     gFine = gOrig + 1;
0186   <span class="keyword">end</span>
0187   finetuningEnabled = 0;
0188  <span class="keyword">otherwise</span>
0189   error(sprintf(<span class="string">'Illegal value [ %s ] for parameter: ''finetune''\n'</span>, <span class="keyword">...</span>
0190         finetune));
0191 <span class="keyword">end</span>
0192 
0193 <span class="keyword">if</span> b_verbose &amp; finetuningEnabled
0194   fprintf(<span class="string">'Finetuning enabled (nonlinearity: [ %s ]).\n'</span>, finetune);
0195 <span class="keyword">end</span>
0196 
0197 <span class="keyword">switch</span> lower(stabilization)
0198  <span class="keyword">case</span> <span class="string">'on'</span>
0199   stabilizationEnabled = 1;
0200  <span class="keyword">case</span> <span class="string">'off'</span>
0201   <span class="keyword">if</span> myy ~= 1
0202     stabilizationEnabled = 1;
0203   <span class="keyword">else</span>
0204     stabilizationEnabled = 0;
0205   <span class="keyword">end</span>
0206  <span class="keyword">otherwise</span>
0207   error(sprintf(<span class="string">'Illegal value [ %s ] for parameter: ''stabilization''\n'</span>, <span class="keyword">...</span>
0208         stabilization)); 
0209 <span class="keyword">end</span>
0210 
0211 <span class="keyword">if</span> b_verbose &amp; stabilizationEnabled
0212   fprintf(<span class="string">'Using stabilized algorithm.\n'</span>);
0213 <span class="keyword">end</span>
0214 
0215 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0216 <span class="comment">% Some other parameters</span>
0217 myyOrig = myy;
0218 <span class="comment">% When we start fine-tuning we'll set myy = myyK * myy</span>
0219 myyK = 0.01;
0220 <span class="comment">% How many times do we try for convergence until we give up.</span>
0221 failureLimit = 5;
0222 
0223 
0224 usedNlinearity = gOrig;
0225 stroke = 0;
0226 notFine = 1;
0227 long = 0;
0228 
0229 
0230 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0231 <span class="comment">% Checking the value for initial state.</span>
0232 
0233 <span class="keyword">switch</span> lower(initState)
0234  <span class="keyword">case</span> <span class="string">'rand'</span>
0235   initialStateMode = 0;
0236  <span class="keyword">case</span> <span class="string">'guess'</span>
0237   <span class="keyword">if</span> size(guess,1) ~= size(whiteningMatrix,2)
0238     initialStateMode = 0;
0239     <span class="keyword">if</span> b_verbose
0240       fprintf(<span class="string">'Warning: size of initial guess is incorrect. Using random initial guess.\n'</span>);
0241     <span class="keyword">end</span>
0242   <span class="keyword">else</span>
0243     initialStateMode = 1;
0244     <span class="keyword">if</span> size(guess,2) &lt; numOfIC
0245       <span class="keyword">if</span> b_verbose
0246     fprintf(<span class="string">'Warning: initial guess only for first %d components. Using random initial guess for others.\n'</span>, size(guess,2)); 
0247       <span class="keyword">end</span>
0248       guess(:, size(guess, 2) + 1:numOfIC) = <span class="keyword">...</span>
0249                          rand(vectorSize,numOfIC-size(guess,2))-.5;
0250     <span class="keyword">elseif</span> size(guess,2)&gt;numOfIC
0251       guess=guess(:,1:numOfIC);
0252       fprintf(<span class="string">'Warning: Initial guess too large. The excess column are dropped.\n'</span>);
0253     <span class="keyword">end</span>
0254     <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Using initial guess.\n'</span>); <span class="keyword">end</span>
0255   <span class="keyword">end</span>
0256  <span class="keyword">otherwise</span>
0257   error(sprintf(<span class="string">'Illegal value [ %s ] for parameter: ''initState''\n'</span>, initState));
0258 <span class="keyword">end</span>
0259 
0260 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0261 <span class="comment">% Checking the value for display mode.</span>
0262 
0263 <span class="keyword">switch</span> lower(displayMode)
0264  <span class="keyword">case</span> {<span class="string">'off'</span>, <span class="string">'none'</span>}
0265   usedDisplay = 0;
0266  <span class="keyword">case</span> {<span class="string">'on'</span>, <span class="string">'signals'</span>}
0267   usedDisplay = 1;
0268   <span class="keyword">if</span> (b_verbose &amp; (numSamples &gt; 10000))
0269     fprintf(<span class="string">'Warning: Data vectors are very long. Plotting may take long time.\n'</span>);
0270   <span class="keyword">end</span>
0271   <span class="keyword">if</span> (b_verbose &amp; (numOfIC &gt; 25))
0272     fprintf(<span class="string">'Warning: There are too many signals to plot. Plot may not look good.\n'</span>);
0273   <span class="keyword">end</span>
0274  <span class="keyword">case</span> <span class="string">'basis'</span>
0275   usedDisplay = 2;
0276   <span class="keyword">if</span> (b_verbose &amp; (numOfIC &gt; 25))
0277     fprintf(<span class="string">'Warning: There are too many signals to plot. Plot may not look good.\n'</span>);
0278   <span class="keyword">end</span>
0279  <span class="keyword">case</span> <span class="string">'filters'</span>
0280   usedDisplay = 3;
0281   <span class="keyword">if</span> (b_verbose &amp; (vectorSize &gt; 25))
0282     fprintf(<span class="string">'Warning: There are too many signals to plot. Plot may not look good.\n'</span>);
0283   <span class="keyword">end</span>
0284  <span class="keyword">otherwise</span>
0285   error(sprintf(<span class="string">'Illegal value [ %s ] for parameter: ''displayMode''\n'</span>, displayMode));
0286 <span class="keyword">end</span>
0287 
0288 <span class="comment">% The displayInterval can't be less than 1...</span>
0289 <span class="keyword">if</span> displayInterval &lt; 1
0290   displayInterval = 1;
0291 <span class="keyword">end</span>
0292 
0293 
0294 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0295 <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Starting ICA calculation...\n'</span>); <span class="keyword">end</span>
0296 
0297 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0298 <span class="comment">% SYMMETRIC APPROACH</span>
0299 <span class="keyword">if</span> approachMode == 1,
0300 
0301   <span class="comment">% set some parameters more...</span>
0302   usedNlinearity = gOrig;
0303   stroke = 0;
0304   notFine = 1;
0305   long = 0;
0306   
0307   A = zeros(vectorSize, numOfIC);  <span class="comment">% Dewhitened basis vectors.</span>
0308   <span class="keyword">if</span> initialStateMode == 0
0309     <span class="comment">% Take random orthonormal initial vectors.</span>
0310     B = orth (randn (vectorSize, numOfIC));
0311   <span class="keyword">elseif</span> initialStateMode == 1
0312     <span class="comment">% Use the given initial vector as the initial state</span>
0313     B = whiteningMatrix * guess;
0314   <span class="keyword">end</span>
0315   
0316   BOld = zeros(size(B));
0317   BOld2 = zeros(size(B));
0318   
0319   <span class="comment">% This is the actual fixed-point iteration loop.</span>
0320   <span class="keyword">for</span> round = 1:maxNumIterations + 1,
0321     <span class="keyword">if</span> round == maxNumIterations + 1,
0322       fprintf(<span class="string">'No convergence after %d steps\n'</span>, maxNumIterations);
0323       fprintf(<span class="string">'Note that the plots are probably wrong.\n'</span>);
0324       <span class="keyword">if</span> ~isempty(B)
0325     <span class="comment">% Symmetric orthogonalization.</span>
0326     B = B * real(inv(B' * B)^(1/2));
0327 
0328     W = B' * whiteningMatrix;
0329     A = dewhiteningMatrix * B;
0330       <span class="keyword">else</span>
0331     W = [];
0332     A = [];
0333       <span class="keyword">end</span>
0334       <span class="keyword">return</span>;
0335     <span class="keyword">end</span>
0336     
0337     <span class="keyword">if</span> (interruptible &amp; g_FastICA_interrupt)
0338       <span class="keyword">if</span> b_verbose 
0339         fprintf(<span class="string">'\n\nCalculation interrupted by the user\n'</span>);
0340       <span class="keyword">end</span>
0341       <span class="keyword">if</span> ~isempty(B)
0342     W = B' * whiteningMatrix;
0343     A = dewhiteningMatrix * B;
0344       <span class="keyword">else</span>
0345     W = [];
0346     A = [];
0347       <span class="keyword">end</span>
0348       <span class="keyword">return</span>;
0349     <span class="keyword">end</span>
0350     
0351     
0352     <span class="comment">% Symmetric orthogonalization.</span>
0353     B = B * real(inv(B' * B)^(1/2));
0354     
0355     <span class="comment">% Test for termination condition. Note that we consider opposite</span>
0356     <span class="comment">% directions here as well.</span>
0357     minAbsCos = min(abs(diag(B' * BOld)));
0358     minAbsCos2 = min(abs(diag(B' * BOld2)));
0359     
0360     <span class="keyword">if</span> (1 - minAbsCos &lt; epsilon)
0361       <span class="keyword">if</span> finetuningEnabled &amp; notFine
0362         <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Initial convergence, fine-tuning: \n'</span>); <span class="keyword">end</span>;
0363         notFine = 0;
0364         usedNlinearity = gFine;
0365         myy = myyK * myyOrig;
0366         BOld = zeros(size(B));
0367         BOld2 = zeros(size(B));
0368     
0369       <span class="keyword">else</span>
0370         <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Convergence after %d steps\n'</span>, round); <span class="keyword">end</span>
0371     
0372         <span class="comment">% Calculate the de-whitened vectors.</span>
0373         A = dewhiteningMatrix * B;
0374         <span class="keyword">break</span>;
0375       <span class="keyword">end</span>
0376     <span class="keyword">elseif</span> stabilizationEnabled
0377       <span class="keyword">if</span> (~stroke) &amp; (1 - minAbsCos2 &lt; epsilon)
0378     <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Stroke!\n'</span>); <span class="keyword">end</span>;
0379     stroke = myy;
0380     myy = .5*myy;
0381     <span class="keyword">if</span> mod(usedNlinearity,2) == 0
0382       usedNlinearity = usedNlinearity + 1;
0383     <span class="keyword">end</span>
0384       <span class="keyword">elseif</span> stroke
0385     myy = stroke;
0386     stroke = 0;
0387     <span class="keyword">if</span> (myy == 1) &amp; (mod(usedNlinearity,2) ~= 0)
0388       usedNlinearity = usedNlinearity - 1;
0389     <span class="keyword">end</span>
0390       <span class="keyword">elseif</span> (~long) &amp; (round&gt;maxNumIterations/2)
0391     <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Taking long (reducing step size)\n'</span>); <span class="keyword">end</span>;
0392     long = 1;
0393     myy = .5*myy;
0394     <span class="keyword">if</span> mod(usedNlinearity,2) == 0
0395       usedNlinearity = usedNlinearity + 1;
0396     <span class="keyword">end</span>
0397       <span class="keyword">end</span>
0398     <span class="keyword">end</span>
0399     
0400     BOld2 = BOld;
0401     BOld = B;
0402     
0403     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0404     <span class="comment">% Show the progress...</span>
0405     <span class="keyword">if</span> b_verbose
0406       <span class="keyword">if</span> round == 1
0407         fprintf(<span class="string">'Step no. %d\n'</span>, round);
0408       <span class="keyword">else</span>
0409         fprintf(<span class="string">'Step no. %d, change in value of estimate: %.3g \n'</span>, round, 1 - minAbsCos);
0410       <span class="keyword">end</span>
0411     <span class="keyword">end</span>
0412     
0413     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0414     <span class="comment">% Also plot the current state...</span>
0415     <span class="keyword">switch</span> usedDisplay
0416      <span class="keyword">case</span> 1
0417       <span class="keyword">if</span> rem(round, displayInterval) == 0,
0418     <span class="comment">% There was and may still be other displaymodes...</span>
0419     <span class="comment">% 1D signals</span>
0420     <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,(X'*B)');
0421     drawnow;
0422       <span class="keyword">end</span>
0423      <span class="keyword">case</span> 2
0424       <span class="keyword">if</span> rem(round, displayInterval) == 0,
0425     <span class="comment">% ... and now there are :-)</span>
0426     <span class="comment">% 1D basis</span>
0427     A = dewhiteningMatrix * B;
0428     <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,A');
0429     drawnow;
0430       <span class="keyword">end</span>
0431      <span class="keyword">case</span> 3
0432       <span class="keyword">if</span> rem(round, displayInterval) == 0,
0433     <span class="comment">% ... and now there are :-)</span>
0434     <span class="comment">% 1D filters</span>
0435     W = B' * whiteningMatrix;
0436     <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,W);
0437     drawnow;
0438       <span class="keyword">end</span>
0439      <span class="keyword">otherwise</span>
0440     <span class="keyword">end</span>
0441     
0442     <span class="keyword">switch</span> usedNlinearity
0443       <span class="comment">% pow3</span>
0444      <span class="keyword">case</span> 10
0445       B = (X * (( X' * B) .^ 3)) / numSamples - 3 * B;
0446      <span class="keyword">case</span> 11
0447       <span class="comment">% optimoitu - epsilonin kokoisia eroja</span>
0448       <span class="comment">% tämä on optimoitu koodi, katso vanha koodi esim.</span>
0449       <span class="comment">% aikaisemmista versioista kuten 2.0 beta3</span>
0450       Y = X' * B;
0451       Gpow3 = Y .^ 3;
0452       Beta = sum(Y .* Gpow3);
0453       D = diag(1 ./ (Beta - 3 * numSamples));
0454       B = B + myy * B * (Y' * Gpow3 - diag(Beta)) * D;
0455      <span class="keyword">case</span> 12
0456       Xsub=X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0457       B = (Xsub * (( Xsub' * B) .^ 3)) / size(Xsub,2) - 3 * B;
0458      <span class="keyword">case</span> 13
0459       <span class="comment">% Optimoitu</span>
0460       Ysub=X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize))' * B;
0461       Gpow3 = Ysub .^ 3;
0462       Beta = sum(Ysub .* Gpow3);
0463       D = diag(1 ./ (Beta - 3 * size(Ysub', 2)));
0464       B = B + myy * B * (Ysub' * Gpow3 - diag(Beta)) * D;
0465       
0466       <span class="comment">% tanh</span>
0467      <span class="keyword">case</span> 20
0468       hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * X' * B);
0469       B = X * hypTan / numSamples - <span class="keyword">...</span>
0470       ones(size(B,1),1) * sum(1 - hypTan .^ 2) .* B / numSamples * <span class="keyword">...</span>
0471       a1;
0472      <span class="keyword">case</span> 21
0473       <span class="comment">% optimoitu - epsilonin kokoisia</span>
0474       Y = X' * B;
0475       hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * Y);
0476       Beta = sum(Y .* hypTan);
0477       D = diag(1 ./ (Beta - a1 * sum(1 - hypTan .^ 2)));
0478       B = B + myy * B * (Y' * hypTan - diag(Beta)) * D;
0479      <span class="keyword">case</span> 22
0480       Xsub=X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0481       hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * Xsub' * B);
0482       B = Xsub * hypTan / size(Xsub, 2) - <span class="keyword">...</span>
0483       ones(size(B,1),1) * sum(1 - hypTan .^ 2) .* B / size(Xsub, 2) * a1;
0484      <span class="keyword">case</span> 23
0485       <span class="comment">% Optimoitu</span>
0486       Y = X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize))' * B;
0487       hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * Y);
0488       Beta = sum(Y .* hypTan);
0489       D = diag(1 ./ (Beta - a1 * sum(1 - hypTan .^ 2)));
0490       B = B + myy * B * (Y' * hypTan - diag(Beta)) * D;
0491       
0492       <span class="comment">% gauss</span>
0493      <span class="keyword">case</span> 30
0494       U = X' * B;
0495       Usquared=U .^ 2;
0496       ex = exp(-a2 * Usquared / 2);
0497       gauss =  U .* ex;
0498       dGauss = (1 - a2 * Usquared) .*ex;
0499       B = X * gauss / numSamples - <span class="keyword">...</span>
0500       ones(size(B,1),1) * sum(dGauss)<span class="keyword">...</span>
0501       .* B / numSamples ;
0502      <span class="keyword">case</span> 31
0503       <span class="comment">% optimoitu</span>
0504       Y = X' * B;
0505       ex = exp(-a2 * (Y .^ 2) / 2);
0506       gauss = Y .* ex;
0507       Beta = sum(Y .* gauss);
0508       D = diag(1 ./ (Beta - sum((1 - a2 * (Y .^ 2)) .* ex)));
0509       B = B + myy * B * (Y' * gauss - diag(Beta)) * D;
0510      <span class="keyword">case</span> 32
0511       Xsub=X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0512       U = Xsub' * B;
0513       Usquared=U .^ 2;
0514       ex = exp(-a2 * Usquared / 2);
0515       gauss =  U .* ex;
0516       dGauss = (1 - a2 * Usquared) .*ex;
0517       B = Xsub * gauss / size(Xsub,2) - <span class="keyword">...</span>
0518       ones(size(B,1),1) * sum(dGauss)<span class="keyword">...</span>
0519       .* B / size(Xsub,2) ;
0520      <span class="keyword">case</span> 33
0521       <span class="comment">% Optimoitu</span>
0522       Y = X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize))' * B;
0523       ex = exp(-a2 * (Y .^ 2) / 2);
0524       gauss = Y .* ex;
0525       Beta = sum(Y .* gauss);
0526       D = diag(1 ./ (Beta - sum((1 - a2 * (Y .^ 2)) .* ex)));
0527       B = B + myy * B * (Y' * gauss - diag(Beta)) * D;
0528       
0529       <span class="comment">% skew</span>
0530      <span class="keyword">case</span> 40
0531       B = (X * ((X' * B) .^ 2)) / numSamples;
0532      <span class="keyword">case</span> 41
0533       <span class="comment">% Optimoitu</span>
0534       Y = X' * B;
0535       Gskew = Y .^ 2;
0536       Beta = sum(Y .* Gskew);
0537       D = diag(1 ./ (Beta));
0538       B = B + myy * B * (Y' * Gskew - diag(Beta)) * D;
0539      <span class="keyword">case</span> 42
0540       Xsub=X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0541       B = (Xsub * ((Xsub' * B) .^ 2)) / size(Xsub,2);
0542      <span class="keyword">case</span> 43
0543       <span class="comment">% Uusi optimoitu</span>
0544       Y = X(:, <a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize))' * B;
0545       Gskew = Y .^ 2;
0546       Beta = sum(Y .* Gskew);
0547       D = diag(1 ./ (Beta));
0548       B = B + myy * B * (Y' * Gskew - diag(Beta)) * D;
0549 
0550      <span class="keyword">otherwise</span>
0551       error(<span class="string">'Code for desired nonlinearity not found!'</span>);
0552     <span class="keyword">end</span>
0553   <span class="keyword">end</span>
0554 
0555   
0556   <span class="comment">% Calculate ICA filters.</span>
0557   W = B' * whiteningMatrix;
0558   
0559   <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0560   <span class="comment">% Also plot the last one...</span>
0561   <span class="keyword">switch</span> usedDisplay
0562    <span class="keyword">case</span> 1 
0563     <span class="comment">% There was and may still be other displaymodes...</span>
0564     <span class="comment">% 1D signals</span>
0565     <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,(X'*B)');
0566     drawnow;
0567    <span class="keyword">case</span> 2
0568     <span class="comment">% ... and now there are :-)</span>
0569     <span class="comment">% 1D basis</span>
0570     <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,A');
0571     drawnow;
0572    <span class="keyword">case</span> 3
0573     <span class="comment">% ... and now there are :-)</span>
0574     <span class="comment">% 1D filters</span>
0575     <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,W);
0576     drawnow;
0577    <span class="keyword">otherwise</span>
0578   <span class="keyword">end</span>
0579 <span class="keyword">end</span>
0580 
0581 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0582 <span class="comment">% DEFLATION APPROACH</span>
0583 <span class="keyword">if</span> approachMode == 2
0584   
0585   B = zeros(vectorSize);
0586   
0587   <span class="comment">% The search for a basis vector is repeated numOfIC times.</span>
0588   round = 1;
0589   
0590   numFailures = 0;
0591   
0592   <span class="keyword">while</span> round &lt;= numOfIC,
0593     myy = myyOrig;
0594     usedNlinearity = gOrig;
0595     stroke = 0;
0596     notFine = 1;
0597     long = 0;
0598     endFinetuning = 0;
0599     
0600     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0601     <span class="comment">% Show the progress...</span>
0602     <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'IC %d '</span>, round); <span class="keyword">end</span>
0603     
0604     <span class="comment">% Take a random initial vector of lenght 1 and orthogonalize it</span>
0605     <span class="comment">% with respect to the other vectors.</span>
0606     <span class="keyword">if</span> initialStateMode == 0
0607       w = randn (vectorSize, 1);
0608     <span class="keyword">elseif</span> initialStateMode == 1
0609       w=whiteningMatrix*guess(:,round);
0610     <span class="keyword">end</span>
0611     w = w - B * B' * w;
0612     w = w / norm(w);
0613     
0614     wOld = zeros(size(w));
0615     wOld2 = zeros(size(w));
0616     
0617     <span class="comment">% This is the actual fixed-point iteration loop.</span>
0618     <span class="comment">%    for i = 1 : maxNumIterations + 1</span>
0619     i = 1;
0620     gabba = 1;
0621     <span class="keyword">while</span> i &lt;= maxNumIterations + gabba
0622       <span class="keyword">if</span> (usedDisplay &gt; 0)
0623     drawnow;
0624       <span class="keyword">end</span>
0625       <span class="keyword">if</span> (interruptible &amp; g_FastICA_interrupt)
0626         <span class="keyword">if</span> b_verbose 
0627           fprintf(<span class="string">'\n\nCalculation interrupted by the user\n'</span>);
0628         <span class="keyword">end</span>
0629         <span class="keyword">return</span>;
0630       <span class="keyword">end</span>
0631       
0632       <span class="comment">% Project the vector into the space orthogonal to the space</span>
0633       <span class="comment">% spanned by the earlier found basis vectors. Note that we can do</span>
0634       <span class="comment">% the projection with matrix B, since the zero entries do not</span>
0635       <span class="comment">% contribute to the projection.</span>
0636       w = w - B * B' * w;
0637       w = w / norm(w);
0638       
0639       <span class="keyword">if</span> notFine
0640     <span class="keyword">if</span> i == maxNumIterations + 1
0641       <span class="keyword">if</span> b_verbose
0642         fprintf(<span class="string">'\nComponent number %d did not converge in %d iterations.\n'</span>, round, maxNumIterations);
0643       <span class="keyword">end</span>
0644       round = round - 1;
0645       numFailures = numFailures + 1;
0646       <span class="keyword">if</span> numFailures &gt; failureLimit
0647         <span class="keyword">if</span> b_verbose
0648           fprintf(<span class="string">'Too many failures to converge (%d). Giving up.\n'</span>, numFailures);
0649         <span class="keyword">end</span>
0650         <span class="keyword">if</span> round == 0
0651           A=[];
0652           W=[];
0653         <span class="keyword">end</span>
0654         <span class="keyword">return</span>;
0655       <span class="keyword">end</span>
0656       <span class="comment">% numFailures &gt; failurelimit</span>
0657       <span class="keyword">break</span>;
0658     <span class="keyword">end</span>
0659     <span class="comment">% i == maxNumIterations + 1</span>
0660       <span class="keyword">else</span>
0661     <span class="comment">% if notFine</span>
0662     <span class="keyword">if</span> i &gt;= endFinetuning
0663       wOld = w; <span class="comment">% So the algorithm will stop on the next test...</span>
0664     <span class="keyword">end</span>
0665       <span class="keyword">end</span>
0666       <span class="comment">% if notFine</span>
0667       
0668       <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0669       <span class="comment">% Show the progress...</span>
0670       <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'.'</span>); <span class="keyword">end</span>;
0671       
0672       
0673       <span class="comment">% Test for termination condition. Note that the algorithm has</span>
0674       <span class="comment">% converged if the direction of w and wOld is the same, this</span>
0675       <span class="comment">% is why we test the two cases.</span>
0676       <span class="keyword">if</span> norm(w - wOld) &lt; epsilon | norm(w + wOld) &lt; epsilon
0677         <span class="keyword">if</span> finetuningEnabled &amp; notFine
0678           <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Initial convergence, fine-tuning: '</span>); <span class="keyword">end</span>;
0679           notFine = 0;
0680       gabba = maxFinetune;
0681           wOld = zeros(size(w));
0682           wOld2 = zeros(size(w));
0683           usedNlinearity = gFine;
0684           myy = myyK * myyOrig;
0685       
0686       endFinetuning = maxFinetune + i;
0687       
0688         <span class="keyword">else</span>
0689           numFailures = 0;
0690           <span class="comment">% Save the vector</span>
0691           B(:, round) = w;
0692       
0693           <span class="comment">% Calculate the de-whitened vector.</span>
0694           A(:,round) = dewhiteningMatrix * w;
0695           <span class="comment">% Calculate ICA filter.</span>
0696           W(round,:) = w' * whiteningMatrix;
0697       
0698           <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0699           <span class="comment">% Show the progress...</span>
0700           <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'computed ( %d steps ) \n'</span>, i); <span class="keyword">end</span>
0701       
0702           <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0703           <span class="comment">% Also plot the current state...</span>
0704           <span class="keyword">switch</span> usedDisplay
0705        <span class="keyword">case</span> 1
0706         <span class="keyword">if</span> rem(round, displayInterval) == 0,
0707           <span class="comment">% There was and may still be other displaymodes...</span>
0708           <span class="comment">% 1D signals</span>
0709           temp = X'*B;
0710           <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,temp(:,1:numOfIC)');
0711           drawnow;
0712         <span class="keyword">end</span>
0713        <span class="keyword">case</span> 2
0714         <span class="keyword">if</span> rem(round, displayInterval) == 0,
0715           <span class="comment">% ... and now there are :-)</span>
0716           <span class="comment">% 1D basis</span>
0717           <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,A');
0718           drawnow;
0719         <span class="keyword">end</span>
0720        <span class="keyword">case</span> 3
0721         <span class="keyword">if</span> rem(round, displayInterval) == 0,
0722           <span class="comment">% ... and now there are :-)</span>
0723           <span class="comment">% 1D filters</span>
0724           <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,W);
0725           drawnow;
0726         <span class="keyword">end</span>
0727           <span class="keyword">end</span>
0728       <span class="comment">% switch usedDisplay</span>
0729       <span class="keyword">break</span>; <span class="comment">% IC ready - next...</span>
0730         <span class="keyword">end</span>
0731     <span class="comment">%if finetuningEnabled &amp; notFine</span>
0732       <span class="keyword">elseif</span> stabilizationEnabled
0733     <span class="keyword">if</span> (~stroke) &amp; (norm(w - wOld2) &lt; epsilon | norm(w + wOld2) &lt; <span class="keyword">...</span>
0734             epsilon)
0735       stroke = myy;
0736       <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Stroke!'</span>); <span class="keyword">end</span>;
0737       myy = .5*myy;
0738       <span class="keyword">if</span> mod(usedNlinearity,2) == 0
0739         usedNlinearity = usedNlinearity + 1;
0740       <span class="keyword">end</span>
0741     <span class="keyword">elseif</span> stroke
0742       myy = stroke;
0743       stroke = 0;
0744       <span class="keyword">if</span> (myy == 1) &amp; (mod(usedNlinearity,2) ~= 0)
0745         usedNlinearity = usedNlinearity - 1;
0746       <span class="keyword">end</span>
0747     <span class="keyword">elseif</span> (notFine) &amp; (~long) &amp; (i &gt; maxNumIterations / 2)
0748       <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Taking long (reducing step size) '</span>); <span class="keyword">end</span>;
0749       long = 1;
0750       myy = .5*myy;
0751       <span class="keyword">if</span> mod(usedNlinearity,2) == 0
0752         usedNlinearity = usedNlinearity + 1;
0753       <span class="keyword">end</span>
0754     <span class="keyword">end</span>
0755       <span class="keyword">end</span>
0756       
0757       wOld2 = wOld;
0758       wOld = w;
0759       
0760       <span class="keyword">switch</span> usedNlinearity
0761     <span class="comment">% pow3</span>
0762        <span class="keyword">case</span> 10
0763     w = (X * ((X' * w) .^ 3)) / numSamples - 3 * w;
0764        <span class="keyword">case</span> 11
0765     EXGpow3 = (X * ((X' * w) .^ 3)) / numSamples;
0766     Beta = w' * EXGpow3;
0767     w = w - myy * (EXGpow3 - Beta * w) / (3 - Beta);
0768        <span class="keyword">case</span> 12
0769     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0770     w = (Xsub * ((Xsub' * w) .^ 3)) / size(Xsub, 2) - 3 * w;
0771        <span class="keyword">case</span> 13
0772     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0773     EXGpow3 = (Xsub * ((Xsub' * w) .^ 3)) / size(Xsub, 2);
0774     Beta = w' * EXGpow3;
0775     w = w - myy * (EXGpow3 - Beta * w) / (3 - Beta);
0776     <span class="comment">% tanh</span>
0777        <span class="keyword">case</span> 20
0778     hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * X' * w);
0779     w = (X * hypTan - a1 * sum(1 - hypTan .^ 2)' * w) / numSamples;
0780        <span class="keyword">case</span> 21
0781     hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * X' * w);
0782     Beta = w' * X * hypTan;
0783     w = w - myy * ((X * hypTan - Beta * w) / <span class="keyword">...</span>
0784                (a1 * sum((1-hypTan .^2)') - Beta));
0785        <span class="keyword">case</span> 22
0786     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0787     hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * Xsub' * w);
0788     w = (Xsub * hypTan - a1 * sum(1 - hypTan .^ 2)' * w) / size(Xsub, 2);
0789        <span class="keyword">case</span> 23
0790     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0791     hypTan = <a href="#_sub1" class="code" title="subfunction y=tanh(x)">tanh</a>(a1 * Xsub' * w);
0792     Beta = w' * Xsub * hypTan;
0793     w = w - myy * ((Xsub * hypTan - Beta * w) / <span class="keyword">...</span>
0794                (a1 * sum((1-hypTan .^2)') - Beta));
0795     <span class="comment">% gauss</span>
0796        <span class="keyword">case</span> 30
0797     <span class="comment">% This has been split for performance reasons.</span>
0798     u = X' * w;
0799     u2=u.^2;
0800     ex=exp(-a2 * u2/2);
0801     gauss =  u.*ex;
0802     dGauss = (1 - a2 * u2) .*ex;
0803     w = (X * gauss - sum(dGauss)' * w) / numSamples;
0804        <span class="keyword">case</span> 31
0805     u = X' * w;
0806     u2=u.^2;
0807     ex=exp(-a2 * u2/2);
0808     gauss =  u.*ex;
0809     dGauss = (1 - a2 * u2) .*ex;
0810     Beta = w' * X * gauss;
0811     w = w - myy * ((X * gauss - Beta * w) / <span class="keyword">...</span>
0812                (sum(dGauss)' - Beta));
0813        <span class="keyword">case</span> 32
0814     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0815     u = Xsub' * w;
0816     u2=u.^2;
0817     ex=exp(-a2 * u2/2);
0818     gauss =  u.*ex;
0819     dGauss = (1 - a2 * u2) .*ex;
0820     w = (Xsub * gauss - sum(dGauss)' * w) / size(Xsub, 2);
0821        <span class="keyword">case</span> 33
0822     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0823     u = Xsub' * w;
0824     u2=u.^2;
0825     ex=exp(-a2 * u2/2);
0826     gauss =  u.*ex;
0827     dGauss = (1 - a2 * u2) .*ex;
0828     Beta = w' * Xsub * gauss;
0829     w = w - myy * ((Xsub * gauss - Beta * w) / <span class="keyword">...</span>
0830                (sum(dGauss)' - Beta));
0831     <span class="comment">% skew</span>
0832        <span class="keyword">case</span> 40
0833     w = (X * ((X' * w) .^ 2)) / numSamples;
0834        <span class="keyword">case</span> 41
0835     EXGskew = (X * ((X' * w) .^ 2)) / numSamples;
0836     Beta = w' * EXGskew;
0837     w = w - myy * (EXGskew - Beta*w)/(-Beta);
0838        <span class="keyword">case</span> 42
0839     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0840     w = (Xsub * ((Xsub' * w) .^ 2)) / size(Xsub, 2);
0841        <span class="keyword">case</span> 43
0842     Xsub=X(:,<a href="#_sub2" class="code" title="subfunction Samples = getSamples(max, percentage)">getSamples</a>(numSamples, sampleSize));
0843     EXGskew = (Xsub * ((Xsub' * w) .^ 2)) / size(Xsub, 2);
0844     Beta = w' * EXGskew;
0845     w = w - myy * (EXGskew - Beta*w)/(-Beta);
0846     
0847        <span class="keyword">otherwise</span>
0848     error(<span class="string">'Code for desired nonlinearity not found!'</span>);
0849       <span class="keyword">end</span>
0850       
0851       <span class="comment">% Normalize the new w.</span>
0852       w = w / norm(w);
0853       i = i + 1;
0854     <span class="keyword">end</span>
0855     round = round + 1;
0856   <span class="keyword">end</span>
0857   <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Done.\n'</span>); <span class="keyword">end</span>
0858   
0859   <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0860   <span class="comment">% Also plot the ones that may not have been plotted.</span>
0861   <span class="keyword">if</span> (usedDisplay &gt; 0) &amp; (rem(round-1, displayInterval) ~= 0)
0862     <span class="keyword">switch</span> usedDisplay
0863      <span class="keyword">case</span> 1
0864       <span class="comment">% There was and may still be other displaymodes...</span>
0865       <span class="comment">% 1D signals</span>
0866       temp = X'*B;
0867       <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,temp(:,1:numOfIC)');
0868       drawnow;
0869      <span class="keyword">case</span> 2
0870       <span class="comment">% ... and now there are :-)</span>
0871       <span class="comment">% 1D basis</span>
0872       <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,A');
0873       drawnow;
0874      <span class="keyword">case</span> 3
0875       <span class="comment">% ... and now there are :-)</span>
0876       <span class="comment">% 1D filters</span>
0877       <a href="icaplot.html" class="code" title="function icaplot(mode, varargin);">icaplot</a>(<span class="string">'dispsig'</span>,W);
0878       drawnow;
0879      <span class="keyword">otherwise</span>
0880     <span class="keyword">end</span>
0881   <span class="keyword">end</span>
0882 <span class="keyword">end</span>
0883 
0884 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0885 <span class="comment">% In the end let's check the data for some security</span>
0886 <span class="keyword">if</span> ~isreal(A)
0887   <span class="keyword">if</span> b_verbose, fprintf(<span class="string">'Warning: removing the imaginary part from the result.\n'</span>); <span class="keyword">end</span>
0888   A = real(A);
0889   W = real(W);
0890 <span class="keyword">end</span>
0891 
0892 
0893 
0894 
0895 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0896 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0897 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0898 <span class="comment">% Subfunction</span>
0899 <span class="comment">% Calculates tanh simplier and faster than Matlab tanh.</span>
0900 <a name="_sub1" href="#_subfunctions" class="code">function y=tanh(x)</a>
0901 y = 1 - 2 ./ (exp(2 * x) + 1);
0902 
0903 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0904 <a name="_sub2" href="#_subfunctions" class="code">function Samples = getSamples(max, percentage)</a>
0905 Samples = find(rand(1, max) &lt; percentage);</pre></div>
<hr><address>Generated on Tue 18-Feb-2014 14:57:44 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>