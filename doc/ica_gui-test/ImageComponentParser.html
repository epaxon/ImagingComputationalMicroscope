<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ImageComponentParser</title>
  <meta name="keywords" content="ImageComponentParser">
  <meta name="description" content="class ImageComponentParser: gui to analyze the component ...">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">ica_gui-test</a> &gt; ImageComponentParser.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ica_gui-test&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ImageComponentParser
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>class ImageComponentParser: gui to analyze the component ...</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>classdef ImageComponentParser < hgsetget </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> class ImageComponentParser: gui to analyze the component ...
 decompositions of imaging data.

 @file: ImageComponentParser.m
 @author: Paxon Frady
 @created: 8/20/2013

 Copyright (C) 2013 E. Paxon Frady

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="FigureEventNotifier.html" class="code" title="classdef FigureEventNotifier < handle">FigureEventNotifier</a>	class FigureEventNotifier: sends out event notifications during</li><li><a href="RoiEditor.html" class="code" title="classdef RoiEditor < hgsetget">RoiEditor</a>	class RoiEditor: interactive gui to edit rois for image processing</li><li><a href="align_im_stack.html" class="code" title="function [im_stack, warp] = align_im_stack(im, n_iters, n_levels, transform, viz)">align_im_stack</a>	im_stack = align_im_stack(im): Aligns an image stack using image</li><li><a href="calc_rois_from_components.html" class="code" title="function rois = calc_rois_from_components(comp, x, y)">calc_rois_from_components</a>	rois = calc_rois_from_components(comp): Estimates ROI positions from the</li><li><a href="make_feature_matrix.html" class="code" title="function [feature_matrix, feature_weights] = make_feature_matrix(ics, im_data)">make_feature_matrix</a>	[feature_matrix, feature_weights] = make_feature_matrix(icp): creates a</li><li><a href="mean_roi.html" class="code" title="function data = mean_roi(ccd_movie, roi_data, im_x, im_y)">mean_roi</a>	This function uses the roi_data and takes the mean value for the pixels</li><li><a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>	nmat = norm_range(mat) returns a normalized matrix such that the values</li><li><a href="segment_ics.html" class="code" title="function [segment_masks, segment_info] = segment_ics(comp, thresh, down_size, min_area)">segment_ics</a>	[segment_mask, segment_info] = segment_ics(comp): Segments ics into</li><li><a href="tifread.html" class="code" title="function image = tifread(filename)">tifread</a>	image = tifread(filename): reads a tif image stack from a file.</li><li><a href="viz_function.html" class="code" title="function colors = viz_function(icp)">viz_function</a>	colors = viz_function(icp): takes an icp (or just the components?) and</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="icp_basics.html" class="code" title="">icp_basics</a>	A quick overview of ICP and the data</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function self = ImageComponentParser(parent, im_data)</a></li><li><a href="#_sub2" class="code">function self = init_state(self)</a></li><li><a href="#_sub3" class="code">function self = init_gui(self, parent)</a></li><li><a href="#_sub4" class="code">function self = uiextras_layout(self)</a></li><li><a href="#_sub5" class="code">function window_key_press_cb(self, source_h, eventdata)</a></li><li><a href="#_sub6" class="code">function reset_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub7" class="code">function motion_correct_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub8" class="code">function preprocess_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub9" class="code">function wavelets_check_cb(self, source_h, eventdata)</a></li><li><a href="#_sub10" class="code">function runpca_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub11" class="code">function runica_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub12" class="code">function segment_ics_cb(self, source_h, eventdata)</a></li><li><a href="#_sub13" class="code">function viz_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub14" class="code">function estimate_clusters_cb(self, source_h, eventdata)</a></li><li><a href="#_sub15" class="code">function set_cluster_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub16" class="code">function uncluster_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub17" class="code">function stage_tab_panel_cb(self, source_h, eventdata)</a></li><li><a href="#_sub18" class="code">function x_popup_cb(self, sh, ed)</a></li><li><a href="#_sub19" class="code">function y_popup_cb(self, sh, ed)</a></li><li><a href="#_sub20" class="code">function z_popup_cb(self, sh, ed)</a></li><li><a href="#_sub21" class="code">function xy_button_cb(self, sh, ed)</a></li><li><a href="#_sub22" class="code">function yz_button_cb(self, sh, ed)</a></li><li><a href="#_sub23" class="code">function zx_button_cb(self, sh, ed)</a></li><li><a href="#_sub24" class="code">function rotate_toggle_cb(self, sh, ed)</a></li><li><a href="#_sub25" class="code">function rotate_timer_cb(self, sh, ed)</a></li><li><a href="#_sub26" class="code">function re_selection_changed_cb(self, source_h, eventdata)</a></li><li><a href="#_sub27" class="code">function re_new_rois_cb(self, source_h, eventdata)</a></li><li><a href="#_sub28" class="code">function re_altered_rois_cb(self, source_h, eventdata)</a></li><li><a href="#_sub29" class="code">function re_deleted_rois_cb(self, source_h, eventdata)</a></li><li><a href="#_sub30" class="code">function re_frame_changed_cb(self, source_h, eventdata)</a></li><li><a href="#_sub31" class="code">function re_levels_changed_cb(self, source_h, eventdata)</a></li><li><a href="#_sub32" class="code">function load_settings_cb(self, source_h, eventdata)</a></li><li><a href="#_sub33" class="code">function save_settings_cb(self, source_h, eventdata)</a></li><li><a href="#_sub34" class="code">function edit_preprocessing_cb(self, source_h, eventdata)</a></li><li><a href="#_sub35" class="code">function edit_pca_cb(self, source_h, eventdata)</a></li><li><a href="#_sub36" class="code">function edit_ica_cb(self, source_h, eventdata)</a></li><li><a href="#_sub37" class="code">function pp_settings_ok_cb(self, source_h, eventdata)</a></li><li><a href="#_sub38" class="code">function pp_settings_cancel_cb(self, source_h, eventdata)</a></li><li><a href="#_sub39" class="code">function lock_component_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub40" class="code">function clear_locked_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub41" class="code">function component_label_cb(self, source_h, eventdata)</a></li><li><a href="#_sub42" class="code">function trial_listbox_cb(self, source_h, eventdata)</a></li><li><a href="#_sub43" class="code">function add_trial_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub44" class="code">function delete_trial_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub45" class="code">function roi_listbox_cb(self, source_h, eventdata)</a></li><li><a href="#_sub46" class="code">function add_rois_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub47" class="code">function delete_rois_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub48" class="code">function calc_rois_cb(self, source_h, eventdata)</a></li><li><a href="#_sub49" class="code">function save_rois_cb(self, source_h, eventdata)</a></li><li><a href="#_sub50" class="code">function load_rois_cb(self, source_h, eventdata)</a></li><li><a href="#_sub51" class="code">function load_image_cb(self, source_h, eventdata)</a></li><li><a href="#_sub52" class="code">function load_session_cb(self, source_h, eventdata)</a></li><li><a href="#_sub53" class="code">function save_session_cb(self, source_h, eventdata)</a></li><li><a href="#_sub54" class="code">function viz_settings_cb(self, source_h, eventdata)</a></li><li><a href="#_sub55" class="code">function concat_trials_toggle_cb(self, source_h, eventdata)</a></li><li><a href="#_sub56" class="code">function which_pcs_edit_cb(self, source_h, eventdata)</a></li><li><a href="#_sub57" class="code">function down_size_slider_cb(self, source_h, eventdata)</a></li><li><a href="#_sub58" class="code">function down_size_indicator_cb(self, source_h, eventdata)</a></li><li><a href="#_sub59" class="code">function thresh_slider_cb(self, source_h, eventdata)</a></li><li><a href="#_sub60" class="code">function thresh_indicator_cb(self, source_h, eventdata)</a></li><li><a href="#_sub61" class="code">function max_corr_thresh_button_cb(self, source_h, eventdata)</a></li><li><a href="#_sub62" class="code">function update(self)</a></li><li><a href="#_sub63" class="code">function warp = run_motion_correction(self)</a></li><li><a href="#_sub64" class="code">function run_filters(self)</a></li><li><a href="#_sub65" class="code">function run_preprocessing(self)</a></li><li><a href="#_sub66" class="code">function run_pca(self)</a></li><li><a href="#_sub67" class="code">function run_ica(self)</a></li><li><a href="#_sub68" class="code">function run_segmentation(self)</a></li><li><a href="#_sub69" class="code">function run_visualization(self)</a></li><li><a href="#_sub70" class="code">function set_viz_colors(self, colors);</a></li><li><a href="#_sub71" class="code">function rois = calc_rois(self)</a></li><li><a href="#_sub72" class="code">function estimate_clusters(self)</a></li><li><a href="#_sub73" class="code">function load_settings(self, filename)</a></li><li><a href="#_sub74" class="code">function save_settings(self, filename)</a></li><li><a href="#_sub75" class="code">function edit_preprocessing_settings(self)</a></li><li><a href="#_sub76" class="code">function set_pp_smooth_window(self, smM, smN, smT)</a></li><li><a href="#_sub77" class="code">function set_pp_down_sample(self, dsM, dsN, dsT)</a></li><li><a href="#_sub78" class="code">function edit_pca_settings(self)</a></li><li><a href="#_sub79" class="code">function edit_ica_settings(self)</a></li><li><a href="#_sub80" class="code">function set.Parent(self, val)</a></li><li><a href="#_sub81" class="code">function component = get_current_component(self)</a></li><li><a href="#_sub82" class="code">function lock_current_component(self)</a></li><li><a href="#_sub83" class="code">function clear_locked_components(self)</a></li><li><a href="#_sub84" class="code">function top_idxs = show_best_selected_components(self, rois)</a></li><li><a href="#_sub85" class="code">function create_new_roi_set(self, name, is_component_set)</a></li><li><a href="#_sub86" class="code">function delete_roi_set(self, idx)</a></li><li><a href="#_sub87" class="code">function select_roi_set(self, idx)</a></li><li><a href="#_sub88" class="code">function set_ica_spatial_guess(self, masks, which_pcs)</a></li><li><a href="#_sub89" class="code">function save_rois(self, filename)</a></li><li><a href="#_sub90" class="code">function load_rois(self, filename)</a></li><li><a href="#_sub91" class="code">function set_cluster(self, ic_idxs)</a></li><li><a href="#_sub92" class="code">function uncluster(self, idxs)</a></li><li><a href="#_sub93" class="code">function clear_clusters(self)</a></li><li><a href="#_sub94" class="code">function load_data(self, filename)</a></li><li><a href="#_sub95" class="code">function set_data(self, im, trial_idx)</a></li><li><a href="#_sub96" class="code">function add_trial(self, im_data)</a></li><li><a href="#_sub97" class="code">function delete_trial(self, idx)</a></li><li><a href="#_sub98" class="code">function align_trials(self)</a></li><li><a href="#_sub99" class="code">function set_selected_trial(self, idx)</a></li><li><a href="#_sub100" class="code">function set_use_wavelets(self, val)</a></li><li><a href="#_sub101" class="code">function reset(self)</a></li><li><a href="#_sub102" class="code">function load_session(self, filename)</a></li><li><a href="#_sub103" class="code">function save_session(self, filename)</a></li><li><a href="#_sub104" class="code">function set_which_pcs(self, which_pcs, trial)</a></li><li><a href="#_sub105" class="code">function set_segment_thresh(self, thresh, trial_idx)</a></li><li><a href="#_sub106" class="code">function set_segment_down_size(self, down_size, trial_idx)</a></li><li><a href="#_sub107" class="code">function default_settings(self)</a></li><li><a href="#_sub108" class="code">function init_data(self, im_data, trial_idx, isdefault)</a></li><li><a href="#_sub109" class="code">function init_gui_display(self, trial_idx)</a></li><li><a href="#_sub110" class="code">function plot_locked_components(self)</a></li><li><a href="#_sub111" class="code">function plot_3d(self)</a></li><li><a href="#_sub112" class="code">function build_3d_gui_components(self, stage)</a></li><li><a href="#_sub113" class="code">function build_roi_listbox(self)</a></li><li><a href="#_sub114" class="code">function build_trial_listbox(self)</a></li><li><a href="#_sub115" class="code">function update_current_roi_set(self)</a></li><li><a href="#_sub116" class="code">function draw_clustered_rois(self)</a></li><li><a href="#_sub117" class="code">function draw_component_viz(self)</a></li></ul>
<h2><a name="_download"></a>DOWNLOAD <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<p><a href="ImageComponentParser.m">ImageComponentParser.m</a></p>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 classdef <a href="#_sub1" class="code" title="subfunction self = ImageComponentParser(parent, im_data)">ImageComponentParser</a> &lt; hgsetget
0002     <span class="comment">% class ImageComponentParser: gui to analyze the component ...</span>
0003     <span class="comment">% decompositions of imaging data.</span>
0004     <span class="comment">%</span>
0005     <span class="comment">% @file: ImageComponentParser.m</span>
0006     <span class="comment">% @author: Paxon Frady</span>
0007     <span class="comment">% @created: 8/20/2013</span>
0008     <span class="comment">%</span>
0009     <span class="comment">% Copyright (C) 2013 E. Paxon Frady</span>
0010     <span class="comment">%</span>
0011     <span class="comment">% This program is free software: you can redistribute it and/or modify</span>
0012     <span class="comment">% it under the terms of the GNU General Public License as published by</span>
0013     <span class="comment">% the Free Software Foundation, either version 3 of the License, or</span>
0014     <span class="comment">% (at your option) any later version.</span>
0015     <span class="comment">%</span>
0016     <span class="comment">% This program is distributed in the hope that it will be useful,</span>
0017     <span class="comment">% but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
0018     <span class="comment">% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
0019     <span class="comment">% GNU General Public License for more details.</span>
0020     <span class="comment">%</span>
0021     <span class="comment">% You should have received a copy of the GNU General Public License</span>
0022     <span class="comment">% along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
0023     
0024     
0025     properties
0026         <span class="comment">% gui properties</span>
0027         h; <span class="comment">% graphic object handles.</span>
0028         gui; <span class="comment">% settings for the gui.</span>
0029         
0030         <span class="comment">% hgsetget properties</span>
0031         Position; <span class="comment">% The size and position of the object</span>
0032         Parent; <span class="comment">% The parent of the object</span>
0033         
0034         <span class="comment">% object properties</span>
0035         data; <span class="comment">% Struct containing all the data for an ICP</span>
0036         
0037         <span class="comment">%im_data; % The original image data</span>
0038         <span class="comment">%rois; % Cell array containing the sets of rois</span>
0039         <span class="comment">%settings; % struct containing settings for each stage.</span>
0040         <span class="comment">%pp;  % struct containing preprocessing data</span>
0041         <span class="comment">%pca; % struct containing pca data</span>
0042         <span class="comment">%ica; % struct containing ica data</span>
0043         <span class="comment">%post; % struct containing postprocessing data</span>
0044         <span class="comment">%viz; % struct containing visualization data</span>
0045         <span class="comment">%cluster; % struct containing clustering data</span>
0046         <span class="comment">%stage; % Keeps track of which stage the analysis is in.</span>
0047     <span class="keyword">end</span>
0048     
0049     properties (Constant)
0050         <span class="comment">% The stage values need to go in increasing order</span>
0051         InitStage = 0;
0052         PreProcessingStage = 1;
0053         PcaStage = 2;
0054         IcaStage = 3;
0055         PostProcessingStage = 4;
0056     <span class="keyword">end</span>
0057     
0058     events
0059         
0060     <span class="keyword">end</span>
0061     
0062     methods
0063         <span class="comment">%%%%%%%%%% Initialization %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0064         <a name="_sub0" href="#_subfunctions" class="code">function self = ImageComponentParser(parent, im_data)</a>
0065             <span class="comment">% self = ImageComponentParser(parent, im_data): parses the</span>
0066             <span class="comment">% components of imaging data.</span>
0067             <span class="comment">%</span>
0068             <span class="comment">% @param: parent the parent handle of the gui object. If no</span>
0069             <span class="comment">% parent is given a new figure will be created and used as the</span>
0070             <span class="comment">% parent.</span>
0071             <span class="comment">% @param: im_data MxNxt matrix of image data. Or cell array of</span>
0072             <span class="comment">% several trials of image data.</span>
0073             <span class="comment">% @return: self handle to the ImageComponentParser instance</span>
0074             <span class="comment">%</span>
0075             
0076             <span class="keyword">if</span> nargin &lt; 1
0077                 parent = [];
0078             <span class="keyword">end</span>
0079             
0080             <span class="keyword">if</span> nargin &lt; 2
0081                 self.init_data([],1,1);
0082             <span class="keyword">else</span>
0083                 self.init_data(im_data);
0084             <span class="keyword">end</span>
0085             
0086             self = self.init_state();
0087             self = self.init_gui(parent);
0088             
0089             self.reset();
0090         <span class="keyword">end</span>
0091         
0092         <a name="_sub1" href="#_subfunctions" class="code">function self = init_state(self)</a>
0093             <span class="comment">% init_state: initializes the gui state variables.</span>
0094             
0095             self.Position = [0 0 1200 850];
0096             
0097             self.gui.current_trial = 1;
0098             
0099             self.gui.MARGIN = 10;
0100             self.gui.CAX_H = 240;
0101             self.gui.BUTTON_H = 30;
0102             self.gui.CONTROL_H = 200;
0103             self.gui.PC_PANEL_ITEM_W = 20;
0104             self.gui.VIZ_SETTINGS_ITEM_W = 40;
0105             self.gui.VIZ_SETTINGS_ITEM_H = 20;
0106             
0107             self.gui.data_norm_frame = 20; <span class="comment">% Data normalized to this frame</span>
0108             
0109             self.gui.rotate_rate = 0.05;
0110             self.gui.rotate_angle_step = 2;
0111             self.gui.rotate_timer = timer(<span class="string">'TimerFcn'</span>, @self.rotate_timer_cb, <span class="keyword">...</span>
0112                 <span class="string">'ExecutionMode'</span>, <span class="string">'fixedRate'</span>, <span class="keyword">...</span>
0113                 <span class="string">'Period'</span>, self.gui.rotate_rate);
0114             
0115             self.gui.locked_components.xdata = [];
0116             self.gui.locked_components.ydata = [];
0117             self.gui.locked_components.handle_ids = [];
0118             self.gui.locked_colors = lines(7);
0119             
0120             self.default_settings();
0121         <span class="keyword">end</span>
0122         
0123         <a name="_sub2" href="#_subfunctions" class="code">function self = init_gui(self, parent)</a>
0124             <span class="comment">% init_gui: initializes the gui objects.</span>
0125             <span class="comment">%</span>
0126             <span class="comment">% @param: parent the parent handle of this object. Default is</span>
0127             <span class="comment">% to create a new figure. Use [] for default.</span>
0128             
0129             <span class="keyword">if</span> nargin &lt; 2 || isempty(parent)
0130                 <span class="comment">% No parent given, then make a new figure as the parent.</span>
0131                 parent = figure();
0132                 clf(parent);
0133                 set(parent, <span class="string">'Position'</span>, [100, 100, self.Position(3), self.Position(4)]);
0134             <span class="keyword">end</span>
0135             
0136             self.h.parent = parent;
0137             
0138             <span class="comment">% We must use a figure event notifier, which is attached to the</span>
0139             <span class="comment">% top-most figure. Go up until we get the figure.</span>
0140             self.h.fh = self.h.parent;
0141             <span class="keyword">while</span> ~strcmp(get(self.h.fh, <span class="string">'Type'</span>), <span class="string">'figure'</span>)
0142                 <span class="comment">% Then the fh object is not a figure, so go up.</span>
0143                 self.h.fh = get(self.h.fh, <span class="string">'Parent'</span>);
0144             <span class="keyword">end</span>
0145             
0146             <span class="comment">% Now fh is the parent figure. Set its event notifier.</span>
0147             self.h.fen = <a href="FigureEventNotifier.html" class="code" title="classdef FigureEventNotifier < handle">FigureEventNotifier</a>(self.h.fh);
0148             addlistener(self.h.fen, <span class="string">'WindowKeyPress'</span>, @self.window_key_press_cb);
0149             set(self.h.fh, <span class="string">'Toolbar'</span>, <span class="string">'figure'</span>);
0150             
0151             <span class="comment">%self.h.panel = uipanel(self.Parent, 'Units', 'pixels');</span>
0152             self.h.panel = uiextras.BoxPanel(<span class="string">'Parent'</span>, self.h.parent, <span class="keyword">...</span>
0153                 <span class="string">'Title'</span>, <span class="string">'Image Component Parser'</span>);
0154             
0155             <span class="comment">% RoiEditor</span>
0156             self.h.roi_editor = <a href="RoiEditor.html" class="code" title="classdef RoiEditor < hgsetget">RoiEditor</a>(self.h.fh, self.data(self.gui.current_trial).im_data);
0157             <span class="comment">%self.h.roi_editor.is_editing_enabled = false;</span>
0158             
0159             addlistener(self.h.roi_editor, <span class="string">'SelectionChanged'</span>, @self.re_selection_changed_cb);
0160             addlistener(self.h.roi_editor, <span class="string">'NewRois'</span>, @self.re_new_rois_cb);
0161             addlistener(self.h.roi_editor, <span class="string">'AlteredRois'</span>, @self.re_altered_rois_cb);
0162             addlistener(self.h.roi_editor, <span class="string">'DeletedRois'</span>, @self.re_deleted_rois_cb);
0163             
0164             <span class="comment">%%% Ok I'm just ignoring trying to do this now. It keeps</span>
0165             <span class="comment">%%% messing up, argh.</span>
0166             <span class="comment">%addlistener(self.h.roi_editor, 'LevelsChanged', @self.re_levels_changed_cb);</span>
0167             <span class="comment">%%%</span>
0168             addlistener(self.h.roi_editor, <span class="string">'FrameChanged'</span>, @self.re_frame_changed_cb);
0169             
0170             <span class="comment">% Roi Management</span>
0171             self.h.roi_listbox = uicontrol(<span class="string">'Style'</span>, <span class="string">'listbox'</span>, <span class="keyword">...</span>
0172                 <span class="string">'String'</span>, self.data(1).roi_names, <span class="string">'Min'</span>, 1, <span class="string">'Max'</span>, 1, <span class="string">'Callback'</span>, @self.roi_listbox_cb);
0173             self.h.add_rois_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0174                 <span class="string">'String'</span>, <span class="string">'+'</span>, <span class="string">'Callback'</span>, @self.add_rois_button_cb);
0175             self.h.delete_rois_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0176                 <span class="string">'String'</span>, <span class="string">'-'</span>, <span class="string">'Callback'</span>, @self.delete_rois_button_cb);
0177             
0178             <span class="comment">% Trial Management</span>
0179             self.h.trial_listbox = uicontrol(<span class="string">'Style'</span>, <span class="string">'listbox'</span>, <span class="keyword">...</span>
0180                 <span class="string">'String'</span>, {<span class="string">'loading...'</span>}, <span class="string">'Min'</span>, 1, <span class="string">'Max'</span>, 1, <span class="string">'Callback'</span>, @self.trial_listbox_cb);
0181             self.h.add_trial_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0182                 <span class="string">'String'</span>, <span class="string">'+'</span>, <span class="string">'Callback'</span>, @self.add_trial_button_cb);
0183             self.h.delete_trial_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0184                 <span class="string">'String'</span>, <span class="string">'-'</span>, <span class="string">'Callback'</span>, @self.delete_trial_button_cb);
0185             
0186             <span class="comment">% Component axes</span>
0187             self.h.component_axes = axes(<span class="string">'Units'</span>, <span class="string">'pixels'</span>);
0188             self.h.lock_component_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
0189                 <span class="string">'String'</span>, <span class="string">'Lock'</span>, <span class="string">'Callback'</span>, @self.lock_component_button_cb);
0190             self.h.clear_locked_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0191                 <span class="string">'String'</span>, <span class="string">'Clear'</span>, <span class="string">'Callback'</span>, @self.clear_locked_button_cb);
0192             
0193             <span class="comment">% Data axes</span>
0194             self.h.data_axes = axes(<span class="string">'Units'</span>, <span class="string">'pixels'</span>);
0195             
0196             self.h.stage_tab_panel = uiextras.TabPanel(<span class="string">'Callback'</span>, @self.stage_tab_panel_cb);
0197             self.h.data_tab = uiextras.Panel(<span class="string">'Parent'</span>, self.h.stage_tab_panel);
0198             self.h.pp_tab = uiextras.Panel(<span class="string">'Parent'</span>, self.h.stage_tab_panel);
0199             self.h.pca_tab = uiextras.Panel(<span class="string">'Parent'</span>, self.h.stage_tab_panel);
0200             self.h.ica_tab = uiextras.Panel(<span class="string">'Parent'</span>, self.h.stage_tab_panel);
0201             self.h.viz_tab = uiextras.Panel(<span class="string">'Parent'</span>, self.h.stage_tab_panel);
0202             self.h.sc_tab = uiextras.Panel(<span class="string">'Parent'</span>, self.h.stage_tab_panel);
0203             self.h.stage_tab_panel.TabNames = {<span class="string">'Data'</span>, <span class="string">'Pre-Processing'</span>, <span class="string">'PCA'</span>, <span class="string">'ICA'</span>, <span class="string">'Visualize'</span>, <span class="string">'Segment'</span>};
0204             self.h.stage_tab_panel.SelectedChild = self.gui.d(1).display;
0205             
0206             self.h.stage_status = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'...'</span>);
0207             
0208             <span class="comment">% Data tab</span>
0209             self.h.reset_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0210                 <span class="string">'String'</span>, <span class="string">'Reset'</span>, <span class="string">'Callback'</span>, @self.reset_button_cb);
0211             
0212             self.h.concat_trials_toggle = uicontrol(<span class="string">'Style'</span>, <span class="string">'togglebutton'</span>, <span class="keyword">...</span>
0213                 <span class="string">'String'</span>, <span class="string">'Concatenate Trials'</span>, <span class="string">'Callback'</span>, @self.concat_trials_toggle_cb);
0214             
0215             <span class="comment">% PP tab</span>
0216             self.h.motion_correct_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
0217                 <span class="string">'String'</span>, <span class="string">'Motion Correct'</span>, <span class="string">'Callback'</span>, @self.motion_correct_button_cb);
0218             self.h.preprocess_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0219                 <span class="string">'String'</span>, <span class="string">'Pre Process'</span>, <span class="string">'Callback'</span>, @self.preprocess_button_cb);
0220             self.h.wavelets_check = uicontrol(<span class="string">'Style'</span>, <span class="string">'checkbox'</span>, <span class="string">'Value'</span>, 0, <span class="keyword">...</span>
0221                 <span class="string">'String'</span>, <span class="string">'Use Wavelets'</span>, <span class="string">'Callback'</span>, @self.wavelets_check_cb);
0222             
0223             <span class="comment">% PCA tab</span>
0224             self.h.runpca_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0225                 <span class="string">'String'</span>, <span class="string">'Run PCA'</span>, <span class="string">'Callback'</span>, @self.runpca_button_cb);
0226             
0227             <span class="comment">% ICA tab</span>
0228             self.h.runica_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0229                 <span class="string">'String'</span>, <span class="string">'Run ICA'</span>, <span class="string">'Callback'</span>, @self.runica_button_cb);
0230             self.h.which_pcs_label = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'PCs:'</span>);
0231             self.h.which_pcs_edit = uicontrol(<span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'Callback'</span>, @self.which_pcs_edit_cb);
0232             self.h.calc_rois_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0233                 <span class="string">'String'</span>, <span class="string">'Calc ROIs'</span>, <span class="string">'Callback'</span>, @self.calc_rois_cb);
0234             
0235             <span class="comment">% Visualization tab</span>
0236             self.h.viz_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0237                 <span class="string">'String'</span>, <span class="string">'Visualize'</span>, <span class="string">'Callback'</span>, @self.viz_button_cb);
0238             
0239             self.h.map_pow_label = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Map^:'</span>);
0240             self.h.map_pow_slider = uicontrol(<span class="string">'Style'</span>, <span class="string">'slider'</span>, <span class="string">'Callback'</span>, @self.viz_settings_cb, <span class="keyword">...</span>
0241                 <span class="string">'Min'</span>, 0, <span class="string">'Max'</span>, 5, <span class="string">'SliderStep'</span>, [0.02, 0.1]);
0242             self.h.map_pow_indicator = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'0'</span>);
0243             self.h.color_pow_label = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Color^:'</span>);
0244             self.h.color_pow_slider = uicontrol(<span class="string">'Style'</span>, <span class="string">'slider'</span>, <span class="string">'Callback'</span>, @self.viz_settings_cb, <span class="keyword">...</span>
0245                 <span class="string">'Min'</span>, 0, <span class="string">'Max'</span>, 5, <span class="string">'SliderStep'</span>, [0.02 0.1]);
0246             self.h.color_pow_indicator = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'0'</span>);
0247             self.h.alpha_label = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Alpha:'</span>);
0248             self.h.alpha_slider = uicontrol(<span class="string">'Style'</span>, <span class="string">'slider'</span>, <span class="string">'Callback'</span>, @self.viz_settings_cb, <span class="keyword">...</span>
0249                 <span class="string">'Min'</span>, 0, <span class="string">'Max'</span>, 1, <span class="string">'SliderStep'</span>, [0.02, 0.1]);
0250             self.h.alpha_indicator = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'0'</span>);
0251             
0252             
0253             <span class="comment">% Segment/Cluster tab</span>
0254             self.h.segment_ics_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0255                 <span class="string">'String'</span>, <span class="string">'Segment ICs'</span>, <span class="string">'Callback'</span>, @self.segment_ics_cb);
0256             self.h.down_size_label = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Down:'</span>);
0257             self.h.down_size_slider = uicontrol(<span class="string">'Style'</span>, <span class="string">'slider'</span>, <span class="string">'Callback'</span>, @self.down_size_slider_cb, <span class="keyword">...</span>
0258                 <span class="string">'Min'</span>, 1, <span class="string">'Max'</span>, 10);
0259             self.h.down_size_indicator = uicontrol(<span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'Callback'</span>, @self.down_size_indicator_cb);
0260             self.h.thresh_label = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Thresh:'</span>);
0261             self.h.thresh_slider = uicontrol(<span class="string">'Style'</span>, <span class="string">'slider'</span>, <span class="string">'Callback'</span>, @self.thresh_slider_cb);
0262             self.h.thresh_indicator = uicontrol(<span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'Callback'</span>, @self.thresh_indicator_cb);
0263             
0264             self.h.max_corr_thresh_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0265                 <span class="string">'String'</span>, <span class="string">'Max Corr Thresh'</span>, <span class="string">'Callback'</span>, @self.max_corr_thresh_button_cb);
0266             
0267             self.h.estimate_clusters_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0268                 <span class="string">'String'</span>, <span class="string">'Estimate Clusters'</span>, <span class="string">'Callback'</span>, @self.estimate_clusters_cb);
0269             self.h.set_cluster_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0270                 <span class="string">'String'</span>, <span class="string">'Set Cluster'</span>, <span class="string">'Callback'</span>, @self.set_cluster_button_cb);
0271             self.h.uncluster_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0272                 <span class="string">'String'</span>, <span class="string">'Uncluster'</span>, <span class="string">'Callback'</span>, @self.uncluster_button_cb);
0273             
0274             
0275             set(self.h.down_size_slider, <span class="string">'Min'</span>, -4, <span class="string">'Max'</span>, 4);
0276             set(self.h.down_size_indicator, <span class="string">'String'</span>, <span class="string">'0'</span>);
0277             set(self.h.thresh_slider, <span class="string">'Min'</span>, 0, <span class="string">'Max'</span>, 1);
0278             set(self.h.thresh_indicator, <span class="string">'String'</span>, <span class="string">'0'</span>);
0279             
0280             <span class="comment">% Axes to display three PCs</span>
0281             self.h.pc3_axes = axes(<span class="string">'Units'</span>, <span class="string">'pixels'</span>);
0282             <span class="comment">% Popups for the plot.</span>
0283             self.h.x_popup = uicontrol(<span class="string">'Style'</span>, <span class="string">'popupmenu'</span>, <span class="keyword">...</span>
0284                 <span class="string">'Units'</span>, <span class="string">'pixels'</span>, <span class="string">'String'</span>, {<span class="string">'None'</span>});
0285             self.h.y_popup = uicontrol(<span class="string">'Style'</span>, <span class="string">'popupmenu'</span>, <span class="keyword">...</span>
0286                 <span class="string">'Units'</span>, <span class="string">'pixels'</span>, <span class="string">'String'</span>, {<span class="string">'None'</span>});
0287             self.h.z_popup = uicontrol(<span class="string">'Style'</span>, <span class="string">'popupmenu'</span>, <span class="keyword">...</span>
0288                 <span class="string">'Units'</span>, <span class="string">'pixels'</span>, <span class="string">'String'</span>, {<span class="string">'None'</span>});
0289             set(self.h.x_popup, <span class="string">'Callback'</span>, @self.x_popup_cb);
0290             set(self.h.y_popup, <span class="string">'Callback'</span>, @self.y_popup_cb);
0291             set(self.h.z_popup, <span class="string">'Callback'</span>, @self.z_popup_cb);
0292             <span class="comment">% Buttons to auto-rotate to the 2-d plots.</span>
0293             self.h.xy_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0294                 <span class="string">'Units'</span>, <span class="string">'pixels'</span>, <span class="string">'String'</span>, <span class="string">'xy'</span>, <span class="string">'Callback'</span>, @self.xy_button_cb);
0295             self.h.yz_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0296                 <span class="string">'Units'</span>, <span class="string">'pixels'</span>, <span class="string">'String'</span>, <span class="string">'yz'</span>, <span class="string">'Callback'</span>, @self.yz_button_cb);
0297             self.h.zx_button = uicontrol(<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="keyword">...</span>
0298                 <span class="string">'Units'</span>, <span class="string">'pixels'</span>, <span class="string">'String'</span>, <span class="string">'xz'</span>, <span class="string">'Callback'</span>, @self.zx_button_cb);
0299             <span class="comment">% Labels for the plot controls. Even though these are labels,</span>
0300             <span class="comment">% strange things were happening when I didn't keep the handles.</span>
0301             self.h.xl = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'X:'</span>);
0302             self.h.yl = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Y:'</span>);
0303             self.h.zl = uicontrol(<span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Z:'</span>);
0304             <span class="comment">% Toggle button to turn continuous rotation on and off.</span>
0305             self.h.rotate_toggle = uicontrol(<span class="string">'Style'</span>, <span class="string">'togglebutton'</span>, <span class="keyword">...</span>
0306                 <span class="string">'Units'</span>, <span class="string">'pixels'</span>, <span class="string">'String'</span>, <span class="string">'Rotate'</span>, <span class="string">'Callback'</span>, @self.rotate_toggle_cb);
0307             
0308             <span class="comment">% Menu</span>
0309             self.h.main_menu = uimenu(self.h.fh, <span class="string">'Label'</span>, <span class="string">'ICP'</span>);
0310             self.h.load_image_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0311                 <span class="string">'Label'</span>, <span class="string">'Load Data'</span>, <span class="string">'Callback'</span>, @self.load_image_cb);
0312             
0313             self.h.load_session_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0314                 <span class="string">'Label'</span>, <span class="string">'Load Session'</span>, <span class="string">'Callback'</span>, @self.load_session_cb, <span class="keyword">...</span>
0315                 <span class="string">'Separator'</span>, <span class="string">'on'</span>);
0316             self.h.save_session_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0317                 <span class="string">'Label'</span>, <span class="string">'Save Session'</span>, <span class="string">'Callback'</span>, @self.save_session_cb);
0318             
0319             self.h.load_settings_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0320                 <span class="string">'Label'</span>, <span class="string">'Load Settings'</span>, <span class="string">'Callback'</span>, @self.load_settings_cb);
0321             set(self.h.load_settings_item, <span class="string">'Separator'</span>, <span class="string">'on'</span>);
0322             self.h.save_settings_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0323                 <span class="string">'Label'</span>, <span class="string">'Save Settings'</span>, <span class="string">'Callback'</span>, @self.save_settings_cb);
0324             self.h.edit_settings_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0325                 <span class="string">'Label'</span>, <span class="string">'Edit Settings'</span>);
0326             self.h.edit_preprocessing_item = uimenu(<span class="string">'Parent'</span>, self.h.edit_settings_item, <span class="keyword">...</span>
0327                 <span class="string">'Label'</span>, <span class="string">'Preprocessing'</span>, <span class="string">'Callback'</span>, @self.edit_preprocessing_cb);
0328             self.h.edit_pca_item = uimenu(<span class="string">'Parent'</span>, self.h.edit_settings_item, <span class="keyword">...</span>
0329                 <span class="string">'Label'</span>, <span class="string">'PCA'</span>, <span class="string">'Callback'</span>, @self.edit_pca_cb);
0330             self.h.edit_ica_item = uimenu(<span class="string">'Parent'</span>, self.h.edit_settings_item, <span class="keyword">...</span>
0331                 <span class="string">'Label'</span>, <span class="string">'ICA'</span>, <span class="string">'Callback'</span>, @self.edit_ica_cb);
0332             
0333             self.h.load_rois_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0334                 <span class="string">'Label'</span>, <span class="string">'Load ROIs'</span>, <span class="string">'Callback'</span>, @self.load_rois_cb,<span class="keyword">...</span>
0335                 <span class="string">'Separator'</span>, <span class="string">'on'</span>);
0336             self.h.save_rois_item = uimenu(<span class="string">'Parent'</span>, self.h.main_menu, <span class="keyword">...</span>
0337                 <span class="string">'Label'</span>, <span class="string">'Save ROIs'</span>, <span class="string">'Callback'</span>, @self.save_rois_cb);
0338             
0339             
0340             <span class="comment">%self = self.reset_layout();</span>
0341             self = self.uiextras_layout();
0342         <span class="keyword">end</span>
0343         
0344         <a name="_sub3" href="#_subfunctions" class="code">function self = uiextras_layout(self)</a>
0345             <span class="comment">% uiextras_layout: Sets the layout of all of the gui components.</span>
0346             
0347             <span class="comment">% Ok, I'm going to do this with the layouts, and reset the</span>
0348             <span class="comment">% parents here.</span>
0349             disp(<span class="string">'uiextras_layout'</span>);
0350             <span class="comment">% 3D plot Layout elements</span>
0351             self.h.pc3_main_panel = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'3D Plot'</span>);
0352             self.h.pc3_main_hbox = uiextras.HBox();
0353             self.h.pc3_control_rotate_vbox = uiextras.VBox();
0354             self.h.pc3_control_panel = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'3D Plot Controls'</span>);
0355             self.h.pc3_control_grid = uiextras.Grid();
0356             
0357             <span class="comment">% Component axes elements</span>
0358             self.h.component_panel = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'Component Plot'</span>);
0359             self.h.component_lock_vbox = uiextras.VBox();
0360             self.h.lock_button_hbox = uiextras.HButtonBox();
0361             self.h.component_pc3_vbox = uiextras.VBoxFlex();
0362             
0363             <span class="comment">% Data axes elements</span>
0364             self.h.data_panel = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'Data Plot'</span>);
0365             
0366             <span class="comment">% Stage elements</span>
0367             <span class="comment">%self.h.stage_button_hbox = uiextras.HButtonBox();</span>
0368             self.h.editor_button_vbox = uiextras.VBox();
0369             
0370             self.h.roi_stage_hbox = uiextras.HBox();
0371             self.h.roi_control_vbox = uiextras.VBox();
0372             self.h.roi_button_hbox = uiextras.HButtonBox();
0373             self.h.trial_control_vbox = uiextras.VBox();
0374             self.h.trial_button_hbox = uiextras.HButtonBox();
0375             
0376             <span class="comment">% Tab layout elements</span>
0377             self.h.pp_button_hbox = uiextras.HButtonBox();
0378             self.h.pca_button_hbox = uiextras.HButtonBox();
0379             self.h.ica_main_hbox = uiextras.HBox();
0380             self.h.ica_settings_panel = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'ICA Settings'</span>);
0381             self.h.ica_settings_vbox = uiextras.VButtonBox(<span class="string">'ButtonSize'</span>, [150 40]);
0382             self.h.ica_which_pcs_hbox = uiextras.HBox(<span class="string">'Padding'</span>, 10, <span class="string">'Spacing'</span>, 5);
0383             self.h.ica_button_vbox = uiextras.VButtonBox();
0384             self.h.viz_main_hbox = uiextras.HBox();
0385             self.h.viz_button_hbox = uiextras.HButtonBox();
0386             self.h.viz_settings_box = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'Visualization Settings'</span>);
0387             self.h.viz_settings_grid = uiextras.Grid(<span class="string">'Padding'</span>, 10, <span class="string">'Spacing'</span>, 5);
0388             self.h.sc_main_hbox = uiextras.HBox();
0389             self.h.sc_segment_panel = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'Segmentation'</span>);
0390             self.h.sc_segment_vbox = uiextras.VBox();
0391             self.h.sc_segment_grid = uiextras.Grid(<span class="string">'Padding'</span>, 10, <span class="string">'Spacing'</span>, 5);
0392             self.h.sc_segment_button_hbox = uiextras.HButtonBox();
0393             <span class="comment">%self.h.sc_down_size_hbox = uiextras.HBox('Padding', 10, 'Spacing', 5);</span>
0394             <span class="comment">%self.h.sc_thresh_hbox = uiextras.HBox('Padding', 10, 'Spacing', 5);</span>
0395             self.h.sc_cluster_panel = uiextras.BoxPanel(<span class="string">'Title'</span>, <span class="string">'Cluster'</span>);
0396             self.h.sc_cluster_vbox = uiextras.VButtonBox();
0397             
0398             self.h.data_button_hbox = uiextras.HButtonBox();
0399             
0400             self.h.main_hbox = uiextras.HBoxFlex();
0401             
0402             <span class="comment">% Top-level hierarchy</span>
0403             set(self.h.main_hbox, <span class="string">'Parent'</span>, self.h.panel);
0404             set(self.h.editor_button_vbox, <span class="string">'Parent'</span>, self.h.main_hbox);
0405             set(self.h.component_pc3_vbox, <span class="string">'Parent'</span>, self.h.main_hbox);
0406             
0407             <span class="comment">% Button, ROI Editor hierarchy</span>
0408             set(self.h.roi_editor, <span class="string">'Parent'</span>, self.h.editor_button_vbox);
0409             set(self.h.roi_stage_hbox, <span class="string">'Parent'</span>, self.h.editor_button_vbox);
0410             set(self.h.stage_status, <span class="string">'Parent'</span>, self.h.editor_button_vbox.double());
0411             
0412             set(self.h.trial_control_vbox, <span class="string">'Parent'</span>, self.h.roi_stage_hbox);
0413             set(self.h.roi_control_vbox, <span class="string">'Parent'</span>, self.h.roi_stage_hbox);
0414             set(self.h.stage_tab_panel, <span class="string">'Parent'</span>, self.h.roi_stage_hbox);
0415             
0416             <span class="comment">% Trial list and buttons</span>
0417             set(self.h.trial_listbox, <span class="string">'Parent'</span>, self.h.trial_control_vbox.double());
0418             set(self.h.trial_button_hbox, <span class="string">'Parent'</span>, self.h.trial_control_vbox.double());
0419             set(self.h.add_trial_button, <span class="string">'Parent'</span>, self.h.trial_button_hbox.double());
0420             set(self.h.delete_trial_button, <span class="string">'Parent'</span>, self.h.trial_button_hbox.double());
0421             
0422             <span class="comment">% Roi list and buttons</span>
0423             set(self.h.roi_listbox, <span class="string">'Parent'</span>, self.h.roi_control_vbox.double());
0424             set(self.h.roi_button_hbox, <span class="string">'Parent'</span>, self.h.roi_control_vbox);
0425             set(self.h.add_rois_button, <span class="string">'Parent'</span>, self.h.roi_button_hbox.double());
0426             set(self.h.delete_rois_button, <span class="string">'Parent'</span>, self.h.roi_button_hbox.double());
0427             
0428             <span class="comment">% Data tab</span>
0429             set(self.h.data_button_hbox, <span class="string">'Parent'</span>, self.h.data_tab);
0430             set(self.h.reset_button, <span class="string">'Parent'</span>, self.h.data_button_hbox.double());
0431             set(self.h.concat_trials_toggle, <span class="string">'Parent'</span>, self.h.data_button_hbox.double());
0432             
0433             <span class="comment">% PP tab</span>
0434             set(self.h.pp_button_hbox, <span class="string">'Parent'</span>, self.h.pp_tab);
0435             set(self.h.motion_correct_button, <span class="string">'Parent'</span>, self.h.pp_button_hbox.double());
0436             set(self.h.wavelets_check, <span class="string">'Parent'</span>, self.h.pp_button_hbox.double());
0437             set(self.h.preprocess_button, <span class="string">'Parent'</span>, self.h.pp_button_hbox.double());
0438             
0439             <span class="comment">% PCA tab</span>
0440             set(self.h.pca_button_hbox, <span class="string">'Parent'</span>, self.h.pca_tab);
0441             set(self.h.runpca_button, <span class="string">'Parent'</span>, self.h.pca_button_hbox.double());
0442             
0443             <span class="comment">% ICA tab</span>
0444             set(self.h.ica_main_hbox, <span class="string">'Parent'</span>, self.h.ica_tab);
0445             set(self.h.ica_settings_panel, <span class="string">'Parent'</span>, self.h.ica_main_hbox);
0446             set(self.h.ica_button_vbox, <span class="string">'Parent'</span>, self.h.ica_main_hbox);
0447             set(self.h.ica_settings_vbox, <span class="string">'Parent'</span>, self.h.ica_settings_panel);
0448             set(self.h.ica_which_pcs_hbox, <span class="string">'Parent'</span>, self.h.ica_settings_vbox);
0449             set(self.h.which_pcs_label, <span class="string">'Parent'</span>, self.h.ica_which_pcs_hbox.double());
0450             set(self.h.which_pcs_edit, <span class="string">'Parent'</span>, self.h.ica_which_pcs_hbox.double());
0451             set(self.h.runica_button, <span class="string">'Parent'</span>, self.h.ica_button_vbox.double());
0452             set(self.h.calc_rois_button, <span class="string">'Parent'</span>, self.h.ica_button_vbox.double());
0453             
0454             <span class="comment">% Viz tab</span>
0455             set(self.h.viz_main_hbox, <span class="string">'Parent'</span>, self.h.viz_tab);
0456             set(self.h.viz_button_hbox, <span class="string">'Parent'</span>, self.h.viz_main_hbox);
0457             set(self.h.viz_settings_box, <span class="string">'Parent'</span>, self.h.viz_main_hbox);
0458             set(self.h.viz_settings_grid, <span class="string">'Parent'</span>, self.h.viz_settings_box);
0459             
0460             set(self.h.viz_button, <span class="string">'Parent'</span>, self.h.viz_button_hbox.double());
0461             
0462             set(self.h.map_pow_label, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0463             set(self.h.color_pow_label, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0464             set(self.h.alpha_label, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0465             set(self.h.map_pow_slider, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0466             set(self.h.color_pow_slider, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0467             set(self.h.alpha_slider, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0468             set(self.h.map_pow_indicator, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0469             set(self.h.color_pow_indicator, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0470             set(self.h.alpha_indicator, <span class="string">'Parent'</span>, self.h.viz_settings_grid.double());
0471             
0472             <span class="comment">% Segment/Cluster tab</span>
0473             set(self.h.sc_main_hbox, <span class="string">'Parent'</span>, self.h.sc_tab);
0474             set(self.h.sc_segment_panel, <span class="string">'Parent'</span>, self.h.sc_main_hbox);
0475             set(self.h.sc_cluster_panel, <span class="string">'Parent'</span>, self.h.sc_main_hbox);
0476             set(self.h.sc_segment_vbox, <span class="string">'Parent'</span>, self.h.sc_segment_panel);
0477             set(self.h.sc_cluster_vbox, <span class="string">'Parent'</span>, self.h.sc_cluster_panel);
0478             
0479             set(self.h.sc_segment_grid, <span class="string">'Parent'</span>, self.h.sc_segment_vbox);
0480             set(self.h.sc_segment_button_hbox, <span class="string">'Parent'</span>, self.h.sc_segment_vbox);
0481             
0482             set(self.h.down_size_label, <span class="string">'Parent'</span>, self.h.sc_segment_grid.double());
0483             set(self.h.thresh_label, <span class="string">'Parent'</span>, self.h.sc_segment_grid.double());
0484             set(self.h.down_size_slider, <span class="string">'Parent'</span>, self.h.sc_segment_grid.double());
0485             set(self.h.thresh_slider, <span class="string">'Parent'</span>, self.h.sc_segment_grid.double());
0486             set(self.h.down_size_indicator, <span class="string">'Parent'</span>, self.h.sc_segment_grid.double());
0487             set(self.h.thresh_indicator, <span class="string">'Parent'</span>, self.h.sc_segment_grid.double());
0488             
0489             set(self.h.max_corr_thresh_button, <span class="string">'Parent'</span>, self.h.sc_segment_button_hbox.double());
0490             set(self.h.segment_ics_button, <span class="string">'Parent'</span>, self.h.sc_segment_button_hbox.double());
0491             
0492             
0493             set(self.h.set_cluster_button, <span class="string">'Parent'</span>, self.h.sc_cluster_vbox.double());
0494             set(self.h.uncluster_button, <span class="string">'Parent'</span>, self.h.sc_cluster_vbox.double());
0495             set(self.h.estimate_clusters_button, <span class="string">'Parent'</span>, self.h.sc_cluster_vbox.double());
0496             
0497             <span class="comment">% Component axis hierarchy</span>
0498             set(self.h.data_panel, <span class="string">'Parent'</span>, self.h.component_pc3_vbox);
0499             set(self.h.component_panel, <span class="string">'Parent'</span>, self.h.component_pc3_vbox);
0500             set(self.h.pc3_main_panel, <span class="string">'Parent'</span>, self.h.component_pc3_vbox);
0501             
0502             set(self.h.component_lock_vbox, <span class="string">'Parent'</span>, self.h.component_panel);
0503             set(self.h.component_axes, <span class="string">'Parent'</span>, self.h.component_lock_vbox.double());
0504             set(self.h.lock_button_hbox, <span class="string">'Parent'</span>, self.h.component_lock_vbox);
0505             set(self.h.lock_component_button, <span class="string">'Parent'</span>, self.h.lock_button_hbox.double());
0506             set(self.h.clear_locked_button, <span class="string">'Parent'</span>, self.h.lock_button_hbox.double());
0507             
0508             set(self.h.data_axes, <span class="string">'Parent'</span>, self.h.data_panel.double());
0509             
0510             <span class="comment">% 3D plot hierarchy</span>
0511             set(self.h.pc3_main_hbox, <span class="string">'Parent'</span>, self.h.pc3_main_panel);
0512             
0513             set(self.h.pc3_axes, <span class="string">'Parent'</span>, self.h.pc3_main_hbox.double());
0514             set(self.h.pc3_control_rotate_vbox, <span class="string">'Parent'</span>, self.h.pc3_main_hbox);
0515             
0516             set(self.h.pc3_control_panel, <span class="string">'Parent'</span>, self.h.pc3_control_rotate_vbox);
0517             set(self.h.rotate_toggle, <span class="string">'Parent'</span>, self.h.pc3_control_rotate_vbox.double());
0518             
0519             set(self.h.pc3_control_grid, <span class="string">'Parent'</span>, self.h.pc3_control_panel);
0520             
0521             set(self.h.xl, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0522             set(self.h.yl, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0523             set(self.h.zl, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0524             set(self.h.x_popup, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0525             set(self.h.y_popup, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0526             set(self.h.z_popup, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0527             set(self.h.xy_button, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0528             set(self.h.yz_button, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0529             set(self.h.zx_button, <span class="string">'Parent'</span>, self.h.pc3_control_grid.double());
0530             
0531             <span class="comment">% Layout structure.</span>
0532             set(self.h.pc3_control_grid,<span class="keyword">...</span>
0533                 <span class="string">'ColumnSizes'</span>, [self.gui.PC_PANEL_ITEM_W, -1, self.gui.PC_PANEL_ITEM_W],<span class="keyword">...</span>
0534                 <span class="string">'RowSizes'</span>, [self.gui.BUTTON_H, self.gui.BUTTON_H, self.gui.BUTTON_H]);
0535             set(self.h.pc3_control_rotate_vbox, <span class="string">'Sizes'</span>, [-1, self.gui.BUTTON_H]);
0536             set(self.h.pc3_main_hbox, <span class="string">'Sizes'</span>, [-4, -1]);
0537             
0538             set(self.h.component_pc3_vbox, <span class="string">'Sizes'</span>, [-1, -1, -1]);
0539             
0540             set(self.h.component_lock_vbox, <span class="string">'Sizes'</span>, [-1, self.gui.BUTTON_H]);
0541             
0542             set(self.h.editor_button_vbox, <span class="string">'Sizes'</span>, [-1, self.gui.CONTROL_H, self.gui.BUTTON_H]);
0543             set(self.h.roi_stage_hbox, <span class="string">'Sizes'</span>, [-1, -1, -3]);
0544             set(self.h.trial_control_vbox, <span class="string">'Sizes'</span>, [-1, self.gui.BUTTON_H]);
0545             set(self.h.roi_control_vbox, <span class="string">'Sizes'</span>, [-1, self.gui.BUTTON_H]);
0546             
0547             set(self.h.main_hbox, <span class="string">'Sizes'</span>, [-1 -1]);
0548             
0549             set(self.h.viz_settings_grid, <span class="keyword">...</span>
0550                 <span class="string">'ColumnSizes'</span>, [self.gui.VIZ_SETTINGS_ITEM_W, -1, self.gui.VIZ_SETTINGS_ITEM_W], <span class="keyword">...</span>
0551                 <span class="string">'RowSizes'</span>, [self.gui.VIZ_SETTINGS_ITEM_H, self.gui.VIZ_SETTINGS_ITEM_H, self.gui.VIZ_SETTINGS_ITEM_H]);
0552             
0553             set(self.h.sc_segment_grid, <span class="keyword">...</span>
0554                 <span class="string">'ColumnSizes'</span>, [self.gui.VIZ_SETTINGS_ITEM_W, -1, self.gui.VIZ_SETTINGS_ITEM_W], <span class="keyword">...</span>
0555                 <span class="string">'RowSizes'</span>, [self.gui.VIZ_SETTINGS_ITEM_H, self.gui.VIZ_SETTINGS_ITEM_H]);
0556             
0557             set(self.Parent, <span class="string">'Position'</span>, [100, 100, self.Position(3), self.Position(4)]);
0558         <span class="keyword">end</span>
0559         
0560         <span class="comment">%%%%%%%%%% Callbacks %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0561         <a name="_sub4" href="#_subfunctions" class="code">function window_key_press_cb(self, source_h, eventdata)</a>
0562             disp(<span class="string">'window_keypress_cb'</span>);
0563         <span class="keyword">end</span>
0564         
0565         <a name="_sub5" href="#_subfunctions" class="code">function reset_button_cb(self, source_h, eventdata)</a>
0566             disp(<span class="string">'reset_button_cb'</span>);
0567             self.reset();
0568         <span class="keyword">end</span>
0569         
0570         <a name="_sub6" href="#_subfunctions" class="code">function motion_correct_button_cb(self, source_h, eventdata)</a>
0571             disp(<span class="string">'motion_correct_button_cb'</span>);
0572             self.run_motion_correction();
0573         <span class="keyword">end</span>
0574         
0575         <a name="_sub7" href="#_subfunctions" class="code">function preprocess_button_cb(self, source_h, eventdata)</a>
0576             disp(<span class="string">'preprocess_button_cb'</span>);
0577             
0578             self.run_preprocessing();
0579         <span class="keyword">end</span>
0580         
0581         <a name="_sub8" href="#_subfunctions" class="code">function wavelets_check_cb(self, source_h, eventdata)</a>
0582             disp(<span class="string">'wavelets_check_cb'</span>);
0583             self.set_use_wavelets(get(self.h.wavelets_check, <span class="string">'Value'</span>));
0584         <span class="keyword">end</span>
0585         
0586         <a name="_sub9" href="#_subfunctions" class="code">function runpca_button_cb(self, source_h, eventdata)</a>
0587             disp(<span class="string">'runpca_button_cb'</span>);
0588             
0589             self.run_pca();
0590         <span class="keyword">end</span>
0591         
0592         <a name="_sub10" href="#_subfunctions" class="code">function runica_button_cb(self, source_h, eventdata)</a>
0593             disp(<span class="string">'runica_button_cb'</span>);
0594             
0595             self.run_ica();
0596         <span class="keyword">end</span>
0597         
0598         <a name="_sub11" href="#_subfunctions" class="code">function segment_ics_cb(self, source_h, eventdata)</a>
0599             disp(<span class="string">'segment_ics_cb'</span>);
0600             
0601             self.run_segmentation();
0602         <span class="keyword">end</span>
0603         
0604         <a name="_sub12" href="#_subfunctions" class="code">function viz_button_cb(self, source_h, eventdata)</a>
0605             self.run_visualization();
0606         <span class="keyword">end</span>
0607         
0608         <a name="_sub13" href="#_subfunctions" class="code">function estimate_clusters_cb(self, source_h, eventdata)</a>
0609             self.estimate_clusters();
0610         <span class="keyword">end</span>
0611         
0612         <a name="_sub14" href="#_subfunctions" class="code">function set_cluster_button_cb(self, source_h, eventdata)</a>
0613             disp(<span class="string">'set_cluster_button_cb'</span>);
0614             
0615             self.set_cluster();
0616         <span class="keyword">end</span>
0617         
0618         <a name="_sub15" href="#_subfunctions" class="code">function uncluster_button_cb(self, source_h, eventdata)</a>
0619             disp(<span class="string">'uncluster_button_cb'</span>);
0620             
0621             self.uncluster();
0622         <span class="keyword">end</span>
0623         
0624         <a name="_sub16" href="#_subfunctions" class="code">function stage_tab_panel_cb(self, source_h, eventdata)</a>
0625             disp(<span class="string">'stage_tab_panel_cb'</span>);
0626             
0627             self.gui.d(self.gui.current_trial).display = eventdata.SelectedChild;
0628             self.update();
0629         <span class="keyword">end</span>
0630         
0631         <a name="_sub17" href="#_subfunctions" class="code">function x_popup_cb(self, sh, ed)</a>
0632             <span class="comment">% x_popup_cb: callback for when x popup is changed.</span>
0633             
0634             v = get(sh, <span class="string">'Value'</span>);
0635             self.gui.d(self.gui.current_trial).x_pc = v;
0636             
0637             <span class="comment">% Now make sure y, z aren't x.</span>
0638             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).y_pc == self.gui.d(self.gui.current_trial).x_pc
0639                 <span class="comment">% Then y is equal to x</span>
0640                 <span class="keyword">for</span> i = 1:10
0641                     <span class="keyword">if</span> i ~= self.gui.d(self.gui.current_trial).x_pc &amp;&amp; i ~= self.gui.d(self.gui.current_trial).z_pc
0642                         self.gui.d(self.gui.current_trial).y_pc = i;
0643                         <span class="keyword">break</span>;
0644                     <span class="keyword">end</span>
0645                 <span class="keyword">end</span>
0646             <span class="keyword">end</span>
0647             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).z_pc == self.gui.d(self.gui.current_trial).x_pc
0648                 <span class="comment">% Then z is equal to x</span>
0649                 <span class="keyword">for</span> i = 1:10
0650                     <span class="keyword">if</span> i ~= self.gui.d(self.gui.current_trial).x_pc &amp;&amp; i ~= self.gui.d(self.gui.current_trial).y_pc
0651                         self.gui.d(self.gui.current_trial).z_pc = i;
0652                         <span class="keyword">break</span>;
0653                     <span class="keyword">end</span>
0654                 <span class="keyword">end</span>
0655             <span class="keyword">end</span>
0656             self.update();
0657         <span class="keyword">end</span>
0658         
0659         <a name="_sub18" href="#_subfunctions" class="code">function y_popup_cb(self, sh, ed)</a>
0660             <span class="comment">% y_popup_cb: callback for when y popup is changed.</span>
0661             
0662             v = get(sh, <span class="string">'Value'</span>);
0663             self.gui.d(self.gui.current_trial).y_pc = v;
0664             
0665             <span class="comment">% Now make sure x, z aren't y.</span>
0666             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).x_pc == self.gui.d(self.gui.current_trial).y_pc
0667                 <span class="comment">% Then x is equal to y</span>
0668                 <span class="keyword">for</span> i = 1:10
0669                     <span class="keyword">if</span> i ~= self.gui.d(self.gui.current_trial).y_pc &amp;&amp; i ~= self.gui.d(self.gui.current_trial).z_pc
0670                         self.gui.d(self.gui.current_trial).x_pc = i;
0671                         <span class="keyword">break</span>;
0672                     <span class="keyword">end</span>
0673                 <span class="keyword">end</span>
0674             <span class="keyword">end</span>
0675             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).z_pc == self.gui.d(self.gui.current_trial).y_pc
0676                 <span class="comment">% Then z is equal to y</span>
0677                 <span class="keyword">for</span> i = 1:10
0678                     <span class="keyword">if</span> i ~= self.gui.d(self.gui.current_trial).y_pc &amp;&amp; i ~= self.gui.d(self.gui.current_trial).x_pc
0679                         self.gui.d(self.gui.current_trial).z_pc = i;
0680                         <span class="keyword">break</span>;
0681                     <span class="keyword">end</span>
0682                 <span class="keyword">end</span>
0683             <span class="keyword">end</span>
0684             self.update();
0685         <span class="keyword">end</span>
0686         
0687         <a name="_sub19" href="#_subfunctions" class="code">function z_popup_cb(self, sh, ed)</a>
0688             <span class="comment">% z_popup_cb: callback for when z popup is changed.</span>
0689             
0690             v = get(sh, <span class="string">'Value'</span>);
0691             self.gui.d(self.gui.current_trial).z_pc = v;
0692             
0693             <span class="comment">% Now make sure y, x aren't z.</span>
0694             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).y_pc == self.gui.d(self.gui.current_trial).z_pc
0695                 <span class="comment">% Then y is equal to z</span>
0696                 <span class="keyword">for</span> i = 1:10
0697                     <span class="keyword">if</span> i ~= self.gui.d(self.gui.current_trial).x_pc &amp;&amp; i ~= self.gui.d(self.gui.current_trial).z_pc
0698                         self.gui.d(self.gui.current_trial).y_pc = i;
0699                         <span class="keyword">break</span>;
0700                     <span class="keyword">end</span>
0701                 <span class="keyword">end</span>
0702             <span class="keyword">end</span>
0703             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).x_pc == self.gui.d(self.gui.current_trial).z_pc
0704                 <span class="comment">% Then x is equal to z</span>
0705                 <span class="keyword">for</span> i = 1:10
0706                     <span class="keyword">if</span> i ~= self.gui.d(self.gui.current_trial).z_pc &amp;&amp; i ~= self.gui.d(self.gui.current_trial).y_pc
0707                         self.gui.d(self.gui.current_trial).x_pc = i;
0708                         <span class="keyword">break</span>;
0709                     <span class="keyword">end</span>
0710                 <span class="keyword">end</span>
0711             <span class="keyword">end</span>
0712             self.update();
0713         <span class="keyword">end</span>
0714         
0715         <a name="_sub20" href="#_subfunctions" class="code">function xy_button_cb(self, sh, ed)</a>
0716             <span class="comment">% xy_button_cb: callback that rotates pc axes to show xy.</span>
0717             view(self.h.pc3_axes, [0 90]);
0718         <span class="keyword">end</span>
0719         
0720         <a name="_sub21" href="#_subfunctions" class="code">function yz_button_cb(self, sh, ed)</a>
0721             <span class="comment">% yz_button_cb: callback that rotates pc axes to show yz.</span>
0722             view(self.h.pc3_axes, [90 0]);
0723         <span class="keyword">end</span>
0724         
0725         <a name="_sub22" href="#_subfunctions" class="code">function zx_button_cb(self, sh, ed)</a>
0726             <span class="comment">% zx_button_cb: callback that rotates pc axes to show zx.</span>
0727             view(self.h.pc3_axes, [0 0]);
0728         <span class="keyword">end</span>
0729         
0730         <a name="_sub23" href="#_subfunctions" class="code">function rotate_toggle_cb(self, sh, ed)</a>
0731             v = get(sh, <span class="string">'Value'</span>);
0732             
0733             <span class="keyword">if</span> v
0734                 start(self.gui.rotate_timer);
0735             <span class="keyword">else</span>
0736                 stop(self.gui.rotate_timer);
0737             <span class="keyword">end</span>
0738         <span class="keyword">end</span>
0739         
0740         <a name="_sub24" href="#_subfunctions" class="code">function rotate_timer_cb(self, sh, ed)</a>
0741             [az, el] = view(self.h.pc3_axes);
0742             view(self.h.pc3_axes, az + self.gui.rotate_angle_step, el);
0743         <span class="keyword">end</span>
0744         
0745         <a name="_sub25" href="#_subfunctions" class="code">function re_selection_changed_cb(self, source_h, eventdata)</a>
0746             disp(<span class="string">'re_selection_changed_cb'</span>);
0747             self.update();
0748         <span class="keyword">end</span>
0749         
0750         <a name="_sub26" href="#_subfunctions" class="code">function re_new_rois_cb(self, source_h, eventdata)</a>
0751             disp(<span class="string">'re_new_rois_cb'</span>);
0752             self.update_current_roi_set();
0753             self.update();
0754         <span class="keyword">end</span>
0755         
0756         <a name="_sub27" href="#_subfunctions" class="code">function re_altered_rois_cb(self, source_h, eventdata)</a>
0757             disp(<span class="string">'re_altered_rois_cb'</span>);
0758             self.update_current_roi_set();
0759             self.update();
0760         <span class="keyword">end</span>
0761         
0762         <a name="_sub28" href="#_subfunctions" class="code">function re_deleted_rois_cb(self, source_h, eventdata)</a>
0763             disp(<span class="string">'re_deleted_rois_cb'</span>);
0764             self.update_current_roi_set();
0765             self.update();
0766         <span class="keyword">end</span>
0767         
0768         <a name="_sub29" href="#_subfunctions" class="code">function re_frame_changed_cb(self, source_h, eventdata)</a>
0769             disp(<span class="string">'re_frame_changed_cb'</span>);
0770             f = self.h.roi_editor.current_frame;
0771             
0772             self.gui.d(self.gui.current_trial).current_frame(self.gui.d(self.gui.current_trial).display) = f;
0773             self.update();
0774         <span class="keyword">end</span>
0775         
0776         <a name="_sub30" href="#_subfunctions" class="code">function re_levels_changed_cb(self, source_h, eventdata)</a>
0777             disp(<span class="string">'re_levels_changed_cb'</span>);
0778             ld = self.gui.d(self.gui.current_trial).last_display;
0779             
0780             <span class="keyword">if</span> ld &gt; 0
0781                 self.gui.d(self.gui.current_trial).levels(:,:,ld) = self.h.roi_editor.get_levels();
0782             <span class="keyword">end</span>
0783         <span class="keyword">end</span>
0784         
0785         <a name="_sub31" href="#_subfunctions" class="code">function load_settings_cb(self, source_h, eventdata)</a>
0786             disp(<span class="string">'load_settings_cb'</span>);
0787         <span class="keyword">end</span>
0788         
0789         <a name="_sub32" href="#_subfunctions" class="code">function save_settings_cb(self, source_h, eventdata)</a>
0790             disp(<span class="string">'save_settings_cb'</span>);
0791         <span class="keyword">end</span>
0792         
0793         <a name="_sub33" href="#_subfunctions" class="code">function edit_preprocessing_cb(self, source_h, eventdata)</a>
0794             disp(<span class="string">'edit_preprocessing_cb'</span>);
0795             
0796             self.edit_preprocessing_settings();
0797         <span class="keyword">end</span>
0798         
0799         <a name="_sub34" href="#_subfunctions" class="code">function edit_pca_cb(self, source_h, eventdata)</a>
0800             disp(<span class="string">'edit_pca_cb'</span>);
0801         <span class="keyword">end</span>
0802         
0803         <a name="_sub35" href="#_subfunctions" class="code">function edit_ica_cb(self, source_h, eventdata)</a>
0804             disp(<span class="string">'edit_ica_cb'</span>);
0805         <span class="keyword">end</span>
0806         
0807         <a name="_sub36" href="#_subfunctions" class="code">function pp_settings_ok_cb(self, source_h, eventdata)</a>
0808             
0809             <span class="comment">% Get all of the data from the dialog. If the dialog has bad</span>
0810             <span class="comment">% values, then these will be NaN. The set function will handle</span>
0811             <span class="comment">% the NaN case.</span>
0812             smooth_M_val = str2double(get(self.h.pp_smooth_M, <span class="string">'String'</span>));
0813             smooth_N_val = str2double(get(self.h.pp_smooth_N, <span class="string">'String'</span>));
0814             smooth_T_val = str2double(get(self.h.pp_smooth_T, <span class="string">'String'</span>));
0815             
0816             down_M_val = str2double(get(self.h.pp_down_M, <span class="string">'String'</span>));
0817             down_N_val = str2double(get(self.h.pp_down_N, <span class="string">'String'</span>));
0818             down_T_val = str2double(get(self.h.pp_down_T, <span class="string">'String'</span>));
0819             
0820             self.set_pp_smooth_window(smooth_M_val, smooth_N_val, smooth_T_val);
0821             self.set_pp_down_sample(down_M_val, down_N_val, down_T_val);
0822             
0823             close(self.h.pp_dialog);
0824         <span class="keyword">end</span>
0825         
0826         <a name="_sub37" href="#_subfunctions" class="code">function pp_settings_cancel_cb(self, source_h, eventdata)</a>
0827             close(self.h.pp_dialog);
0828         <span class="keyword">end</span>
0829         
0830         <a name="_sub38" href="#_subfunctions" class="code">function lock_component_button_cb(self, source_h, eventdata)</a>
0831             disp(<span class="string">'lock_component_button_cb'</span>);
0832             self.lock_current_component();
0833         <span class="keyword">end</span>
0834         
0835         <a name="_sub39" href="#_subfunctions" class="code">function clear_locked_button_cb(self, source_h, eventdata)</a>
0836             disp(<span class="string">'clear_locked_button_cb'</span>);
0837             self.clear_locked_components();
0838         <span class="keyword">end</span>
0839         
0840         <a name="_sub40" href="#_subfunctions" class="code">function component_label_cb(self, source_h, eventdata)</a>
0841             disp(<span class="string">'component_label_cb'</span>);
0842             c = get(source_h, <span class="string">'UserData'</span>);
0843             
0844             <span class="keyword">if</span> isscalar(c)
0845                 <span class="comment">% Then jump to the IC</span>
0846                 self.gui.d(self.gui.current_trial).display = 4;
0847                 self.gui.d(self.gui.current_trial).current_frame(4) = c;
0848                 self.update();
0849                 <span class="comment">%self.h.roi_editor.set_current_frame(c);</span>
0850             <span class="keyword">end</span>
0851         <span class="keyword">end</span>
0852         
0853         <a name="_sub41" href="#_subfunctions" class="code">function trial_listbox_cb(self, source_h, eventdata)</a>
0854             disp(<span class="string">'trial_listbox_cb'</span>);
0855             
0856             sel = get(self.h.trial_listbox, <span class="string">'Value'</span>);
0857             self.set_selected_trial(sel);
0858         <span class="keyword">end</span>
0859         
0860         <a name="_sub42" href="#_subfunctions" class="code">function add_trial_button_cb(self, source_h, eventdata)</a>
0861             disp(<span class="string">'add_trial_button_cb'</span>);
0862             
0863             self.load_data();
0864         <span class="keyword">end</span>
0865         
0866         <a name="_sub43" href="#_subfunctions" class="code">function delete_trial_button_cb(self, source_h, eventdata)</a>
0867             disp(<span class="string">'delete_trial_button_cb'</span>);
0868             
0869             sel = get(self.h.trial_listbox, <span class="string">'Value'</span>);
0870             self.delete_trial();
0871         <span class="keyword">end</span>
0872         
0873         <a name="_sub44" href="#_subfunctions" class="code">function roi_listbox_cb(self, source_h, eventdata)</a>
0874             disp(<span class="string">'roi_listbox_cb'</span>);
0875             
0876             sel = get(self.h.roi_listbox, <span class="string">'Value'</span>);
0877             self.select_roi_set(sel);
0878         <span class="keyword">end</span>
0879         
0880         <a name="_sub45" href="#_subfunctions" class="code">function add_rois_button_cb(self, source_h, eventdata)</a>
0881             disp(<span class="string">'add_rois_button_cb'</span>);
0882             self.create_new_roi_set();
0883         <span class="keyword">end</span>
0884         
0885         <a name="_sub46" href="#_subfunctions" class="code">function delete_rois_button_cb(self, source_h, eventdata)</a>
0886             disp(<span class="string">'delete_rois_button_cb'</span>);
0887             self.delete_roi_set();
0888         <span class="keyword">end</span>
0889         
0890         <a name="_sub47" href="#_subfunctions" class="code">function calc_rois_cb(self, source_h, eventdata)</a>
0891             disp(<span class="string">'calc_rois_cb'</span>);
0892             self.calc_rois();
0893         <span class="keyword">end</span>
0894         
0895         <a name="_sub48" href="#_subfunctions" class="code">function save_rois_cb(self, source_h, eventdata)</a>
0896             self.save_rois();
0897         <span class="keyword">end</span>
0898         
0899         <a name="_sub49" href="#_subfunctions" class="code">function load_rois_cb(self, source_h, eventdata)</a>
0900             self.load_rois();
0901         <span class="keyword">end</span>
0902         
0903         <a name="_sub50" href="#_subfunctions" class="code">function load_image_cb(self, source_h, eventdata)</a>
0904             self.load_data();
0905         <span class="keyword">end</span>
0906         
0907         <a name="_sub51" href="#_subfunctions" class="code">function load_session_cb(self, source_h, eventdata)</a>
0908             self.load_session();
0909         <span class="keyword">end</span>
0910         
0911         <a name="_sub52" href="#_subfunctions" class="code">function save_session_cb(self, source_h, eventdata)</a>
0912             self.save_session();
0913         <span class="keyword">end</span>
0914         
0915         <a name="_sub53" href="#_subfunctions" class="code">function viz_settings_cb(self, source_h, eventdata)</a>
0916             disp(<span class="string">'viz_settings_cb'</span>);
0917             self.data(self.gui.current_trial).settings.viz.map_pow = get(self.h.map_pow_slider, <span class="string">'Value'</span>);
0918             self.data(self.gui.current_trial).settings.viz.color_pow = get(self.h.color_pow_slider, <span class="string">'Value'</span>);
0919             self.data(self.gui.current_trial).settings.viz.alpha = get(self.h.alpha_slider, <span class="string">'Value'</span>);
0920             
0921             self.draw_component_viz();
0922         <span class="keyword">end</span>
0923         
0924         <a name="_sub54" href="#_subfunctions" class="code">function concat_trials_toggle_cb(self, source_h, eventdata)</a>
0925             disp(<span class="string">'concat_trials_togle_cb'</span>);
0926             self.align_trials();
0927         <span class="keyword">end</span>
0928         
0929         <a name="_sub55" href="#_subfunctions" class="code">function which_pcs_edit_cb(self, source_h, eventdata)</a>
0930             disp(<span class="string">'which_pcs_edit_cb'</span>);
0931             [which_pcs, status] = str2num(get(self.h.which_pcs_edit, <span class="string">'String'</span>));
0932             
0933             <span class="keyword">if</span> status
0934                 self.set_which_pcs(which_pcs);
0935             <span class="keyword">else</span>
0936                 disp(<span class="string">'PCs input innapropriately formatted.'</span>);
0937                 self.update();
0938             <span class="keyword">end</span>
0939         <span class="keyword">end</span>
0940         
0941         <a name="_sub56" href="#_subfunctions" class="code">function down_size_slider_cb(self, source_h, eventdata)</a>
0942             disp(<span class="string">'down_slider_cb'</span>);
0943             v = get(self.h.down_size_slider, <span class="string">'Value'</span>);
0944             self.set_segment_down_size(v);
0945         <span class="keyword">end</span>
0946         
0947         <a name="_sub57" href="#_subfunctions" class="code">function down_size_indicator_cb(self, source_h, eventdata)</a>
0948             disp(<span class="string">'down_indicator_cb'</span>);
0949             [val, status] = str2num(get(self.h.down_size_indicator, <span class="string">'String'</span>));
0950             
0951             <span class="keyword">if</span> status
0952                 self.set_segment_down_size(val);
0953             <span class="keyword">else</span>
0954                 disp(<span class="string">'Down Size input innapropriately formatted.'</span>);
0955                 self.update();
0956             <span class="keyword">end</span>
0957         <span class="keyword">end</span>
0958         
0959         <a name="_sub58" href="#_subfunctions" class="code">function thresh_slider_cb(self, source_h, eventdata)</a>
0960             disp(<span class="string">'thresh_slider_cb'</span>);
0961             v = get(self.h.thresh_slider, <span class="string">'Value'</span>);
0962             self.set_segment_thresh(v);
0963         <span class="keyword">end</span>
0964         
0965         <a name="_sub59" href="#_subfunctions" class="code">function thresh_indicator_cb(self, source_h, eventdata)</a>
0966             disp(<span class="string">'thresh_indicator_cb'</span>);
0967             [val, status] = str2num(get(self.h.thresh_indicator, <span class="string">'String'</span>));
0968             
0969             <span class="keyword">if</span> status
0970                 self.set_segment_thresh(val);
0971             <span class="keyword">else</span>
0972                 disp(<span class="string">'Threshold input innapropriately formatted.'</span>);
0973                 self.update();
0974             <span class="keyword">end</span>
0975         <span class="keyword">end</span>
0976         
0977         <a name="_sub60" href="#_subfunctions" class="code">function max_corr_thresh_button_cb(self, source_h, eventdata)</a>
0978             disp(<span class="string">'max_corr_thresh_button_cb'</span>);
0979         <span class="keyword">end</span>
0980         
0981         <span class="comment">%%%%%%%%%% Main Functions %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0982         <a name="_sub61" href="#_subfunctions" class="code">function update(self)</a>
0983             <span class="comment">% update(self): main update function</span>
0984             
0985             disp(<span class="string">'ICP: update'</span>);
0986             
0987             f = self.h.roi_editor.current_frame;
0988             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).display &gt; length(self.gui.d(self.gui.current_trial).current_frame)
0989                 self.gui.d(self.gui.current_trial).current_frame(self.gui.d(self.gui.current_trial).display) = f;
0990             <span class="keyword">end</span>
0991             
0992             f = self.gui.d(self.gui.current_trial).current_frame(self.gui.d(self.gui.current_trial).display);
0993             
0994             set(self.h.stage_tab_panel, <span class="string">'SelectedChild'</span>, self.gui.d(self.gui.current_trial).display);
0995             
0996             rois = self.h.roi_editor.rois.xyrra(self.h.roi_editor.selected_rois, :, 1);
0997             
0998             cla(self.h.data_axes);
0999             <span class="keyword">if</span> ~isempty(rois)
1000                 <span class="comment">% plot the original data from the ROI.</span>
1001                 <span class="keyword">if</span> isfield(self.data(self.gui.current_trial).pp, <span class="string">'im_data_mc'</span>)
1002                     data = <a href="mean_roi.html" class="code" title="function data = mean_roi(ccd_movie, roi_data, im_x, im_y)">mean_roi</a>(self.data(self.gui.current_trial).pp.im_data_mc, rois, self.data(self.gui.current_trial).pp.mc_x, self.data(self.gui.current_trial).pp.mc_y);
1003                 <span class="keyword">else</span>
1004                     data = <a href="mean_roi.html" class="code" title="function data = mean_roi(ccd_movie, roi_data, im_x, im_y)">mean_roi</a>(self.data(self.gui.current_trial).im_data, rois);
1005                 <span class="keyword">end</span>
1006                 
1007                 <span class="comment">% need to do a check on norm_frame</span>
1008                 <span class="keyword">if</span> size(data, 1) &lt; self.gui.data_norm_frame
1009                     self.gui.data_norm_frame = 1; <span class="comment">% I guess just do this?</span>
1010                 <span class="keyword">end</span>
1011                 
1012                 data = 100 * (data ./ repmat(data(self.gui.data_norm_frame, :), size(data, 1), 1) - 1);
1013                 
1014                 plot(self.h.data_axes, data);
1015             <span class="keyword">end</span>
1016             
1017             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).display == 6 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PostProcessingStage <span class="keyword">...</span>
1018                     &amp;&amp; isfield(self.data(self.gui.current_trial).segment, <span class="string">'im_data'</span>) &amp;&amp; ~isempty(self.data(self.gui.current_trial).segment.im_data)
1019                 
1020                 <span class="comment">%                 if self.gui.d(self.gui.current_trial).last_display ~= self.gui.d(self.gui.current_trial).display</span>
1021                 <span class="comment">%                     % Don't update the roi editor if its the same</span>
1022                 <span class="comment">%                     self.h.roi_editor.set_im_data(self.data(self.gui.current_trial).cluster.im_data, [], self.data(self.gui.current_trial).cluster.im_x, self.data(self.gui.current_trial).cluster.im_y);</span>
1023                 <span class="comment">%                 end</span>
1024                 <span class="comment">%                 self.gui.d(self.gui.current_trial).last_display = self.gui.d(self.gui.current_trial).display;</span>
1025                 <span class="comment">%</span>
1026                 <span class="comment">%                 cla(self.h.component_axes);</span>
1027                 <span class="comment">%                 plot(self.h.component_axes, self.data(self.gui.current_trial).ica.ics(:, f), 'k', 'LineWidth', 2);</span>
1028                 <span class="comment">%</span>
1029                 <span class="comment">%                 plot(self.h.component_axes, self.data(self.gui.current_trial).ica.ics(:, self.data(self.gui.current_trial).cluster.top3(f, 3)), 'b');</span>
1030                 <span class="comment">%                 plot(self.h.component_axes, self.data(self.gui.current_trial).ica.ics(:, self.data(self.gui.current_trial).cluster.top3(f, 2)), 'g');</span>
1031                 <span class="comment">%                 plot(self.h.component_axes, self.data(self.gui.current_trial).ica.ics(:, self.data(self.gui.current_trial).cluster.top3(f, 1)), 'r');</span>
1032                 
1033                 <span class="comment">%             elseif self.gui.display == 5 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PostProcessingStage ...</span>
1034                 <span class="comment">%                     &amp;&amp; isfield(self.data(self.gui.current_trial).segment, 'im_data') &amp;&amp; ~isempty(self.data(self.gui.current_trial).segment.im_data)</span>
1035                 <span class="comment">%                 % Then view the segments</span>
1036                 <span class="keyword">if</span> self.gui.d(self.gui.current_trial).last_display ~= self.gui.d(self.gui.current_trial).display
1037                     self.h.roi_editor.set_im_data(self.data(self.gui.current_trial).segment.im_data, [], self.data(self.gui.current_trial).segment.im_x, self.data(self.gui.current_trial).segment.im_y);
1038                     f = self.h.roi_editor.set_current_frame(f);
1039                 <span class="keyword">end</span>
1040                 self.gui.d(self.gui.current_trial).last_display = self.gui.d(self.gui.current_trial).display;
1041                 
1042                 <span class="comment">% Plot the current ic</span>
1043                 cla(self.h.component_axes);
1044                 legend(self.h.component_axes, <span class="string">'off'</span>);
1045                 
1046                 plot(self.h.component_axes, self.data(self.gui.current_trial).ica.ics(:, f), <span class="string">'k'</span>);
1047                 ica_idx = f;
1048                 
1049                 text_x = 0.90;
1050                 
1051                 self.h.component_labels = text(text_x, 0.9, num2str(ica_idx), <span class="keyword">...</span>
1052                     <span class="string">'Parent'</span>, self.h.component_axes, <span class="string">'Units'</span>, <span class="string">'normalized'</span>, <span class="keyword">...</span>
1053                     <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>, <span class="string">'UserData'</span>, ica_idx, <span class="keyword">...</span>
1054                     <span class="string">'Color'</span>, <span class="string">'k'</span>, <span class="string">'ButtonDownFcn'</span>, @self.component_label_cb);
1055                 
1056             <span class="keyword">elseif</span> self.gui.d(self.gui.current_trial).display == 5 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PostProcessingStage <span class="keyword">...</span>
1057                     &amp;&amp; isfield(self.data(self.gui.current_trial).viz, <span class="string">'im_data'</span>) &amp;&amp; ~isempty(self.data(self.gui.current_trial).viz.im_data)
1058                 <span class="comment">% View the visualization</span>
1059                 <span class="keyword">if</span> self.gui.d(self.gui.current_trial).last_display ~= self.gui.d(self.gui.current_trial).display
1060                     <span class="comment">%%% This is a HACK for ROI Editor. It can show an RGB</span>
1061                     <span class="comment">%%% image, but it needs a 4th dimension and I can't</span>
1062                     <span class="comment">%%% make it a singleton 4th dimension.</span>
1063                     im4D = repmat(self.data(self.gui.current_trial).viz.im_data, [1 1 1 2]);
1064                     <span class="comment">%%%</span>
1065                     
1066                     self.h.roi_editor.set_im_data(im4D, [], self.data(self.gui.current_trial).viz.im_x, self.data(self.gui.current_trial).viz.im_y);
1067                 <span class="keyword">end</span>
1068                 self.gui.d(self.gui.current_trial).last_display = self.gui.d(self.gui.current_trial).display;
1069                 
1070             <span class="keyword">elseif</span> self.gui.d(self.gui.current_trial).display == 4 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.IcaStage
1071                 <span class="comment">% Then view the ICs</span>
1072                 <span class="keyword">if</span> self.gui.d(self.gui.current_trial).last_display ~= self.gui.d(self.gui.current_trial).display
1073                     <span class="comment">% Don't update the roi editor if its the same</span>
1074                     self.h.roi_editor.set_im_data(self.data(self.gui.current_trial).ica.im_data, [], self.data(self.gui.current_trial).ica.im_x, self.data(self.gui.current_trial).ica.im_y);
1075                 <span class="keyword">end</span>
1076                 self.gui.d(self.gui.current_trial).last_display = self.gui.d(self.gui.current_trial).display;
1077                 
1078                 <span class="comment">% Plot the current ic</span>
1079                 cla(self.h.component_axes);
1080                 legend(self.h.component_axes, <span class="string">'off'</span>);
1081                 
1082                 plot(self.h.component_axes, self.data(self.gui.current_trial).ica.ics(:, f), <span class="string">'k'</span>);
1083                 
1084             <span class="keyword">elseif</span> self.gui.d(self.gui.current_trial).display == 3 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PcaStage
1085                 <span class="comment">% Then view the PCs</span>
1086                 <span class="keyword">if</span> self.gui.d(self.gui.current_trial).last_display ~= self.gui.d(self.gui.current_trial).display
1087                     <span class="comment">% Don't update the roi editor if its the same</span>
1088                     self.h.roi_editor.set_im_data(self.data(self.gui.current_trial).pca.im_data, [], self.data(self.gui.current_trial).pca.im_x, self.data(self.gui.current_trial).pca.im_y);
1089                 <span class="keyword">end</span>
1090                 self.gui.d(self.gui.current_trial).last_display = self.gui.d(self.gui.current_trial).display;
1091                 
1092                 <span class="comment">% Plot the current pc</span>
1093                 cla(self.h.component_axes);
1094                 legend(self.h.component_axes, <span class="string">'off'</span>);
1095                 
1096                 <span class="comment">%plot(self.h.component_axes, self.data(self.gui.current_trial).pca.pcs(:, f), 'k');</span>
1097                 
1098                 <span class="keyword">if</span> isfield(self.data(self.gui.current_trial).pca, <span class="string">'pc_rec'</span>)
1099                     plot(self.h.component_axes, self.data(self.gui.current_trial).pca.pc_rec(:,f));
1100                 <span class="keyword">else</span>
1101                     plot(self.h.component_axes, self.data(self.gui.current_trial).pca.pcs(:, f), <span class="string">'k'</span>);
1102                 <span class="keyword">end</span>
1103             <span class="keyword">elseif</span> self.gui.d(self.gui.current_trial).display == 2 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PreProcessingStage
1104                 <span class="comment">% View the Preprocessing data</span>
1105                 <span class="keyword">if</span> self.gui.d(self.gui.current_trial).last_display ~= self.gui.d(self.gui.current_trial).display
1106                     <span class="comment">% Don't update the roi editor if its the same</span>
1107                     self.h.roi_editor.set_im_data(self.data(self.gui.current_trial).pp.im_data, [], self.data(self.gui.current_trial).pp.im_x, self.data(self.gui.current_trial).pp.im_y);
1108                 <span class="keyword">end</span>
1109                 self.gui.d(self.gui.current_trial).last_display = self.gui.d(self.gui.current_trial).display;
1110             <span class="keyword">else</span>
1111                 <span class="comment">% View the raw data.</span>
1112                 <span class="keyword">if</span> self.gui.d(self.gui.current_trial).last_display ~= 1
1113                     <span class="comment">% Don't update the roi editor if its the same</span>
1114                     self.h.roi_editor.set_im_data(self.data(self.gui.current_trial).im_data);
1115                 <span class="keyword">end</span>
1116                 self.gui.d(self.gui.current_trial).last_display = 1;
1117             <span class="keyword">end</span>
1118             
1119             self.h.roi_editor.set_current_frame(f, 0);
1120             
1121             <span class="comment">% I just want to see everything with the full axis range</span>
1122             set(self.h.roi_editor.h.im_axes, <span class="string">'Xlim'</span>, self.data(self.gui.current_trial).im_x([1, end]),<span class="keyword">...</span>
1123                 <span class="string">'YLim'</span>, self.data(self.gui.current_trial).im_y([1, end]));
1124             
1125             <span class="comment">% Set the levels,</span>
1126             levels = self.gui.d(self.gui.current_trial).levels(:,:,self.gui.d(self.gui.current_trial).last_display);
1127             <span class="keyword">if</span> ~any(isnan(levels))
1128                 <span class="comment">% Only do it if we actually have the last levels.</span>
1129                 self.h.roi_editor.set_levels(levels, [], 0);
1130             <span class="keyword">end</span>
1131             
1132             set(self.h.which_pcs_edit, <span class="string">'String'</span>, mat2str(self.data(self.gui.current_trial).settings.ica.which_pcs));
1133             
1134             <span class="keyword">switch</span> self.data(self.gui.current_trial).stage
1135                 <span class="keyword">case</span> self.InitStage, s = <span class="string">'Initialized'</span>;
1136                 <span class="keyword">case</span> self.PreProcessingStage, s = <span class="string">'Pre-Processing Complete'</span>;
1137                 <span class="keyword">case</span> self.PcaStage, s = <span class="string">'PCA Complete'</span>;
1138                 <span class="keyword">case</span> self.IcaStage, s = <span class="string">'ICA Complete'</span>;
1139                 <span class="keyword">case</span> self.PostProcessingStage, s = <span class="string">'Post-Processing Complete'</span>;
1140             <span class="keyword">end</span>
1141             
1142             set(self.h.stage_status, <span class="string">'String'</span>, s);
1143             
1144             self.h.roi_editor.color_rois = true;
1145             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).display == 6 &amp;&amp; self.data(self.gui.current_trial).stage == self.PostProcessingStage  <span class="keyword">...</span>
1146                     &amp;&amp; isfield(self.data(self.gui.current_trial).cluster, <span class="string">'im_data'</span>) &amp;&amp; ~isempty(self.data(self.gui.current_trial).cluster.im_data)
1147                 self.h.roi_editor.color_rois = false;
1148                 self.draw_clustered_rois();
1149                 
1150             <span class="keyword">elseif</span> self.data(self.gui.current_trial).is_component_set(self.gui.d(self.gui.current_trial).current_roi_set) <span class="keyword">...</span>
1151                     &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PostProcessingStage <span class="keyword">...</span>
1152                     &amp;&amp; ~isempty(self.h.roi_editor.selected_rois) <span class="keyword">...</span>
1153                     &amp;&amp; isfield(self.data(self.gui.current_trial).segment, <span class="string">'segment_info'</span>)
1154                 cla(self.h.component_axes);
1155                 
1156                 self.h.component_labels = [];
1157                 
1158                 <span class="keyword">for</span> i = 1:length(self.h.roi_editor.selected_rois)
1159                     c = self.gui.locked_colors(mod(i-1, length(self.gui.locked_colors))+1, :);
1160                     ica_idx = self.data(self.gui.current_trial).segment.segment_info.ic_ids(self.h.roi_editor.selected_rois(i));
1161                     plot(self.h.component_axes, self.data(self.gui.current_trial).ica.ics(:, ica_idx), <span class="string">'Color'</span>, c);
1162                     
1163                     text_x = 0.95 - (length(self.h.roi_editor.selected_rois) - i) * 0.05;
1164                     self.h.component_labels(i) = text(text_x, 0.9, num2str(ica_idx), <span class="keyword">...</span>
1165                         <span class="string">'Parent'</span>, self.h.component_axes, <span class="string">'Units'</span>, <span class="string">'normalized'</span>, <span class="keyword">...</span>
1166                         <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>, <span class="string">'UserData'</span>, ica_idx, <span class="keyword">...</span>
1167                         <span class="string">'Color'</span>, c, <span class="string">'ButtonDownFcn'</span>, @self.component_label_cb);
1168                 <span class="keyword">end</span>
1169             <span class="keyword">else</span>
1170                 self.show_best_selected_components(rois);
1171             <span class="keyword">end</span>
1172             
1173             <span class="comment">% Update the visualization settings gui.</span>
1174             set(self.h.map_pow_slider, <span class="string">'Value'</span>, self.data(self.gui.current_trial).settings.viz.map_pow);
1175             set(self.h.map_pow_indicator, <span class="string">'String'</span>, num2str(self.data(self.gui.current_trial).settings.viz.map_pow));
1176             set(self.h.color_pow_slider, <span class="string">'Value'</span>, self.data(self.gui.current_trial).settings.viz.color_pow);
1177             set(self.h.color_pow_indicator, <span class="string">'String'</span>, num2str(self.data(self.gui.current_trial).settings.viz.color_pow));
1178             set(self.h.alpha_slider, <span class="string">'Value'</span>, self.data(self.gui.current_trial).settings.viz.alpha);
1179             set(self.h.alpha_indicator, <span class="string">'String'</span>, num2str(self.data(self.gui.current_trial).settings.viz.alpha));
1180             
1181             <span class="comment">% Update segment settings gui</span>
1182             <span class="keyword">if</span> isfield(self.data(self.gui.current_trial).ica, <span class="string">'im_data'</span>)
1183                 <span class="comment">% Then reset the range of the thresh slider</span>
1184                 set(self.h.thresh_slider, <span class="string">'Min'</span>, min(self.data(self.gui.current_trial).ica.im_data(:)), <span class="string">'Max'</span>, max(self.data(self.gui.current_trial).ica.im_data(:)));
1185             <span class="keyword">end</span>
1186             <span class="comment">% @todo: make sure these are in the right range.</span>
1187             set(self.h.down_size_slider, <span class="string">'Value'</span>, self.data(self.gui.current_trial).settings.segment.down_size);
1188             set(self.h.down_size_indicator, <span class="string">'String'</span>, num2str(self.data(self.gui.current_trial).settings.segment.down_size));
1189             set(self.h.thresh_slider, <span class="string">'Value'</span>, self.data(self.gui.current_trial).settings.segment.thresh);
1190             set(self.h.thresh_indicator, <span class="string">'String'</span>, num2str(self.data(self.gui.current_trial).settings.segment.thresh));
1191             
1192             
1193             self.plot_locked_components();
1194             self.plot_3d();
1195             
1196             self.build_roi_listbox();
1197             self.build_trial_listbox();
1198             
1199             drawnow;
1200         <span class="keyword">end</span>
1201         
1202         <a name="_sub62" href="#_subfunctions" class="code">function warp = run_motion_correction(self)</a>
1203             <span class="comment">% run_motion_correction(self): Runs the motion correction.</span>
1204             
1205             disp(<span class="string">'run_motion_correction'</span>);
1206             
1207             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Running Motion Correction...'</span>);
1208             drawnow;
1209             
1210             s = self.data(self.gui.current_trial).settings.preprocessing;
1211             
1212             [self.data(self.gui.current_trial).pp.im_data_mc, warp] = s.motion_correct_func(self.data(self.gui.current_trial).im_data);
1213             
1214             <span class="comment">% Fix the size of the corrected data.</span>
1215             sx = floor((size(self.data(self.gui.current_trial).im_data, 2) - size(self.data(self.gui.current_trial).pp.im_data_mc, 2))/2) + 1;
1216             sy = floor((size(self.data(self.gui.current_trial).im_data, 1) - size(self.data(self.gui.current_trial).pp.im_data_mc, 1))/2) + 1;
1217             
1218             self.data(self.gui.current_trial).pp.mc_x = sx:(size(self.data(self.gui.current_trial).pp.im_data_mc, 2) + sx - 1);
1219             self.data(self.gui.current_trial).pp.mc_y = sy:(size(self.data(self.gui.current_trial).pp.im_data_mc, 1) + sy - 1);
1220         <span class="keyword">end</span>
1221         
1222         <a name="_sub63" href="#_subfunctions" class="code">function run_filters(self)</a>
1223             <span class="comment">% run_filters(self): Runs the filtering stage of preprocessing.</span>
1224             
1225         <span class="keyword">end</span>
1226         
1227         <a name="_sub64" href="#_subfunctions" class="code">function run_preprocessing(self)</a>
1228             <span class="comment">% run_preprocessing(self): Runs the preprocessing stage of the</span>
1229             <span class="comment">% analysis.</span>
1230             <span class="comment">%</span>
1231             <span class="comment">% Preprocessing turns image data (MxNxt) into a data matrix</span>
1232             <span class="comment">% (M*Nxt).</span>
1233             disp(<span class="string">'run_preprocessing'</span>);
1234             
1235             <span class="comment">% @todo: checks on current state</span>
1236             
1237             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Running Pre-Processing...'</span>);
1238             drawnow;
1239             
1240             s = self.data(self.gui.current_trial).settings.preprocessing;
1241             
1242             <span class="keyword">if</span> isfield(self.data(1), <span class="string">'concat'</span>) <span class="comment">% @todo: and some other flag</span>
1243                 disp(<span class="string">'concat pp'</span>);
1244                 <span class="comment">% Then we're running the concatenated ICA</span>
1245                 im_data = self.data(1).concat.im_data;
1246                 im_x = self.data(1).concat.im_x;
1247                 im_y = self.data(1).concat.im_y;
1248                 im_z = self.data(1).concat.im_z;
1249                 
1250                 <span class="comment">% Set the concat flag</span>
1251                 <span class="keyword">for</span> i = 1:length(self.data)
1252                     self.data(i).pp.is_concat = true;
1253                 <span class="keyword">end</span>
1254                 
1255                 <span class="comment">% The concat data always goes into trial 1.</span>
1256                 self.gui.current_trial = 1;
1257             <span class="keyword">else</span>
1258                 <span class="keyword">if</span> isfield(self.data(self.gui.current_trial).pp, <span class="string">'im_data_mc'</span>)
1259                     <span class="comment">% then we have motion corrected data.</span>
1260                     im_data = self.data(self.gui.current_trial).pp.im_data_mc;
1261                     im_x = self.data(self.gui.current_trial).pp.mc_x;
1262                     im_y = self.data(self.gui.current_trial).pp.mc_y;
1263                     im_z = 1:size(im_data, 3);
1264                 <span class="keyword">else</span>
1265                     <span class="comment">% Then use the original data.</span>
1266                     im_data = self.data(self.gui.current_trial).im_data;
1267                     im_x = 1:size(im_data, 2);
1268                     im_y = 1:size(im_data, 1);
1269                     im_z = 1:size(im_data, 3);
1270                 <span class="keyword">end</span>
1271                 
1272                 <span class="comment">% Turn the concat flag off.</span>
1273                 self.data(self.gui.current_trial).pp.is_concat = false;
1274                 
1275                 im_data(:,:,s.remove_frames) = [];
1276                 im_z(s.remove_frames) = [];
1277             <span class="keyword">end</span>
1278             
1279             block = ones(s.smooth_window) ./ (prod(s.smooth_window));
1280             
1281             im_conv = convn(im_data, block, <span class="string">'same'</span>);
1282             
1283             xs_remove = floor((size(block, 2)-1)/2);
1284             xe_remove = (size(block, 2)-1) - xs_remove;
1285             ys_remove = floor((size(block, 1)-1)/2);
1286             ye_remove = (size(block, 2)-1) - ys_remove;
1287             zs_remove = floor((size(block, 3)-1)/2);
1288             ze_remove = (size(block, 3)-1) - zs_remove;
1289             
1290             im_x(1:xs_remove) = [];
1291             im_x((end-xe_remove):end) = [];
1292             im_y(1:ys_remove) = [];
1293             im_y((end-ye_remove):end) = [];
1294             im_z(1:zs_remove) = [];
1295             im_z((end-ze_remove):end) = [];
1296             
1297             im_conv([1:ys_remove, (end-ye_remove):end], :, :) = [];
1298             im_conv(:, [1:xs_remove, (end-xe_remove):end], :) = [];
1299             im_conv(:, :, [1:zs_remove, (end-ze_remove):end]) = [];
1300             
1301             xidx = 1:s.down_sample(1):length(im_x);
1302             yidx = 1:s.down_sample(2):length(im_y);
1303             zidx = 1:s.down_sample(3):length(im_z);
1304             
1305             <span class="comment">% Ok, now need to take out frames</span>
1306             self.data(self.gui.current_trial).pp.im_y = im_y(yidx);
1307             self.data(self.gui.current_trial).pp.im_x = im_x(xidx);
1308             self.data(self.gui.current_trial).pp.im_z = im_z(zidx);
1309             
1310             self.data(self.gui.current_trial).pp.im_data = im_conv(yidx, xidx, zidx);
1311             self.data(self.gui.current_trial).pp.data = reshape(self.data(self.gui.current_trial).pp.im_data, [], size(self.data(self.gui.current_trial).pp.im_data, 3));
1312             
1313             self.data(self.gui.current_trial).pp.use_wavelets = self.gui.d(self.gui.current_trial).use_wavelets;
1314             
1315             <span class="keyword">if</span> self.data(self.gui.current_trial).pp.use_wavelets
1316                 <span class="comment">% Then we want to do the wavelet decomposition</span>
1317                 disp(<span class="string">'Computing Wavelets...'</span>);
1318                 set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Computing Wavelets...'</span>);
1319                 drawnow;
1320                 
1321                 cwt_struct = cwtft(self.data(self.gui.current_trial).pp.data(1,:));
1322                 num_scales = length(cwt_struct.scales);
1323                 num_frames = size(self.data(self.gui.current_trial).pp.data, 2);
1324                 
1325                 self.data(self.gui.current_trial).pp.cwt_data = zeros(size(self.data(self.gui.current_trial).pp.data, 1), 2 * num_scales * num_frames);
1326                 
1327                 rcwt = real(cwt_struct.cfs);
1328                 icwt = imag(cwt_struct.cfs);
1329                 
1330                 self.data(self.gui.current_trial).pp.cwt_data(1, :) = reshape([rcwt, icwt], 1, []);
1331                 
1332                 self.data(self.gui.current_trial).pp.cwt_struct = cwt_struct;
1333                 
1334                 <span class="keyword">for</span> i = 2:size(self.data(self.gui.current_trial).pp.data, 1)
1335                     cwt_struct = cwtft(self.data(self.gui.current_trial).pp.data(i, :));
1336                     
1337                     rcwt = real(cwt_struct.cfs);
1338                     icwt = imag(cwt_struct.cfs);
1339                     
1340                     self.data(self.gui.current_trial).pp.cwt_data(i, :) = reshape([rcwt, icwt], 1, []);
1341                 <span class="keyword">end</span>
1342                 
1343                 <span class="comment">% @todo: other things with the wavelets, like removing</span>
1344                 <span class="comment">% frequencies etc. Things that can be done to cwt_data</span>
1345             <span class="keyword">end</span>
1346             
1347             <span class="comment">% Ok, so if we are doing the concat then restructure the data</span>
1348             <span class="keyword">if</span> isfield(self.data(1), <span class="string">'concat'</span>) <span class="comment">% @todo: some other flag</span>
1349                 <span class="comment">% Right, so put the all data together in the concat struct,</span>
1350                 <span class="comment">% and then split the data back to the trials.</span>
1351                 
1352                 self.data(1).concat.pp_im_data = self.data(self.gui.current_trial).pp.im_data;
1353                 self.data(1).concat.pp_im_x = self.data(self.gui.current_trial).pp.im_x;
1354                 self.data(1).concat.pp_im_y = self.data(self.gui.current_trial).pp.im_y;
1355                 self.data(1).concat.pp_im_z = self.data(self.gui.current_trial).pp.im_z;
1356                 
1357                 frame_ids = self.data(1).concat.frame_ids;
1358                 frame_ids(1:zs_remove) = [];
1359                 frame_ids((end-zs_remove):end) = [];
1360                 self.data(1).concat.pp_frame_ids = frame_ids(zidx);
1361                 
1362                 <span class="comment">% so frame_ids should be the same length as im_z</span>
1363                 assert(length(self.data(1).concat.pp_frame_ids) == length(self.data(1).concat.pp_im_z));
1364                 
1365                 <span class="comment">% @todo: if you're using the wavelets more stuff has to</span>
1366                 <span class="comment">% happen.</span>
1367                 
1368                 <span class="keyword">for</span> i = 1:length(self.data)
1369                     <span class="comment">% Ok, so now we need to split the im_data...</span>
1370                     idx = find(self.data(1).concat.pp_frame_ids == i);
1371                     
1372                     self.data(i).pp.im_data = self.data(1).concat.pp_im_data(:,:,idx);
1373                     self.data(i).pp.im_x = self.data(1).concat.pp_im_x;
1374                     self.data(i).pp.im_y = self.data(1).concat.pp_im_y;
1375                     self.data(i).pp.im_z = self.data(1).concat.pp_im_z(idx);
1376                 <span class="keyword">end</span>
1377             <span class="keyword">end</span>
1378             
1379             <span class="comment">%%% I'm going ot hack in a filter here to test</span>
1380             <span class="comment">%hd = load('icp_filter.mat');</span>
1381             <span class="comment">%data = self.data(self.gui.current_trial).pp.data - repmat(mean(self.data(self.gui.current_trial).pp.data, 2), 1, size(self.data(self.gui.current_trial).pp.data, 2));</span>
1382             <span class="comment">%self.data(self.gui.current_trial).pp.data = filter(hd.Hd, data')';</span>
1383             <span class="comment">%%%</span>
1384             
1385             self.data(self.gui.current_trial).stage = self.PreProcessingStage;
1386             
1387             self.gui.d(self.gui.current_trial).last_display = 0;
1388             self.update();
1389         <span class="keyword">end</span>
1390         
1391         <a name="_sub65" href="#_subfunctions" class="code">function run_pca(self)</a>
1392             <span class="comment">% run_pca(self): Runs the pca stage of the analysis.</span>
1393             
1394             disp(<span class="string">'run_pca'</span>);
1395             
1396             <span class="comment">% @todo: checks on state</span>
1397             <span class="keyword">if</span> self.data(self.gui.current_trial).stage == self.InitStage
1398                 disp(<span class="string">'Running previous stage...'</span>);
1399                 self.run_preprocessing();
1400             <span class="keyword">end</span>
1401             
1402             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Running PCA...'</span>);
1403             drawnow;
1404             
1405             s = self.data(self.gui.current_trial).settings.pca;
1406             
1407             <span class="keyword">if</span> isfield(self.data(1), <span class="string">'concat'</span>) &amp;&amp; isfield(self.data(1).concat, <span class="string">'pp_im_data'</span>) <span class="comment">% @todo: another flag?</span>
1408                 disp(<span class="string">'concat pca'</span>);
1409                 
1410                 d = reshape(self.data(1).concat.pp_im_data, [], size(self.data(1).concat.pp_im_data, 3))';
1411                 
1412                 <span class="keyword">if</span> exist(<span class="string">'pca'</span>) == 2
1413                     [scores, pcs, eigs] = pca(d);
1414                 <span class="keyword">else</span>
1415                     [scores, pcs, eigs] = princomp(d);
1416                 <span class="keyword">end</span>
1417                 
1418                 self.data(1).concat.pca_scores = scores;
1419                 self.data(1).concat.pca_pcs = pcs;
1420                 self.data(1).concat.pca_eigs = eigs;
1421                 self.data(1).concat.pca_im_data = reshape(self.data(1).concat.pca_scores, <span class="keyword">...</span>
1422                     size(self.data(1).concat.pp_im_data,1), size(self.data(1).concat.pp_im_data,2), size(self.data(1).concat.pca_scores, 2));
1423                 
1424                 <span class="keyword">for</span> i = 1:length(self.data)
1425                     self.data(i).pca.scores = self.data(1).concat.pca_scores;
1426                     self.data(i).pca.im_data = self.data(1).concat.pca_im_data;
1427                     self.data(i).pca.eigs = self.data(1).concat.pca_eigs;
1428                     self.data(i).pca.im_x = self.data(1).concat.pp_im_x;
1429                     self.data(i).pca.im_y = self.data(1).concat.pp_im_y;
1430                     
1431                     idx = self.data(1).concat.pp_frame_ids == i;
1432                     self.data(i).pca.pcs = self.data(1).concat.pca_pcs(idx, :);
1433                 <span class="keyword">end</span>
1434                 
1435             <span class="keyword">else</span>
1436                 <span class="keyword">if</span> self.data(self.gui.current_trial).pp.use_wavelets
1437                     <span class="keyword">if</span> s.corr_pca == 1
1438                         d = zscore(self.data(self.gui.current_trial).pp.cwt_data');
1439                     <span class="keyword">else</span>
1440                         d = self.data(self.gui.current_trial).pp.cwt_data';
1441                     <span class="keyword">end</span>
1442                     
1443                     <span class="keyword">if</span> exist(<span class="string">'pca'</span>) == 2
1444                         [scores, pcs, eigs] = pca(d);
1445                     <span class="keyword">else</span>
1446                         [scores, pcs, eigs] = princomp(d);
1447                     <span class="keyword">end</span>
1448                     
1449                     <span class="comment">% Reconstruct the original data from wavelets</span>
1450                     cwt_struct = self.data(self.gui.current_trial).pp.cwt_struct;
1451                     num_frames = size(self.data(self.gui.current_trial).pp.data, 2);
1452                     wavelet_rec = zeros(num_frames, size(pcs, 2));
1453                     <span class="keyword">for</span> i = 1:size(pcs, 2)
1454                         pc_cfs = reshape(pcs(:,i), length(cwt_struct.scales), []);
1455                         cwt_struct.cfs = complex(pc_cfs(:, 1:num_frames), pc_cfs(:, (num_frames+1):end));
1456                         
1457                         wavelet_rec(:, i) = icwtft(cwt_struct);
1458                     <span class="keyword">end</span>
1459                     self.data(self.gui.current_trial).pca.pc_rec = wavelet_rec;
1460                 <span class="keyword">else</span>
1461                     <span class="keyword">if</span> s.corr_pca == 1
1462                         d = zscore(self.data(self.gui.current_trial).pp.data');
1463                     <span class="keyword">else</span>
1464                         d = self.data(self.gui.current_trial).pp.data';
1465                     <span class="keyword">end</span>
1466                     
1467                     <span class="keyword">if</span> exist(<span class="string">'pca'</span>) == 2
1468                         [scores, pcs, eigs] = pca(d);
1469                     <span class="keyword">else</span>
1470                         [scores, pcs, eigs] = princomp(d);
1471                     <span class="keyword">end</span>
1472                 <span class="keyword">end</span>
1473                 
1474                 self.data(self.gui.current_trial).pca.scores = scores;
1475                 self.data(self.gui.current_trial).pca.pcs = pcs;
1476                 self.data(self.gui.current_trial).pca.eigs = eigs;
1477                 
1478                 
1479                 self.data(self.gui.current_trial).pca.im_data = reshape(self.data(self.gui.current_trial).pca.scores, <span class="keyword">...</span>
1480                     size(self.data(self.gui.current_trial).pp.im_data,1), size(self.data(self.gui.current_trial).pp.im_data,2), size(self.data(self.gui.current_trial).pca.scores, 2));
1481                 
1482                 self.data(self.gui.current_trial).pca.im_x = self.data(self.gui.current_trial).pp.im_x;
1483                 self.data(self.gui.current_trial).pca.im_y = self.data(self.gui.current_trial).pp.im_y;
1484             <span class="keyword">end</span>
1485             
1486             self.data(self.gui.current_trial).stage = self.PcaStage;
1487             self.gui.d(self.gui.current_trial).last_display = 0;
1488             self.update();
1489         <span class="keyword">end</span>
1490         
1491         <a name="_sub66" href="#_subfunctions" class="code">function run_ica(self)</a>
1492             <span class="comment">% run_ica(self): Runs the ica stage of the analysis.</span>
1493             
1494             disp(<span class="string">'run_ica'</span>);
1495             
1496             <span class="comment">% @todo: checks on state.</span>
1497             <span class="keyword">if</span> self.data(self.gui.current_trial).stage == self.InitStage || self.data(self.gui.current_trial).stage == self.PreProcessingStage
1498                 disp(<span class="string">'Running previous stages...'</span>);
1499                 self.run_pca();
1500             <span class="keyword">end</span>
1501             
1502             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Running ICA...'</span>);
1503             drawnow;
1504             
1505             s = self.data(self.gui.current_trial).settings.ica;
1506             
1507             <span class="comment">% Make sure that the pcs requested are in range.</span>
1508             which_pcs = s.which_pcs;
1509             which_pcs(which_pcs &gt; size(self.data(self.gui.current_trial).pca.scores, 2)) = [];
1510             
1511             <span class="keyword">if</span> strcmp(s.ica_func, <span class="string">'CellsortICA'</span>)
1512                 disp(<span class="string">'Running CellsortICA'</span>);
1513                 [ics, im_data, A, niter] = CellsortICA(self.data(self.gui.current_trial).pca.pcs(:, which_pcs)', <span class="keyword">...</span>
1514                     self.data(self.gui.current_trial).pca.im_data(:, :, which_pcs), self.data(self.gui.current_trial).pca.eigs(which_pcs), [], s.mu);
1515                 
1516                 self.data(self.gui.current_trial).ica.ics = ics';
1517                 self.data(self.gui.current_trial).ica.im_data = shiftdim(im_data, 1);
1518                 self.data(self.gui.current_trial).ica.A = A;
1519                 self.data(self.gui.current_trial).ica.scores = reshape(self.data(self.gui.current_trial).ica.im_data, [], size(self.data(self.gui.current_trial).ica.im_data, 3));
1520                 
1521             <span class="keyword">elseif</span> strcmp(s.ica_func, <span class="string">'fastica'</span>)
1522                 disp(<span class="string">'Running fastica'</span>);
1523                 
1524                 <span class="keyword">if</span> s.init_guess == -1
1525                     <span class="comment">% This means that the init guess should be the previous A</span>
1526                     <span class="comment">% matrix.</span>
1527                     <span class="keyword">if</span> isfield(self.data(self.gui.current_trial).ica, <span class="string">'A'</span>) &amp;&amp; size(self.data(self.gui.current_trial).ica.A, 1) == length(which_pcs)
1528                         <span class="comment">% Then the last A matrix is valid.</span>
1529                         [icasig, A, W] = fastica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)', <span class="string">'initGuess'</span>, self.data(self.gui.current_trial).ica.A);
1530                     <span class="keyword">else</span>
1531                         <span class="comment">% Then the last A matrix is invalid.</span>
1532                         disp(<span class="string">'Could not use previous A as initial guess.'</span>);
1533                         [icasig, A, W] = fastica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)');
1534                     <span class="keyword">end</span>
1535                 <span class="keyword">elseif</span> s.init_guess == 0
1536                     <span class="comment">% Then we just use the normal random guess.</span>
1537                     <span class="comment">%%%</span>
1538                     <span class="comment">%[icasig, A, W] = fastica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)');</span>
1539                     <span class="comment">%%% Messing around with the other fastica params</span>
1540                     disp(<span class="string">'fastica params'</span>);
1541                     [icasig, A, W] = fastica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)', <span class="string">'g'</span>, <span class="string">'tanh'</span>, <span class="string">'a1'</span>, 3, <span class="string">'stabilization'</span>, <span class="string">'on'</span>);
1542                     <span class="comment">%%%</span>
1543                 <span class="keyword">else</span>
1544                     <span class="comment">% Then s.init_guess should be the A matrix itself.</span>
1545                     <span class="keyword">if</span> size(s.init_guess, 1) == length(which_pcs)
1546                         disp(<span class="string">'Using Init Guess'</span>);
1547                         [icasig, A, W] = fastica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)', <span class="string">'initGuess'</span>, s.init_guess);
1548                     <span class="keyword">else</span>
1549                         disp(<span class="string">'Initial Guess incorrectly formatted.'</span>);
1550                         [icasig, A, W] = fastica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)');
1551                     <span class="keyword">end</span>
1552                 <span class="keyword">end</span>
1553                 
1554                 self.data(self.gui.current_trial).ica.scores = icasig';
1555                 
1556                 <span class="keyword">if</span> s.positive_skew
1557                     <span class="comment">% Then we want the component scores to all skew positively.</span>
1558                     is_neg_skew = skewness(self.data(self.gui.current_trial).ica.scores) &lt; 0;
1559                     self.data(self.gui.current_trial).ica.scores(:, is_neg_skew) = -self.data(self.gui.current_trial).ica.scores(:, is_neg_skew);
1560                     A(:, is_neg_skew) = -A(:, is_neg_skew);
1561                 <span class="keyword">end</span>
1562                 
1563                 self.data(self.gui.current_trial).ica.A = A;
1564                 self.data(self.gui.current_trial).ica.W = W;
1565                 ics = self.data(self.gui.current_trial).pca.pcs(:, which_pcs) * A;
1566                 
1567                 <span class="keyword">if</span> self.data(self.gui.current_trial).pp.use_wavelets
1568                     <span class="comment">% Reconstruct the original data from wavelets</span>
1569                     cwt_struct = self.data(self.gui.current_trial).pp.cwt_struct;
1570                     num_frames = size(self.data(self.gui.current_trial).pp.data, 2);
1571                     wavelet_rec = zeros(num_frames, size(ics, 2));
1572                     <span class="keyword">for</span> i = 1:size(ics, 2)
1573                         ic_cfs = reshape(ics(:,i), length(cwt_struct.scales), []);
1574                         cwt_struct.cfs = complex(ic_cfs(:, 1:num_frames), ic_cfs(:, (num_frames+1):end));
1575                         
1576                         wavelet_rec(:, i) = icwtft(cwt_struct);
1577                     <span class="keyword">end</span>
1578                     self.data(self.gui.current_trial).ica.ics = wavelet_rec;
1579                 <span class="keyword">else</span>
1580                     self.data(self.gui.current_trial).ica.ics = ics;
1581                 <span class="keyword">end</span>
1582                 
1583                 self.data(self.gui.current_trial).ica.im_data = reshape(self.data(self.gui.current_trial).ica.scores, <span class="keyword">...</span>
1584                     size(self.data(self.gui.current_trial).pp.im_data,1), size(self.data(self.gui.current_trial).pp.im_data,2), size(self.data(self.gui.current_trial).ica.scores, 2));
1585             <span class="keyword">elseif</span> strcmp(s.ica_func, <span class="string">'TreeICA'</span>)
1586                 
1587             <span class="keyword">elseif</span> strcmp(s.ica_func, <span class="string">'RadICAl'</span>)
1588                 
1589             <span class="keyword">elseif</span> strcmp(s.ica_func, <span class="string">'KernelICA'</span>)
1590                 disp(<span class="string">'Running Kernel ICA'</span>);
1591                 tic;
1592                 W = kernel_ica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)');
1593                 
1594                 self.data(self.gui.current_trial).ica.scores = (W * self.data(self.gui.current_trial).pca.scores(:, which_pcs)')';
1595                 self.data(self.gui.current_trial).ica.ics = self.data(self.gui.current_trial).pca.pcs(:, which_pcs) / W;
1596                 
1597                 self.data(self.gui.current_trial).ica.im_data = reshape(self.data(self.gui.current_trial).ica.scores, <span class="keyword">...</span>
1598                     size(self.data(self.gui.current_trial).pp.im_data,1), size(self.data(self.gui.current_trial).pp.im_data, 2), size(self.data(self.gui.current_trial).ica.scores, 2));
1599                 
1600                 toc;
1601             <span class="keyword">elseif</span> strcmp(s.ica_func, <span class="string">'imageica'</span>)
1602                 
1603             <span class="keyword">elseif</span> strcmp(s.ica_func, <span class="string">'icasso'</span>)
1604                 
1605             <span class="keyword">elseif</span> strcmp(s.ica_func, <span class="string">'fourierica'</span>)
1606                 [S_Ft, A, W] = fourierica(self.data(self.gui.current_trial).pca.scores(:, which_pcs)', length(which_pcs), 50, 0, 20);
1607                 
1608                 self.data(self.gui.current_trial).ica.scores = (W * self.data(self.gui.current_trial).pca.scores(:, which_pcs)')';
1609                 self.data(self.gui.current_trial).ica.ics = self.data(self.gui.current_trial).pca.pcs(:, which_pcs) * A;
1610                 
1611                 self.data(self.gui.current_trial).ica.im_data = reshape(self.data(self.gui.current_trial).ica.scores, <span class="keyword">...</span>
1612                     size(self.data(self.gui.current_trial).pp.im_data,1), size(self.data(self.gui.current_trial).pp.im_data, 2), size(self.data(self.gui.current_trial).ica.scores, 2));
1613             <span class="keyword">else</span>
1614                 error(<span class="string">'Incorrect ICA function'</span>);
1615             <span class="keyword">end</span>
1616             self.data(self.gui.current_trial).ica.im_x = self.data(self.gui.current_trial).pca.im_x;
1617             self.data(self.gui.current_trial).ica.im_y = self.data(self.gui.current_trial).pca.im_y;
1618             
1619             <span class="keyword">if</span> isfield(self.data(1), <span class="string">'concat'</span>) &amp;&amp; isfield(self.data(1).concat, <span class="string">'pca_pcs'</span>)
1620                 <span class="comment">% OK, so we just do the ica on the scores, so now can get</span>
1621                 <span class="comment">% the ics for all of the rest of the trials by multiplying</span>
1622                 <span class="comment">% by the pcs</span>
1623                 disp(<span class="string">'ica concatenated trials'</span>);
1624                 A = self.data(self.gui.current_trial).ica.A;
1625                 W =  self.data(self.gui.current_trial).ica.W;
1626                 ics = self.data(self.gui.current_trial).pca.pcs(:, which_pcs) * A;
1627                 im_data = self.data(self.gui.current_trial).ica.im_data;
1628                 scores = self.data(self.gui.current_trial).ica.scores;
1629                 
1630                 <span class="keyword">for</span> i = 1:length(self.data)
1631                     
1632                     self.data(i).ica.im_data = im_data;
1633                     self.data(i).ica.ics = self.data(i).pca.pcs(:, which_pcs) * A;
1634                     self.data(i).ica.A = A;
1635                     
1636                 <span class="keyword">end</span>
1637             <span class="keyword">end</span>
1638             
1639             self.data(self.gui.current_trial).stage = self.IcaStage;
1640             self.gui.d(self.gui.current_trial).last_display = 0;
1641             self.update();
1642         <span class="keyword">end</span>
1643         
1644         <a name="_sub67" href="#_subfunctions" class="code">function run_segmentation(self)</a>
1645             <span class="comment">% run_segmentation(self): Runs the segmentation algorithm on</span>
1646             <span class="comment">% the ICs.</span>
1647             <span class="comment">%</span>
1648             <span class="comment">% This looks for ic components that are spatially localized.</span>
1649             
1650             <span class="keyword">if</span> self.data(self.gui.current_trial).stage &lt; self.IcaStage
1651                 disp(<span class="string">'Run ICA first'</span>);
1652                 <span class="keyword">return</span>;
1653             <span class="keyword">end</span>
1654             
1655             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Running Segmentation...'</span>);
1656             drawnow;
1657             
1658             thresh = self.data(self.gui.current_trial).settings.segment.thresh;
1659             down_size = 1./self.data(self.gui.current_trial).settings.segment.down_size;
1660             min_area = self.data(self.gui.current_trial).settings.segment.min_area;
1661             
1662             [segment_masks, segment_info] = <a href="segment_ics.html" class="code" title="function [segment_masks, segment_info] = segment_ics(comp, thresh, down_size, min_area)">segment_ics</a>(self.data(self.gui.current_trial).ica.im_data, <span class="keyword">...</span>
1663                 thresh, down_size, min_area);
1664             
1665             <span class="comment">% Make segment masks for each IC</span>
1666             im_data = zeros(size(self.data(self.gui.current_trial).ica.im_data));
1667             <span class="keyword">for</span> i = 1:size(self.data(self.gui.current_trial).ica.im_data, 3)
1668                 <span class="comment">% Ok, make the im data all the masks for 1 segment.</span>
1669                 idxs = find(segment_info.ic_ids == i);
1670                 <span class="keyword">if</span> isempty(idxs)
1671                     <span class="comment">% Then we didn't get anything out of a segment, which</span>
1672                     <span class="comment">% shouldn't happen...</span>
1673                     disp([<span class="string">'No segments! '</span> num2str(i)]);
1674                     <span class="keyword">continue</span>;
1675                 <span class="keyword">end</span>
1676                 
1677                 im_sum = zeros(size(segment_masks(:,:,idxs(1))));
1678                 
1679                 pos_idxs = find(segment_info.is_pos(idxs));
1680                 neg_idxs = find(~segment_info.is_pos(idxs));
1681                 <span class="keyword">for</span> j = 1:length(pos_idxs)
1682                     im_sum = im_sum + j * segment_masks(:,:,idxs(pos_idxs(j)));
1683                 <span class="keyword">end</span>
1684                 <span class="keyword">for</span> j = 1:length(neg_idxs)
1685                     im_sum = im_sum - j * segment_masks(:,:,idxs(neg_idxs(j)));
1686                 <span class="keyword">end</span>
1687                 
1688                 im_data(:,:,i) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_sum);
1689             <span class="keyword">end</span>
1690             
1691             <span class="comment">% Now need to fix the rois</span>
1692             im_x = self.data(self.gui.current_trial).ica.im_x;
1693             im_y = self.data(self.gui.current_trial).ica.im_y;
1694             segment_info.rois(:, 1) = interp1(1:size(segment_masks, 2), im_x, segment_info.rois(:, 1));
1695             segment_info.rois(:, 2) = interp1(1:size(segment_masks, 1), im_y, segment_info.rois(:, 2));
1696             segment_info.rois(:, 3) = mean(diff(im_x)) * segment_info.rois(:, 3) ./ sqrt(2);
1697             segment_info.rois(:, 4) = mean(diff(im_y)) * segment_info.rois(:, 4) ./ sqrt(2);
1698             
1699             self.data(self.gui.current_trial).segment.im_data = im_data;
1700             self.data(self.gui.current_trial).segment.im_x = self.data(self.gui.current_trial).ica.im_x;
1701             self.data(self.gui.current_trial).segment.im_y = self.data(self.gui.current_trial).ica.im_y;
1702             self.data(self.gui.current_trial).segment.segment_info = segment_info;
1703             
1704             self.create_new_roi_set(<span class="string">'Segment_ROIs'</span>, true);
1705             self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set} = segment_info.rois;
1706             
1707             self.h.roi_editor.set_rois(self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set}, false);
1708             
1709             self.update();
1710             
1711             
1712             self.data(self.gui.current_trial).stage = self.PostProcessingStage;
1713             
1714             self.gui.d(self.gui.current_trial).last_display = 0;
1715             self.update();
1716         <span class="keyword">end</span>
1717         
1718         <a name="_sub68" href="#_subfunctions" class="code">function run_visualization(self)</a>
1719             <span class="comment">% run_visualization(self): computes ica visualizations.</span>
1720             
1721             disp(<span class="string">'run_visualization'</span>);
1722             
1723             <span class="keyword">if</span> self.data(self.gui.current_trial).stage &lt; self.IcaStage
1724                 disp(<span class="string">'Run ICA first'</span>);
1725                 <span class="keyword">return</span>;
1726             <span class="keyword">end</span>
1727             
1728             colors = <a href="viz_function.html" class="code" title="function colors = viz_function(icp)">viz_function</a>(self);
1729             self.set_viz_colors(colors);
1730         <span class="keyword">end</span>
1731         
1732         <a name="_sub69" href="#_subfunctions" class="code">function set_viz_colors(self, colors);</a>
1733             <span class="comment">% set_viz_colors(self, colors): sets the colors for each IC for</span>
1734             <span class="comment">% the visualization.</span>
1735             <span class="comment">%</span>
1736             <span class="comment">% So whatever the function, there should be 1 color per IC. The</span>
1737             <span class="comment">% color is taken as RGB, it can just be a scalar, or it can be</span>
1738             <span class="comment">% RGBA (alpha).</span>
1739             
1740             s = self.data(self.gui.current_trial).settings.viz;
1741             
1742             self.data(self.gui.current_trial).viz.colors = colors;
1743             
1744             self.data(self.gui.current_trial).stage = self.PostProcessingStage;
1745             
1746             self.draw_component_viz();
1747         <span class="keyword">end</span>
1748         
1749         <a name="_sub70" href="#_subfunctions" class="code">function rois = calc_rois(self)</a>
1750             <span class="comment">% calc_rois(self): calculates the ROIs from the independent</span>
1751             <span class="comment">% components.</span>
1752             
1753             <span class="keyword">if</span> self.data(self.gui.current_trial).stage &lt; self.IcaStage
1754                 disp(<span class="string">'Run ICA first'</span>);
1755                 <span class="keyword">return</span>;
1756             <span class="keyword">end</span>
1757             
1758             
1759             rois = self.data(self.gui.current_trial).settings.segment.calc_rois_func(self.data(self.gui.current_trial).ica.im_data, self.data(self.gui.current_trial).ica.im_x, self.data(self.gui.current_trial).ica.im_y);
1760             
1761             self.create_new_roi_set(<span class="string">'IC_Generated_ROIs'</span>, true);
1762             self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set} = rois;
1763             
1764             self.h.roi_editor.set_rois(self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set}, false);
1765             
1766             self.update();
1767             
1768         <span class="keyword">end</span>
1769         
1770         <a name="_sub71" href="#_subfunctions" class="code">function estimate_clusters(self)</a>
1771             disp(<span class="string">'estimate_clusters'</span>);
1772             
1773             <span class="keyword">if</span> self.data(self.gui.current_trial).stage &lt; self.IcaStage
1774                 disp(<span class="string">'Run ICA first'</span>);
1775                 <span class="keyword">return</span>;
1776             <span class="keyword">end</span>
1777             
1778             <span class="comment">% We need rois specifically for clustering.</span>
1779             <span class="keyword">if</span> self.data(self.gui.current_trial).is_component_set(self.gui.d(self.gui.current_trial).current_roi_set)
1780                 self.data(self.gui.current_trial).cluster.rois = self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set};
1781             <span class="keyword">else</span>
1782                 self.data(self.gui.current_trial).cluster.rois = self.calc_rois();
1783             <span class="keyword">end</span>
1784             
1785             s = self.data(self.gui.current_trial).settings.cluster;
1786             
1787             [feature_matrix, feature_weights] = s.feature_matrix_func(self.data(self.gui.current_trial).ica.ics, self.data(self.gui.current_trial).ica.im_data);
1788             
1789             self.data(self.gui.current_trial).cluster.feature_matrix = feature_matrix;
1790             self.data(self.gui.current_trial).cluster.feature_weights = feature_weights;
1791             
1792             self.data(self.gui.current_trial).cluster.similarity_matrix = s.calc_sim_matrix_func(self.data(self.gui.current_trial).cluster.feature_weights, self.data(self.gui.current_trial).cluster.feature_matrix);
1793             
1794             [self.data(self.gui.current_trial).cluster.im_data, top3] = s.visualization_func(self.data(self.gui.current_trial).cluster.similarity_matrix, self.data(self.gui.current_trial).ica.im_data);
1795             
1796             self.data(self.gui.current_trial).cluster.im_x = self.data(self.gui.current_trial).ica.im_x;
1797             self.data(self.gui.current_trial).cluster.im_y = self.data(self.gui.current_trial).ica.im_y;
1798             
1799             self.data(self.gui.current_trial).cluster.top3 = top3;
1800             
1801             <span class="comment">%%% Not sure how/when to set this</span>
1802             self.data(self.gui.current_trial).cluster.cluster_matrix = zeros(size(self.data(self.gui.current_trial).cluster.similarity_matrix));
1803             <span class="comment">% THis is just a hack for testing</span>
1804             self.data(self.gui.current_trial).cluster.cluster_matrix(1, 5) = 1;
1805             self.data(self.gui.current_trial).cluster.cluster_matrix(2, [10, 20]) = 1;
1806             <span class="comment">%%%</span>
1807             
1808             self.data(self.gui.current_trial).stage = self.PostProcessingStage;
1809             self.update();
1810         <span class="keyword">end</span>
1811         
1812         <a name="_sub72" href="#_subfunctions" class="code">function load_settings(self, filename)</a>
1813             <span class="comment">% load_settings(self, filename): loads settings from a saved</span>
1814             <span class="comment">% file.</span>
1815             
1816             disp(<span class="string">'load_settings'</span>);
1817         <span class="keyword">end</span>
1818         
1819         <a name="_sub73" href="#_subfunctions" class="code">function save_settings(self, filename)</a>
1820             <span class="comment">% save_settings(self, filename): saves the settings to a file.</span>
1821             disp(<span class="string">'save_settings'</span>);
1822         <span class="keyword">end</span>
1823         
1824         <a name="_sub74" href="#_subfunctions" class="code">function edit_preprocessing_settings(self)</a>
1825             <span class="comment">% edit_preprocessing_settings(self): shows the edit</span>
1826             <span class="comment">% preprocessing settings dialog.</span>
1827             
1828             self.h.pp_dialog = dialog(<span class="string">'Name'</span>, <span class="string">'Edit Preprocessing Settings'</span>, <span class="string">'Units'</span>, <span class="string">'pixels'</span>);
1829             
1830             self.h.pp_main_vbox = uiextras.VBox(<span class="string">'Parent'</span>, self.h.pp_dialog, <span class="keyword">...</span>
1831                 <span class="string">'Spacing'</span>, self.gui.MARGIN, <span class="string">'Padding'</span>, self.gui.MARGIN);
1832             self.h.pp_settings_grid = uiextras.Grid(<span class="string">'Parent'</span>, self.h.pp_main_vbox, <span class="string">'Spacing'</span>, self.gui.MARGIN);
1833             self.h.pp_button_hbox = uiextras.HButtonBox(<span class="string">'Parent'</span>, self.h.pp_main_vbox, <span class="string">'Spacing'</span>, self.gui.MARGIN);
1834             
1835             <span class="comment">% The order of these matters, as they are added to the grid</span>
1836             <span class="comment">% based on the order.</span>
1837             <span class="comment">% First column</span>
1838             uiextras.Empty(<span class="string">'Parent'</span>, self.h.pp_settings_grid);
1839             self.h.pp_smooth_label = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1840                 <span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Smooth Window:'</span>, <span class="string">'TooltipString'</span>, <span class="keyword">...</span>
1841                 <span class="string">'Sets dimensions of smooth window - MxNxT'</span>, <span class="keyword">...</span>
1842                 <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);
1843             self.h.pp_down_label = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1844                 <span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'Down Sampling:'</span>, <span class="string">'TooltipString'</span>, <span class="keyword">...</span>
1845                 <span class="string">'Sets the down sampling in each dimensoin - MxNxT'</span>, <span class="keyword">...</span>
1846                 <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);
1847             <span class="comment">% Second column</span>
1848             self.h.pp_M_label = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1849                 <span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'M'</span>, <span class="string">'TooltipString'</span>, <span class="keyword">...</span>
1850                 <span class="string">'M corresponds to the rows of the image (vertical)'</span>);
1851             self.h.pp_smooth_M = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1852                 <span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'String'</span>, self.data(self.gui.current_trial).settings.preprocessing.smooth_window(1));
1853             self.h.pp_down_M = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid,<span class="keyword">...</span>
1854                 <span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'String'</span>, self.data(self.gui.current_trial).settings.preprocessing.down_sample(1));
1855             
1856             <span class="comment">% Third column</span>
1857             self.h.pp_N_label = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1858                 <span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'N'</span>, <span class="string">'TooltipString'</span>, <span class="keyword">...</span>
1859                 <span class="string">'N corresponds to the columns of th eimage (horizontal)'</span>);
1860             self.h.pp_smooth_N = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1861                 <span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'String'</span>, self.data(self.gui.current_trial).settings.preprocessing.smooth_window(2));
1862             self.h.pp_down_N = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1863                 <span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'String'</span>, self.data(self.gui.current_trial).settings.preprocessing.down_sample(2));
1864             
1865             <span class="comment">% Fourth column</span>
1866             self.h.pp_T_label = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1867                 <span class="string">'Style'</span>, <span class="string">'text'</span>, <span class="string">'String'</span>, <span class="string">'T'</span>, <span class="string">'TooltipString'</span>, <span class="keyword">...</span>
1868                 <span class="string">'T corresponds to the frames (depth)'</span>);
1869             self.h.pp_smooth_T = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1870                 <span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'String'</span>, self.data(self.gui.current_trial).settings.preprocessing.smooth_window(3));
1871             self.h.pp_down_T = uicontrol(<span class="string">'Parent'</span>, self.h.pp_settings_grid, <span class="keyword">...</span>
1872                 <span class="string">'Style'</span>, <span class="string">'edit'</span>, <span class="string">'String'</span>, self.data(self.gui.current_trial).settings.preprocessing.down_sample(3));
1873             
1874             
1875             self.h.pp_ok_button = uicontrol(<span class="string">'Parent'</span>, self.h.pp_button_hbox, <span class="keyword">...</span>
1876                 <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'String'</span>, <span class="string">'OK'</span>, <span class="string">'Callback'</span>, @self.pp_settings_ok_cb);
1877             self.h.pp_cancel_button = uicontrol(<span class="string">'Parent'</span>, self.h.pp_button_hbox, <span class="keyword">...</span>
1878                 <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'String'</span>, <span class="string">'Cancel'</span>, <span class="string">'Callback'</span>, @self.pp_settings_cancel_cb);
1879             
1880             set(self.h.pp_settings_grid, <span class="string">'ColumnSizes'</span>, [-1, 30, 30, 30], <span class="string">'RowSizes'</span>, [30, 30, 30]);
1881             set(self.h.pp_main_vbox, <span class="string">'Sizes'</span>, [-1, 30]);
1882             
1883             fh_pos = get(self.h.fh, <span class="string">'Position'</span>);
1884             set(self.h.pp_dialog, <span class="string">'Position'</span>, [fh_pos(1) + 100, fh_pos(2) + 100, 300, 200]);
1885         <span class="keyword">end</span>
1886         
1887         <a name="_sub75" href="#_subfunctions" class="code">function set_pp_smooth_window(self, smM, smN, smT)</a>
1888             <span class="comment">% set_smooth_window: sets the size of the smoothing convolution</span>
1889             <span class="comment">% window.</span>
1890             
1891             <span class="keyword">if</span> nargin == 2
1892                 <span class="comment">% Then the 3 values should all be in smM</span>
1893                 assert(length(smM) == 3);
1894                 smN = smM(2);
1895                 smT = smM(3);
1896                 smM = smM(1);
1897             <span class="keyword">elseif</span> nargin &lt; 2 || isempty(smM)
1898                 <span class="comment">% Default will be to leave unchanged.</span>
1899                 smM = NaN;
1900             <span class="keyword">elseif</span> nargin &lt; 3 || isempty(smN)
1901                 smN = NaN;
1902             <span class="keyword">elseif</span> nargin &lt; 4 || isempty(smT)
1903                 smT = NaN;
1904             <span class="keyword">end</span>
1905             
1906             <span class="comment">% Get the old values</span>
1907             sm_old = self.data(self.gui.current_trial).settings.preprocessing.smooth_window;
1908             
1909             <span class="comment">% Set the new values</span>
1910             self.data(self.gui.current_trial).settings.preprocessing.smooth_window = [smM, smN, smT];
1911             
1912             <span class="comment">% Check for bad values</span>
1913             nan_vals = isnan(self.data(self.gui.current_trial).settings.preprocessing.smooth_window) <span class="keyword">...</span>
1914                 | self.data(self.gui.current_trial).settings.preprocessing.smooth_window &lt; 0;
1915             <span class="keyword">if</span> any(nan_vals)
1916                 <span class="comment">% Then some of the values are bad/missing, use the old</span>
1917                 <span class="comment">% values.</span>
1918                 disp(<span class="string">'Some smooth window values bad/missing.'</span>);
1919                 self.data(self.gui.current_trial).settings.preprocessing.smooth_window(nan_vals) = sm_old(nan_vals);
1920             <span class="keyword">end</span>
1921         <span class="keyword">end</span>
1922         
1923         <a name="_sub76" href="#_subfunctions" class="code">function set_pp_down_sample(self, dsM, dsN, dsT)</a>
1924             <span class="comment">% set_down_sample: sets the size of the down sampling</span>
1925             
1926             <span class="keyword">if</span> nargin == 2
1927                 <span class="comment">% Then the 3 values should all be in smM</span>
1928                 assert(length(dsM) == 3);
1929                 dsN = dsM(2);
1930                 dsT = dsM(3);
1931                 dsM = dsM(1);
1932             <span class="keyword">elseif</span> nargin &lt; 2 || isempty(dsM)
1933                 <span class="comment">% Default will be to leave unchanged.</span>
1934                 dsM = NaN;
1935             <span class="keyword">elseif</span> nargin &lt; 3 || isempty(dsN)
1936                 dsN = NaN;
1937             <span class="keyword">elseif</span> nargin &lt; 4 || isempty(dsT)
1938                 dsT = NaN;
1939             <span class="keyword">end</span>
1940             
1941             <span class="comment">% Get the old values</span>
1942             ds_old = self.data(self.gui.current_trial).settings.preprocessing.down_sample;
1943             
1944             <span class="comment">% Set the new values</span>
1945             self.data(self.gui.current_trial).settings.preprocessing.down_sample = [dsM, dsN, dsT];
1946             
1947             <span class="comment">% Check for bad values</span>
1948             nan_vals = isnan(self.data(self.gui.current_trial).settings.preprocessing.down_sample) <span class="keyword">...</span>
1949                 | self.data(self.gui.current_trial).settings.preprocessing.down_sample &lt; 0;
1950             <span class="keyword">if</span> any(nan_vals)
1951                 <span class="comment">% Then some of the values are bad/missing, use the old</span>
1952                 <span class="comment">% values.</span>
1953                 disp(<span class="string">'Some down sample values bad/missing.'</span>);
1954                 self.data(self.gui.current_trial).settings.preprocessing.down_sample(nan_vals) = ds_old(nan_vals);
1955             <span class="keyword">end</span>
1956         <span class="keyword">end</span>
1957         
1958         <a name="_sub77" href="#_subfunctions" class="code">function edit_pca_settings(self)</a>
1959             
1960         <span class="keyword">end</span>
1961         
1962         <a name="_sub78" href="#_subfunctions" class="code">function edit_ica_settings(self)</a>
1963             <span class="comment">% edit_ica_settings(self): shows the edit ica settings dialog.</span>
1964             
1965             self.h.ica_dialog = dialog(<span class="string">'Name'</span>, <span class="string">'Edit Preprocessing Settings'</span>, <span class="string">'Units'</span>, <span class="string">'pixels'</span>);
1966             
1967         <span class="keyword">end</span>
1968         
1969         <a name="_sub79" href="#_subfunctions" class="code">function set.Parent(self, val)</a>
1970             disp(<span class="string">'Setting RoiEditor Parent'</span>);
1971             set(self.h.panel, <span class="string">'Parent'</span>, double(val))
1972         <span class="keyword">end</span>
1973         
1974         <a name="_sub80" href="#_subfunctions" class="code">function component = get_current_component(self)</a>
1975             <span class="comment">% Returns the currently selected component</span>
1976             component = [];
1977             f = self.h.roi_editor.current_frame;
1978             
1979             <span class="keyword">switch</span> self.data(self.gui.current_trial).stage
1980                 <span class="keyword">case</span> self.InitStage
1981                     <span class="keyword">return</span>
1982                 <span class="keyword">case</span> self.PreProcessingStage
1983                     <span class="keyword">return</span>
1984                 <span class="keyword">case</span> self.PcaStage
1985                     component = self.data(self.gui.current_trial).pca.pcs(:, f);
1986                     <span class="keyword">return</span>
1987                 <span class="keyword">case</span> self.IcaStage
1988                     component = self.data(self.gui.current_trial).ica.ics(:, f);
1989             <span class="keyword">end</span>
1990         <span class="keyword">end</span>
1991         
1992         <a name="_sub81" href="#_subfunctions" class="code">function lock_current_component(self)</a>
1993             <span class="comment">% self.lock_current_component:</span>
1994             
1995             <span class="comment">% ok so just get the whatever is plotted on the component axes</span>
1996             comp_lines = get(self.h.component_axes, <span class="string">'Children'</span>);
1997             
1998             <span class="keyword">for</span> i = 1:length(comp_lines)
1999                 <span class="keyword">if</span> ~ismember(comp_lines(i), self.gui.locked_components.handle_ids) <span class="keyword">...</span>
2000                         &amp;&amp; strcmp(get(comp_lines(i), <span class="string">'Type'</span>), <span class="string">'line'</span>)
2001                     <span class="comment">% Ok so we don't have this component, so add it to the</span>
2002                     <span class="comment">% list.</span>
2003                     idx = length(self.gui.locked_components.handle_ids) + 1;
2004                     
2005                     self.gui.locked_components.handle_ids(idx) = comp_lines(i);
2006                     self.gui.locked_components.xdata(:,idx) = get(comp_lines(i), <span class="string">'XData'</span>);
2007                     self.gui.locked_components.ydata(:,idx) = get(comp_lines(i), <span class="string">'YData'</span>);
2008                 <span class="keyword">end</span>
2009             <span class="keyword">end</span>
2010             
2011             self.update();
2012         <span class="keyword">end</span>
2013         
2014         <a name="_sub82" href="#_subfunctions" class="code">function clear_locked_components(self)</a>
2015             self.gui.locked_components.handle_ids = [];
2016             self.gui.locked_components.xdata = [];
2017             self.gui.locked_components.ydata = [];
2018             
2019             self.update();
2020         <span class="keyword">end</span>
2021         
2022         <a name="_sub83" href="#_subfunctions" class="code">function top_idxs = show_best_selected_components(self, rois)</a>
2023             <span class="comment">% This plots the top components with an roi</span>
2024             
2025             disp(<span class="string">'show_best_selected_components'</span>);
2026             
2027             <span class="keyword">if</span> isempty(rois)
2028                 <span class="comment">% Then nothing to plot.</span>
2029                 <span class="keyword">return</span>
2030             <span class="keyword">end</span>
2031             
2032             im_data = [];
2033             comp = [];
2034             im_x = [];
2035             im_y = [];
2036             
2037             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).display == 4 &amp;&amp; self.data(self.gui.current_trial).stage == self.IcaStage
2038                 <span class="comment">% Then view the ICs</span>
2039                 im_data = self.data(self.gui.current_trial).ica.im_data;
2040                 im_x = self.data(self.gui.current_trial).ica.im_x;
2041                 im_y = self.data(self.gui.current_trial).ica.im_y;
2042                 comp = self.data(self.gui.current_trial).ica.ics;
2043             <span class="keyword">elseif</span> self.gui.d(self.gui.current_trial).display == 3 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PcaStage
2044                 <span class="comment">% Then view the PCs</span>
2045                 im_data = self.data(self.gui.current_trial).pca.im_data;
2046                 im_x = self.data(self.gui.current_trial).pca.im_x;
2047                 im_y = self.data(self.gui.current_trial).pca.im_y;
2048                 comp = self.data(self.gui.current_trial).pca.pcs;
2049             <span class="keyword">elseif</span> self.data(self.gui.current_trial).stage == self.PcaStage
2050                 <span class="comment">% Then view the PCs</span>
2051                 im_data = self.data(self.gui.current_trial).pca.im_data;
2052                 im_x = self.data(self.gui.current_trial).pca.im_x;
2053                 im_y = self.data(self.gui.current_trial).pca.im_y;
2054                 comp = self.data(self.gui.current_trial).pca.pcs;
2055             <span class="keyword">elseif</span> self.data(self.gui.current_trial).stage == self.IcaStage
2056                 <span class="comment">% Then view the ICs</span>
2057                 im_data = self.data(self.gui.current_trial).ica.im_data;
2058                 im_x = self.data(self.gui.current_trial).ica.im_x;
2059                 im_y = self.data(self.gui.current_trial).ica.im_y;
2060                 comp = self.data(self.gui.current_trial).ica.ics;
2061             <span class="keyword">else</span>
2062                 <span class="keyword">return</span>;
2063             <span class="keyword">end</span>
2064             
2065             s = self.data(self.gui.current_trial).settings.visualize;
2066             
2067             top_idxs = [];
2068             top_vals = [];
2069             residuals = [];
2070             <span class="keyword">for</span> i = 1:size(rois, 1)
2071                 <span class="comment">% Lets just start with the center of the roi.</span>
2072                 cx = interp1(im_x, 1:size(im_data, 2), rois(i, 1), <span class="string">'nearest'</span>);
2073                 cy = interp1(im_y, 1:size(im_data, 1), rois(i, 2), <span class="string">'nearest'</span>);
2074                 
2075                 <span class="comment">% @todo: check if in the right range</span>
2076                 
2077                 <span class="comment">% Now get the 3 largest scores at the point</span>
2078                 point_data = squeeze(im_data(cy, cx, :));
2079                 
2080                 <span class="comment">%                 if s.best_selection_type == 0</span>
2081                 <span class="comment">%                     % Then use the data exactly</span>
2082                 <span class="comment">%</span>
2083                 <span class="comment">%                 elseif s.best_selection_type == 1</span>
2084                 <span class="comment">%                     % Use the absolute value</span>
2085                 <span class="comment">%                     point_data = abs(point_data);</span>
2086                 <span class="comment">%                 elseif s.best_selection_type == 2</span>
2087                 <span class="comment">%                     %</span>
2088                 <span class="comment">%                 end</span>
2089                 
2090                 [vals, sidx] = sort(point_data, 1, <span class="string">'descend'</span>);
2091                 
2092                 n_best = min(s.num_best_components, length(sidx));
2093                 top_idxs = sidx(1:n_best);
2094                 top_vals = vals(1:n_best);
2095                 
2096                 <span class="keyword">if</span> length(sidx &gt; n_best)
2097                     residual_idxs = sidx((n_best+1):end);
2098                     residuals(i,:) = sum(comp(:, residual_idxs) .* repmat(vals((n_best+1):end)', size(comp, 1), 1), 2);
2099                 <span class="keyword">end</span>
2100             <span class="keyword">end</span>
2101             
2102             [top_idxs, ia, ic] = unique(top_idxs);
2103             top_vals = top_vals(ia);
2104             
2105             cla(self.h.component_axes);
2106             legend(self.h.component_axes, <span class="string">'off'</span>);
2107             hold(self.h.component_axes, <span class="string">'all'</span>);
2108             
2109             <span class="comment">%             if isfield(self.h, 'component_labels')</span>
2110             <span class="comment">%                 delete(self.h.component_labels);</span>
2111             <span class="comment">%             end</span>
2112             
2113             self.h.component_labels = [];
2114             
2115             <span class="keyword">for</span> i = 1:length(top_idxs)
2116                 c = self.gui.locked_colors(mod(i-1, length(self.gui.locked_colors))+1, :);
2117                 
2118                 component = comp(:, top_idxs(i));
2119                 
2120                 <span class="keyword">if</span> ~s.norm_best_components
2121                     <span class="comment">% Then multiply the component by its value.</span>
2122                     component = component * top_vals(i);
2123                 <span class="keyword">end</span>
2124                 
2125                 plot(self.h.component_axes, component, <span class="string">'Color'</span>, c);
2126                 text_x = 0.95 - (length(top_idxs) + size(residuals, 1) - i) * 0.05;
2127                 self.h.component_labels(i) = text(text_x, 0.9, num2str(top_idxs(i)), <span class="keyword">...</span>
2128                     <span class="string">'Parent'</span>, self.h.component_axes, <span class="string">'Units'</span>, <span class="string">'normalized'</span>, <span class="keyword">...</span>
2129                     <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>, <span class="string">'UserData'</span>, top_idxs(i), <span class="keyword">...</span>
2130                     <span class="string">'Color'</span>, c, <span class="string">'ButtonDownFcn'</span>, @self.component_label_cb);
2131             <span class="keyword">end</span>
2132             
2133             <span class="keyword">if</span> s.show_residual
2134                 <span class="keyword">for</span> i = 1:size(residuals, 1)
2135                     c = self.gui.locked_colors(mod(i+length(top_idxs)-1, length(self.gui.locked_colors))+1, :);
2136                     
2137                     plot(self.h.component_axes, residuals(i,:), <span class="string">':'</span>, <span class="string">'Color'</span>, c);
2138                     text_x = 0.95 - (size(residuals, 1) - i) * 0.05;
2139                     self.h.component_labels(i) = text(text_x, 0.9, <span class="string">'res'</span>, <span class="keyword">...</span>
2140                         <span class="string">'Parent'</span>, self.h.component_axes, <span class="string">'Units'</span>, <span class="string">'normalized'</span>, <span class="keyword">...</span>
2141                         <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>, <span class="keyword">...</span>
2142                         <span class="string">'Color'</span>, c, <span class="string">'ButtonDownFcn'</span>, @self.component_label_cb);
2143                 <span class="keyword">end</span>
2144             <span class="keyword">end</span>
2145             
2146             <span class="comment">%self.h.lh = legend(self.h.component_axes, 'show');</span>
2147         <span class="keyword">end</span>
2148         
2149         <a name="_sub84" href="#_subfunctions" class="code">function create_new_roi_set(self, name, is_component_set)</a>
2150             <span class="comment">% create_new_roi_set(self, name): creates a new roi set.</span>
2151             
2152             disp(<span class="string">'create_new_roi_set'</span>);
2153             
2154             <span class="keyword">if</span> nargin &lt; 3 || isempty(is_component_set)
2155                 is_component_set = false;
2156             <span class="keyword">end</span>
2157             
2158             <span class="keyword">if</span> nargin &lt; 2 || isempty(name)
2159                 <span class="comment">% Then prompt for a name for the roi set.</span>
2160                 name = inputdlg(<span class="string">'Enter name for ROI set:'</span>);
2161                 name = name{1};
2162             <span class="keyword">end</span>
2163             
2164             <span class="keyword">if</span> isempty(name)
2165                 <span class="comment">% Then at this point it was canceled</span>
2166                 <span class="keyword">return</span>;
2167             <span class="keyword">end</span>
2168             
2169             <span class="comment">% @todo: other checks on name</span>
2170             
2171             <span class="comment">% Add a new empty set of rois.</span>
2172             self.data(self.gui.current_trial).rois{end+1} = [];
2173             
2174             self.data(self.gui.current_trial).roi_names{length(self.data(self.gui.current_trial).rois)} = name;
2175             self.data(self.gui.current_trial).is_component_set(length(self.data(self.gui.current_trial).rois)) = is_component_set;
2176             
2177             self.gui.d(self.gui.current_trial).current_roi_set = length(self.data(self.gui.current_trial).rois);
2178             
2179             self.h.roi_editor.set_rois(self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set});
2180             
2181             <span class="keyword">if</span> is_component_set
2182                 self.h.roi_editor.disable_roi_editing();
2183             <span class="keyword">else</span>
2184                 self.h.roi_editor.enable_roi_editing();
2185             <span class="keyword">end</span>
2186             
2187             self.update();
2188         <span class="keyword">end</span>
2189         
2190         <a name="_sub85" href="#_subfunctions" class="code">function delete_roi_set(self, idx)</a>
2191             <span class="comment">% delete_roi_set(self, idx): deletes an roi set.</span>
2192             
2193             disp(<span class="string">'delete_roi_set'</span>);
2194             
2195             <span class="keyword">if</span> nargin &lt; 2
2196                 <span class="comment">% Then just delete the currently selected set(?)</span>
2197                 idx = self.gui.d(self.gui.current_trial).current_roi_set;
2198             <span class="keyword">end</span>
2199             
2200             <span class="comment">% prompt?</span>
2201             
2202             <span class="comment">% Make sure idx is in range</span>
2203             <span class="keyword">if</span> idx &lt; 1 || idx &gt; length(self.data(self.gui.current_trial).rois)
2204                 <span class="comment">% umm... do nothing?</span>
2205                 disp(<span class="string">'Requested ROI set not found. Nothing deleted.'</span>);
2206                 <span class="keyword">return</span>;
2207             <span class="keyword">end</span>
2208             
2209             self.data(self.gui.current_trial).rois(idx) = [];
2210             self.data(self.gui.current_trial).roi_names(idx) = [];
2211             self.data(self.gui.current_trial).is_component_set(idx) = [];
2212             
2213             <span class="keyword">if</span> isempty(self.data(self.gui.current_trial).rois)
2214                 self.build_roi_listbox();
2215             <span class="keyword">end</span>
2216             
2217             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).current_roi_set &gt; length(self.data(self.gui.current_trial).rois)
2218                 self.gui.d(self.gui.current_trial).current_roi_set = length(self.data(self.gui.current_trial).rois);
2219             <span class="keyword">end</span>
2220             
2221             self.h.roi_editor.set_rois(self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set}, false);
2222             self.update();
2223         <span class="keyword">end</span>
2224         
2225         <a name="_sub86" href="#_subfunctions" class="code">function select_roi_set(self, idx)</a>
2226             <span class="comment">% select_roi_set(self, idx): sets the currently selected roi</span>
2227             <span class="comment">% set.</span>
2228             
2229             disp(<span class="string">'select_roi_set'</span>);
2230             
2231             <span class="keyword">if</span> nargin &lt; 2 || isempty(idx)
2232                 idx = 1;
2233             <span class="keyword">end</span>
2234             
2235             <span class="comment">% Check for empty</span>
2236             <span class="keyword">if</span> isempty(self.data(self.gui.current_trial).rois)
2237                 self.build_roi_listbox();
2238             <span class="keyword">end</span>
2239             
2240             <span class="comment">% Make sure idx is in range.</span>
2241             <span class="keyword">if</span> idx &lt; 1 || idx &gt; length(self.data(self.gui.current_trial).rois)
2242                 <span class="comment">% Then idx is out of range.</span>
2243                 idx = length(self.data(self.gui.current_trial).rois);
2244             <span class="keyword">end</span>
2245             
2246             <span class="keyword">if</span> idx == self.gui.d(self.gui.current_trial).current_roi_set
2247                 <span class="comment">% Then nothing needs to be done.</span>
2248                 <span class="keyword">return</span>;
2249             <span class="keyword">end</span>
2250             
2251             self.gui.d(self.gui.current_trial).current_roi_set = idx;
2252             
2253             self.h.roi_editor.set_rois(self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set}, false);
2254             
2255             <span class="keyword">if</span> self.data(self.gui.current_trial).is_component_set(idx)
2256                 self.h.roi_editor.disable_roi_editing();
2257             <span class="keyword">else</span>
2258                 self.h.roi_editor.enable_roi_editing();
2259             <span class="keyword">end</span>
2260             
2261             self.update();
2262         <span class="keyword">end</span>
2263         
2264         <a name="_sub87" href="#_subfunctions" class="code">function set_ica_spatial_guess(self, masks, which_pcs)</a>
2265             <span class="comment">% set_ica_spatial_guess(self, masks): Sets an initial guess for</span>
2266             <span class="comment">% the ICs given a series of spatial masks.</span>
2267             <span class="comment">%</span>
2268             <span class="comment">% This adjusts the settings.ica.which_pcs to match the number</span>
2269             <span class="comment">% of masks.</span>
2270             <span class="comment">%</span>
2271             <span class="comment">% @param: masks mxnxG array of masks indicating the location of</span>
2272             <span class="comment">% the ics. G is the number of masks.</span>
2273             <span class="comment">% @param: which_pcs the pcs to use for the guess, this must</span>
2274             <span class="comment">% have a length of G. Default is to use 1:G pcs</span>
2275             
2276             <span class="keyword">if</span> nargin &lt; 3 || isempty(which_pcs)
2277                 which_pcs = 1:size(masks, 3);
2278             <span class="keyword">end</span>
2279             
2280             <span class="comment">% Must have already run pca at least.</span>
2281             <span class="keyword">if</span> self.data(self.gui.current_trial).stage == self.InitStage || self.data(self.gui.current_trial).stage == self.PreProcessingStage
2282                 disp(<span class="string">'Running previous stages...'</span>);
2283                 self.run_pca();
2284             <span class="keyword">end</span>
2285             
2286             pc_scores = self.data(self.gui.current_trial).pca.scores(:, which_pcs)';
2287             
2288             <span class="comment">% reformat the masks into scores form</span>
2289             ic_scores = reshape(masks, [], size(masks, 3))';
2290             
2291             A_guess = pc_scores / ic_scores;
2292             
2293             self.data(self.gui.current_trial).settings.ica.init_guess = A_guess;
2294             self.data(self.gui.current_trial).settings.ica.which_pcs = which_pcs;
2295         <span class="keyword">end</span>
2296         
2297         <a name="_sub88" href="#_subfunctions" class="code">function save_rois(self, filename)</a>
2298             <span class="comment">% save_rois(self, filename): saves the rois to a mat file.</span>
2299             <span class="comment">%</span>
2300             <span class="comment">% If filename is not given then user will be prompted</span>
2301             
2302             <span class="keyword">if</span> nargin &lt; 2 || isempty(filename)
2303                 <span class="comment">% Prompt for filename</span>
2304                 [file, path] = uiputfile({<span class="string">'*.mat'</span>}, <span class="string">'Save ROIs'</span>);
2305                 <span class="keyword">if</span> file == 0
2306                     <span class="comment">% Dialog was canceled</span>
2307                     <span class="keyword">return</span>;
2308                 <span class="keyword">end</span>
2309                 filename = [path file];
2310             <span class="keyword">end</span>
2311             rois = self.data(self.gui.current_trial).rois;
2312             names = self.data(self.gui.current_trial).roi_names;
2313             
2314             save(filename, <span class="string">'rois'</span>, <span class="string">'names'</span>);
2315         <span class="keyword">end</span>
2316         
2317         <a name="_sub89" href="#_subfunctions" class="code">function load_rois(self, filename)</a>
2318             <span class="comment">% load_rois(self, filename): loads rois from a mat file.</span>
2319             
2320             <span class="keyword">if</span> nargin &lt; 2 || isempty(filename)
2321                 [file, path] = uigetfile({<span class="string">'*.mat'</span>}, <span class="string">'Load ROIs'</span>);
2322                 
2323                 <span class="keyword">if</span> file == 0
2324                     <span class="comment">% Dialog was canceled</span>
2325                     <span class="keyword">return</span>;
2326                 <span class="keyword">end</span>
2327                 filename = [path file];
2328             <span class="keyword">end</span>
2329             
2330             roi_s = load(filename);
2331             
2332             <span class="keyword">for</span> i = 1:length(roi_s.rois)
2333                 self.create_new_roi_set(roi_s.names{i});
2334                 self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set} = roi_s.rois{i};
2335             <span class="keyword">end</span>
2336             
2337             self.h.roi_editor.set_rois(self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set}, false);
2338             
2339             self.update();
2340         <span class="keyword">end</span>
2341         
2342         <a name="_sub90" href="#_subfunctions" class="code">function set_cluster(self, ic_idxs)</a>
2343             <span class="comment">% set_cluster(self, ic_idxs): Sets the ics given by ic_idxs as</span>
2344             <span class="comment">% a cluster.</span>
2345             
2346             disp(<span class="string">'set_cluster'</span>);
2347             
2348             <span class="comment">% @todo: checks on state, cluster</span>
2349             <span class="keyword">if</span> nargin &lt; 2 || isempty(ic_idxs)
2350                 <span class="comment">% Then the ic_idxs should be the rois that are selected.</span>
2351                 ic_idxs = self.h.roi_editor.selected_rois;
2352             <span class="keyword">end</span>
2353             <span class="comment">% @todo: more checks</span>
2354             
2355             <span class="comment">% Basically, just set the cluster matrix to 1 at the ic_idxs.</span>
2356             self.data(self.gui.current_trial).cluster.cluster_matrix(ic_idxs, ic_idxs) = 1;
2357             
2358             self.update();
2359         <span class="keyword">end</span>
2360         
2361         <a name="_sub91" href="#_subfunctions" class="code">function uncluster(self, idxs)</a>
2362             <span class="comment">% uncluster(self, idxs): unclusters the given idxs.</span>
2363             disp(<span class="string">'uncluster'</span>);
2364             
2365             <span class="keyword">if</span> nargin &lt; 2 || isempty(idxs)
2366                 <span class="comment">% Then idxs are the currently selected rois</span>
2367                 idxs = self.h.roi_editor.selected_rois;
2368             <span class="keyword">end</span>
2369             
2370             self.data(self.gui.current_trial).cluster.cluster_matrix(idxs, idxs) = 0;
2371             
2372             self.update();
2373         <span class="keyword">end</span>
2374         
2375         <a name="_sub92" href="#_subfunctions" class="code">function clear_clusters(self)</a>
2376             <span class="comment">% clear_clusters(self): removes all clusters</span>
2377         <span class="keyword">end</span>
2378         
2379         <a name="_sub93" href="#_subfunctions" class="code">function load_data(self, filename)</a>
2380             <span class="comment">% load_data(self, filename): loads data from a file.</span>
2381             <span class="comment">%</span>
2382             <span class="comment">% File must be a tif image stack or a mat file with an mxnxt</span>
2383             <span class="comment">% variable.</span>
2384             
2385             <span class="keyword">if</span> nargin &lt; 2 || isempty(filename)
2386                 <span class="comment">% Then ask the user for a file with the prompt</span>
2387                 [file_name, path_name] = uigetfile({<span class="string">'*.mat;*.tif;'</span>, <span class="string">'Image Files'</span>}, <span class="string">'Load Data File'</span>);
2388                 <span class="comment">%[file_name, path_name] = uigetfile();</span>
2389                 
2390                 <span class="keyword">if</span> file_name == 0
2391                     <span class="comment">% cancelled</span>
2392                     <span class="keyword">return</span>;
2393                 <span class="keyword">end</span>
2394                 filename = [path_name file_name];
2395             <span class="keyword">end</span>
2396             
2397             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Loading Data...'</span>);
2398             drawnow;
2399             
2400             ext = filename((end-2):end);
2401             <span class="keyword">if</span> strcmp(ext, <span class="string">'tif'</span>)
2402                 <span class="comment">% Ok we should be able to just load a file using tifread</span>
2403                 data = <a href="tifread.html" class="code" title="function image = tifread(filename)">tifread</a>(filename);
2404                 self.add_trial(data);
2405             <span class="keyword">elseif</span> strcmp(ext, <span class="string">'mat'</span>)
2406                 <span class="comment">% Ok then we need to load the mat file and find the image</span>
2407                 <span class="comment">% data.</span>
2408                 data = load(filename);
2409                 
2410                 <span class="keyword">if</span> isstruct(data)
2411                     <span class="comment">% then [data] should have a field thats the image data</span>
2412                     fn = fieldnames(data);
2413                     notfound = true;
2414                     <span class="keyword">for</span> i = 1:length(fn)
2415                         <span class="keyword">if</span> ndims(data.(fn{i})) == 3
2416                             <span class="comment">% So then this must be the data that we're</span>
2417                             <span class="comment">% looking for.</span>
2418                             self.add_trial(data.(fn{i}));
2419                             notfound = false;
2420                             <span class="keyword">break</span>;
2421                         <span class="keyword">end</span>
2422                     <span class="keyword">end</span>
2423                     
2424                     <span class="keyword">if</span> notfound
2425                         <span class="comment">% So if we get to this point then we didn't find</span>
2426                         <span class="comment">% anything suitable for data.</span>
2427                         disp(<span class="string">'No Image data found. Need NxMxT matrix.'</span>);
2428                         <span class="keyword">return</span>;
2429                     <span class="keyword">end</span>
2430                 <span class="keyword">elseif</span> ndims(data) == 3
2431                     <span class="comment">% then [data] is the image data</span>
2432                     self.add_trial(data);
2433                 <span class="keyword">else</span>
2434                     <span class="comment">% then data is not valid.</span>
2435                     disp(<span class="string">'Data file must be MxNxT movie.'</span>);
2436                 <span class="keyword">end</span>
2437             <span class="keyword">else</span>
2438                 <span class="comment">% Then something is weird...</span>
2439                 disp(<span class="string">'Invalid File.'</span>);
2440             <span class="keyword">end</span>
2441             
2442             <span class="comment">% @todo: set the trial name to be the filename here.</span>
2443             
2444             self.update();
2445         <span class="keyword">end</span>
2446         
2447         <a name="_sub94" href="#_subfunctions" class="code">function set_data(self, im, trial_idx)</a>
2448             <span class="comment">% set_data(self, im): sets the image data.</span>
2449             <span class="comment">%</span>
2450             <span class="comment">% @param: im image data (MxNxt)</span>
2451             <span class="comment">% @param: trial_idx the trial to set the im_data</span>
2452             
2453             disp(<span class="string">'set_data'</span>);
2454             
2455             <span class="keyword">if</span> nargin &lt; 3 || isempty(trial_idx)
2456                 trial_idx = self.gui.current_trial;
2457             <span class="keyword">end</span>
2458             
2459             <span class="comment">% @todo: checks on inputs</span>
2460             self.init_data(im, trial_idx);
2461             
2462             self.update();
2463         <span class="keyword">end</span>
2464         
2465         <a name="_sub95" href="#_subfunctions" class="code">function add_trial(self, im_data)</a>
2466             <span class="comment">% add_trial(self, im_data): adds a trial to the ICP</span>
2467             
2468             disp(<span class="string">'add_trial'</span>);
2469             
2470             <span class="keyword">if</span> length(self.data) == 1 &amp;&amp; self.gui.default_data
2471                 <span class="comment">% Then we have defualt data which can be replaced. This</span>
2472                 <span class="comment">% should always be the first data, and should only be true</span>
2473                 <span class="comment">% if there is 1 thing in the data.</span>
2474                 self.set_data(im_data, 1);
2475                 self.gui.default_data = false;
2476             <span class="keyword">else</span>
2477                 self.set_data(im_data, length(self.data)+1);
2478             <span class="keyword">end</span>
2479             
2480         <span class="keyword">end</span>
2481         
2482         <a name="_sub96" href="#_subfunctions" class="code">function delete_trial(self, idx)</a>
2483             <span class="comment">% delete_trial(self, idx): removes a trial from the ICP</span>
2484             
2485         <span class="keyword">end</span>
2486         
2487         <a name="_sub97" href="#_subfunctions" class="code">function align_trials(self)</a>
2488             <span class="comment">% align_trials(self): aligns the frames of several trials.</span>
2489             
2490             f1 = mean(self.data(1).im_data, 3);
2491             all_warp = [];
2492             im_data_all = [];
2493             frame_ids = []; <span class="comment">% which trial each frame belongs to</span>
2494             im_z = [];
2495             c = 1;
2496             
2497             <span class="comment">% Hmm... these should be the same for all the images.</span>
2498             im_x = self.data(1).im_x;
2499             im_y = self.data(1).im_y;
2500             
2501             <span class="keyword">for</span> t = 1:length(self.data)
2502                 f1f2 = [];
2503                 f1f2(:,:,1) = f1;
2504                 f1f2(:,:,2) = mean(self.data(t).im_data, 3);
2505                 
2506                 [im_stack, warp] = <a href="align_im_stack.html" class="code" title="function [im_stack, warp] = align_im_stack(im, n_iters, n_levels, transform, viz)">align_im_stack</a>(f1f2, 20, 3);
2507                 
2508                 all_warp(:,:,t) = warp(:,:,2);
2509                 
2510                 <span class="keyword">for</span> j = 1:size(self.data(t).im_data, 3)
2511                     im_data_all(:,:,c) = spatial_interp(self.data(t).im_data(:,:,j), <span class="keyword">...</span>
2512                         all_warp(:,:,t), <span class="string">'linear'</span>, <span class="string">'affine'</span>, <span class="keyword">...</span>
2513                         im_x, im_y);
2514                     frame_ids(c) = t;
2515                     im_z(c) = j;
2516                     c = c + 1;
2517                 <span class="keyword">end</span>
2518                 
2519                 <span class="comment">% Get how far it shifts for removal of the edges</span>
2520                 dxy(:,t) = all_warp(:,:,t) * [1;1;1] - [1;1];
2521             <span class="keyword">end</span>
2522             
2523             max_pos = ceil(max(dxy, [], 2));
2524             max_neg = ceil(max(-dxy, [], 2));
2525             
2526             row_keep = (max_neg(2) + 1):(size(im_data_all, 1) - max_pos(2) - 1);
2527             col_keep = (max_neg(1) + 1):(size(im_data_all, 2) - max_pos(1) - 1);
2528             
2529             <span class="comment">% Ok max_pos take out from right and bottom</span>
2530             
2531             self.data(1).concat.im_data = im_data_all(row_keep, col_keep, :);
2532             self.data(1).concat.im_x = col_keep;
2533             self.data(1).concat.im_y = row_keep;
2534             self.data(1).concat.im_z = im_z;
2535             self.data(1).concat.all_warp = all_warp;
2536             self.data(1).concat.frame_ids = frame_ids;
2537         <span class="keyword">end</span>
2538         
2539         <a name="_sub98" href="#_subfunctions" class="code">function set_selected_trial(self, idx)</a>
2540             <span class="comment">% set_selected_trial(self, idx): sets the current trial.</span>
2541             
2542             <span class="comment">% @todo: checks</span>
2543             disp(<span class="string">'set_selected_trial'</span>);
2544             self.gui.current_trial = idx;
2545             self.gui.d(self.gui.current_trial).last_display = 0;
2546             self.update();
2547         <span class="keyword">end</span>
2548         
2549         <a name="_sub99" href="#_subfunctions" class="code">function set_use_wavelets(self, val)</a>
2550             <span class="comment">% set_use_wavelets(self, val): sets whether to use the wavelets</span>
2551             
2552             <span class="comment">%todo: checks, update the checkbox in the gui</span>
2553             self.gui.d(self.gui.current_trial).use_wavelets = val;
2554         <span class="keyword">end</span>
2555         
2556         <a name="_sub100" href="#_subfunctions" class="code">function reset(self)</a>
2557             <span class="comment">% reset(self); resets to the init stage.</span>
2558             self.data(self.gui.current_trial).stage = self.InitStage;
2559             self.data(self.gui.current_trial).pp = [];
2560             self.data(self.gui.current_trial).pca = [];
2561             self.data(self.gui.current_trial).ica = [];
2562             self.update();
2563         <span class="keyword">end</span>
2564         
2565         <a name="_sub101" href="#_subfunctions" class="code">function load_session(self, filename)</a>
2566             <span class="comment">% load_session(self, filename): loads an ICP session from a</span>
2567             <span class="comment">% file.</span>
2568             
2569             <span class="keyword">if</span> nargin &lt; 2 || isempty(filename)
2570                 <span class="comment">% Then ask the user for a file with the prompt</span>
2571                 [file_name, path_name] = uigetfile({<span class="string">'*.mat;*.icp;'</span>, <span class="string">'ICP Session Files'</span>}, <span class="string">'Load Session File'</span>);
2572                 <span class="comment">%[file_name, path_name] = uigetfile();</span>
2573                 
2574                 <span class="keyword">if</span> file_name == 0
2575                     <span class="comment">% cancelled</span>
2576                     <span class="keyword">return</span>;
2577                 <span class="keyword">end</span>
2578                 filename = [path_name file_name];
2579             <span class="keyword">end</span>
2580             
2581             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Loading Session...'</span>);
2582             drawnow;
2583             
2584             ext = filename((end-2):end);
2585             
2586             ds = load(filename);
2587             
2588             <span class="keyword">if</span> isstruct(ds)
2589                 <span class="comment">% Ok well it should be a struct no matter what</span>
2590                 <span class="keyword">if</span> isfield(ds, <span class="string">'data'</span>)
2591                     <span class="comment">% This is the most normal thing that should happen,</span>
2592                     <span class="comment">% this is what should happen on a file that is saved by</span>
2593                     <span class="comment">% the save_session function</span>
2594                     
2595                     <span class="comment">% delete all of the current settings</span>
2596                     self.data =[];
2597                     self.gui.d = [];
2598                     
2599                     <span class="comment">% reinit the gui states</span>
2600                     <span class="keyword">for</span> i = 1:length(ds.data)
2601                         self.init_gui_display(i);
2602                     <span class="keyword">end</span>
2603                     
2604                     <span class="comment">% Now just set the data</span>
2605                     self.data = ds.data;
2606                 <span class="keyword">else</span>
2607                     <span class="comment">% ds could be data itself? but just going to say no for</span>
2608                     <span class="comment">% now</span>
2609                     disp(<span class="string">'data struct not found.'</span>);
2610                     <span class="keyword">return</span>;
2611                 <span class="keyword">end</span>
2612             <span class="keyword">else</span>
2613                 <span class="comment">% Then we have a weird problem...</span>
2614                 disp(<span class="string">'Data in file invalid.'</span>);
2615                 <span class="keyword">return</span>;
2616             <span class="keyword">end</span>
2617             
2618             self.update();
2619             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Load Complete'</span>);
2620             drawnow;
2621         <span class="keyword">end</span>
2622         
2623         <a name="_sub102" href="#_subfunctions" class="code">function save_session(self, filename)</a>
2624             <span class="comment">% save_session(self, filename): saves the ICP session to a</span>
2625             <span class="comment">% file.</span>
2626             <span class="comment">%</span>
2627             <span class="comment">% @param: filename the name of the file to save the session.</span>
2628             <span class="comment">% Default [] will open an file window</span>
2629             
2630             <span class="keyword">if</span> nargin &lt; 2 || isempty(filename)
2631                 <span class="comment">% Then ask the user for a file with the prompt</span>
2632                 [file_name, path_name] = uiputfile({<span class="string">'*.mat;*.icp;'</span>, <span class="string">'ICP Session Files'</span>}, <span class="string">'Load Session File'</span>);
2633                 <span class="comment">%[file_name, path_name] = uigetfile();</span>
2634                 
2635                 <span class="keyword">if</span> file_name == 0
2636                     <span class="comment">% cancelled</span>
2637                     <span class="keyword">return</span>;
2638                 <span class="keyword">end</span>
2639                 filename = [path_name file_name];
2640             <span class="keyword">end</span>
2641             
2642             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Saving Session...'</span>);
2643             drawnow;
2644             
2645             <span class="comment">% First lets get the extension</span>
2646             <span class="keyword">if</span> filename(end-3) == <span class="string">'.'</span>
2647                 <span class="comment">% Then there is an extension</span>
2648                 ext = filename((end-2):end);
2649                 
2650                 <span class="comment">% So now just make sure it is mat or icp</span>
2651                 <span class="keyword">if</span> strcmp(ext, <span class="string">'mat'</span>) || strcmp(ext, <span class="string">'icp'</span>)
2652                     <span class="comment">% Then we're good.</span>
2653                 <span class="keyword">else</span>
2654                     <span class="comment">% Then replace the extension</span>
2655                     filename((end-2):end) = <span class="string">'icp'</span>;
2656                 <span class="keyword">end</span>
2657             <span class="keyword">else</span>
2658                 <span class="comment">% Then no extension so add one</span>
2659                 filename = [filename <span class="string">'.icp'</span>];
2660             <span class="keyword">end</span>
2661             
2662             <span class="comment">% Ok, so baically we just save data to the file</span>
2663             data = self.data;
2664             
2665             save(filename, <span class="string">'-mat'</span>, <span class="string">'-v7.3'</span>, <span class="string">'data'</span>);
2666             
2667             set(self.h.stage_status, <span class="string">'String'</span>, <span class="string">'Session Saved'</span>);
2668             drawnow;
2669         <span class="keyword">end</span>
2670         
2671         <a name="_sub103" href="#_subfunctions" class="code">function set_which_pcs(self, which_pcs, trial)</a>
2672             <span class="comment">% set_which_pcs(self, which_pcs): sets the pcs to use for ica.</span>
2673             
2674             <span class="keyword">if</span> nargin &lt; 3 || isempty(trial)
2675                 trial = self.gui.current_trial;
2676             <span class="keyword">end</span>
2677             
2678             <span class="comment">% @todo: check on which_pcs</span>
2679             
2680             self.data(trial).settings.ica.which_pcs = which_pcs;
2681         <span class="keyword">end</span>
2682         
2683         <a name="_sub104" href="#_subfunctions" class="code">function set_segment_thresh(self, thresh, trial_idx)</a>
2684             <span class="comment">% self.set_segment_thresh(thresh, [trial_idx]): sets the threshold used during</span>
2685             <span class="comment">% segmentation.</span>
2686             
2687             <span class="keyword">if</span> nargin &lt; 3 || isempty(trial_idx)
2688                 trial_idx = self.gui.current_trial;
2689             <span class="keyword">end</span>
2690             
2691             <span class="comment">% @todo: checks on the input</span>
2692             
2693             self.data(trial_idx).settings.segment.thresh = thresh;
2694             
2695             self.update();
2696         <span class="keyword">end</span>
2697         
2698         <a name="_sub105" href="#_subfunctions" class="code">function set_segment_down_size(self, down_size, trial_idx)</a>
2699             <span class="comment">% self.set_down_size(down_size, [trial_idx]): sets the down size parameter</span>
2700             <span class="comment">% used during segmentation.</span>
2701             
2702             <span class="keyword">if</span> nargin &lt; 3 || isempty(trial_idx)
2703                 trial_idx = self.gui.current_trial;
2704             <span class="keyword">end</span>
2705             
2706             <span class="comment">% @todo: checks on the input</span>
2707             
2708             self.data(trial_idx).settings.segment.down_size = down_size;
2709             
2710             self.update();
2711         <span class="keyword">end</span>
2712         
2713         <span class="comment">%%%%%%%%%% Utility Functions %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2714         <a name="_sub106" href="#_subfunctions" class="code">function default_settings(self)</a>
2715             <span class="comment">% default_settings(self): sets the settings to the default.</span>
2716             
2717             self.data(self.gui.current_trial).settings.concat.align_func = @<a href="align_im_stack.html" class="code" title="function [im_stack, warp] = align_im_stack(im, n_iters, n_levels, transform, viz)">align_im_stack</a>;
2718             
2719             
2720             <span class="comment">%self.settings.preprocessing.block_size = 6;</span>
2721             self.data(self.gui.current_trial).settings.preprocessing.smooth_window = [6, 6, 1];
2722             <span class="comment">%self.data(self.gui.current_trial).settings.preprocessing.step_size = 2;</span>
2723             self.data(self.gui.current_trial).settings.preprocessing.down_sample = [1, 1, 1];
2724             self.data(self.gui.current_trial).settings.preprocessing.remove_frames = [];
2725             
2726             self.data(self.gui.current_trial).settings.preprocessing.motion_correct_func = @<a href="align_im_stack.html" class="code" title="function [im_stack, warp] = align_im_stack(im, n_iters, n_levels, transform, viz)">align_im_stack</a>;
2727             
2728             self.data(self.gui.current_trial).settings.preprocessing.default_filter_file = <span class="string">'icp_default_filters.mat'</span>;
2729             self.data(self.gui.current_trial).settings.preprocessing.filter_file = self.data(self.gui.current_trial).settings.preprocessing.default_filter_file;
2730             
2731             self.data(self.gui.current_trial).settings.pca.mean_center = 0;
2732             self.data(self.gui.current_trial).settings.pca.corr_pca = 0;
2733             
2734             self.data(self.gui.current_trial).settings.ica.which_pcs = 1:50;
2735             self.data(self.gui.current_trial).settings.ica.positive_skew = true;
2736             self.data(self.gui.current_trial).settings.ica.init_guess = -1;
2737             self.data(self.gui.current_trial).settings.ica.ica_func = <span class="string">'fastica'</span>;
2738             self.data(self.gui.current_trial).settings.ica.mu = 0.2; <span class="comment">% This is a parameter for Cellsort ICA</span>
2739             
2740             self.data(self.gui.current_trial).settings.segment.calc_rois_func = @<a href="calc_rois_from_components.html" class="code" title="function rois = calc_rois_from_components(comp, x, y)">calc_rois_from_components</a>;
2741             self.data(self.gui.current_trial).settings.segment.segment_ics_func = @<a href="segment_ics.html" class="code" title="function [segment_masks, segment_info] = segment_ics(comp, thresh, down_size, min_area)">segment_ics</a>;
2742             self.data(self.gui.current_trial).settings.segment.down_size = 4;
2743             self.data(self.gui.current_trial).settings.segment.thresh = 0.5;
2744             self.data(self.gui.current_trial).settings.segment.min_area = 18;
2745             
2746             self.data(self.gui.current_trial).settings.viz.map_pow = 2;
2747             self.data(self.gui.current_trial).settings.viz.color_pow = 2;
2748             self.data(self.gui.current_trial).settings.viz.alpha = 0.25;
2749             
2750             self.data(self.gui.current_trial).settings.cluster.feature_matrix_func = @<a href="make_feature_matrix.html" class="code" title="function [feature_matrix, feature_weights] = make_feature_matrix(ics, im_data)">make_feature_matrix</a>;
2751             self.data(self.gui.current_trial).settings.cluster.feature_weights = 1;
2752             self.data(self.gui.current_trial).settings.cluster.visualization_func = @viz_best3;
2753             self.data(self.gui.current_trial).settings.cluster.calc_sim_matrix_func = @(b, x) sum(repmat(b, [size(x,1), size(x,2), 1]) .* x, 3);
2754             
2755             
2756             self.data(self.gui.current_trial).settings.visualize.norm_best_components = false;
2757             self.data(self.gui.current_trial).settings.visualize.num_best_components = 3;
2758             self.data(self.gui.current_trial).settings.visualize.show_residual = true;
2759             self.data(self.gui.current_trial).settings.visualize.best_selection_type = 1;
2760         <span class="keyword">end</span>
2761         
2762         <a name="_sub107" href="#_subfunctions" class="code">function init_data(self, im_data, trial_idx, isdefault)</a>
2763             <span class="comment">% initializes the data struct and data gui elements</span>
2764             
2765             disp(<span class="string">'init_data'</span>);
2766             
2767             <span class="keyword">if</span> nargin &lt; 2 || isempty(im_data)
2768                 <span class="comment">% Then we have no im_data, so set the default</span>
2769                 im_data = rand(128,128,10);
2770             <span class="keyword">end</span>
2771             
2772             <span class="keyword">if</span> nargin &lt; 3 || isempty(trial_idx)
2773                 <span class="comment">% Then add a new struct to the end.</span>
2774                 trial_idx = length(self.data) + 1;
2775             <span class="keyword">end</span>
2776             
2777             <span class="keyword">if</span> nargin &lt; 4 || isempty(isdefault)
2778                 isdefault = false;
2779             <span class="keyword">end</span>
2780             
2781             self.gui.default_data = isdefault;
2782             
2783             self.data(trial_idx).im_data = im_data;
2784             self.data(trial_idx).im_x = 1:size(im_data, 2);
2785             self.data(trial_idx).im_y = 1:size(im_data, 1);
2786             self.data(trial_idx).im_z = 1:size(im_data, 3);
2787             self.data(trial_idx).pp = [];
2788             self.data(trial_idx).pca = [];
2789             self.data(trial_idx).ica = [];
2790             self.data(trial_idx).viz = [];
2791             self.data(trial_idx).segment = [];
2792             self.data(trial_idx).cluster = [];
2793             self.data(trial_idx).stage = self.InitStage;
2794             
2795             self.data(trial_idx).rois{1} = [];
2796             self.data(trial_idx).roi_names{1} = <span class="string">'ROI_set_1'</span>;
2797             self.data(trial_idx).is_component_set = false;
2798             
2799             self.init_gui_display(trial_idx);
2800             
2801             <span class="keyword">if</span> self.gui.default_data
2802                 self.data(trial_idx).trial_name = <span class="string">'Default Data'</span>;
2803                 
2804             <span class="keyword">else</span>
2805                 self.data(trial_idx).trial_name = [<span class="string">'Trial '</span> num2str(trial_idx)];
2806             <span class="keyword">end</span>
2807             
2808             self.gui.current_trial = trial_idx;
2809             
2810             <span class="comment">% Finally copy the settings or do the default</span>
2811             <span class="keyword">if</span> length(self.data) == 1
2812                 <span class="comment">% Then just do the default settings</span>
2813                 self.default_settings();
2814             <span class="keyword">elseif</span> length(self.data) &gt; 1 &amp;&amp; self.gui.current_trial &gt; 1
2815                 <span class="comment">% Then copy the settings from the previous trial</span>
2816                 self.data(self.gui.current_trial).settings = self.data(self.gui.current_trial - 1).settings;
2817             <span class="keyword">else</span>
2818                 <span class="comment">% Then do the default</span>
2819                 self.default_settings();
2820             <span class="keyword">end</span>
2821         <span class="keyword">end</span>
2822         
2823         <a name="_sub108" href="#_subfunctions" class="code">function init_gui_display(self, trial_idx)</a>
2824             <span class="comment">% Inits the gui state variables that are needed for each trial.</span>
2825             
2826             <span class="comment">% @todo: use_wavelets may need to be initialized based on the</span>
2827             <span class="comment">% settings.</span>
2828             self.gui.d(trial_idx).use_wavelets = false;
2829             self.gui.d(trial_idx).current_roi_set = 1;
2830             
2831             <span class="comment">% 3d-axis state variables</span>
2832             self.gui.d(trial_idx).x_pc = 1; <span class="comment">% The PC scores to plot on the x-axis</span>
2833             self.gui.d(trial_idx).y_pc = 2; <span class="comment">% The PC scores to plot on the y-axis</span>
2834             self.gui.d(trial_idx).z_pc = 3; <span class="comment">% The PC scores to plot on the z-axis</span>
2835             
2836             self.gui.d(trial_idx).display = 1;
2837             self.gui.d(trial_idx).last_display = 0;
2838             
2839             <span class="comment">% Keep track of the frame for each of the display panels</span>
2840             self.gui.d(trial_idx).current_frame = ones(6, 1);
2841             self.gui.d(trial_idx).levels = nan(2, 3, 6);
2842         <span class="keyword">end</span>
2843         
2844         <a name="_sub109" href="#_subfunctions" class="code">function plot_locked_components(self)</a>
2845             hold(self.h.component_axes, <span class="string">'on'</span>);
2846             <span class="keyword">for</span> i = 1:length(self.gui.locked_components.handle_ids)
2847                 c = self.gui.locked_colors(mod(i-1, length(self.gui.locked_colors))+1, :);
2848                 plot(self.h.component_axes, self.gui.locked_components.xdata(:,i), self.gui.locked_components.ydata(:,i), <span class="string">'Color'</span>, c);
2849             <span class="keyword">end</span>
2850         <span class="keyword">end</span>
2851         
2852         <a name="_sub110" href="#_subfunctions" class="code">function plot_3d(self)</a>
2853             <span class="comment">% plot_3d(self): plots the currently selected components in</span>
2854             <span class="comment">% 3-space.</span>
2855             disp(<span class="string">'plot_3d'</span>);
2856             
2857             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).display == 4 &amp;&amp; self.data(self.gui.current_trial).stage == self.IcaStage
2858                 <span class="comment">% Then view the ICs</span>
2859                 sc = self.data(self.gui.current_trial).ica.scores;
2860                 self.build_3d_gui_components(self.IcaStage)
2861             <span class="keyword">elseif</span> self.gui.d(self.gui.current_trial).display == 3 &amp;&amp; self.data(self.gui.current_trial).stage &gt;= self.PcaStage
2862                 <span class="comment">% Then view the PCs</span>
2863                 sc = self.data(self.gui.current_trial).pca.scores;
2864                 self.build_3d_gui_components(self.PcaStage);
2865                 
2866             <span class="keyword">elseif</span> self.data(self.gui.current_trial).stage == self.PcaStage
2867                 <span class="comment">% Then view the PCs</span>
2868                 sc = self.data(self.gui.current_trial).pca.scores;
2869                 self.build_3d_gui_components(self.PcaStage);
2870             <span class="keyword">elseif</span> self.data(self.gui.current_trial).stage == self.IcaStage
2871                 <span class="comment">% Then view the ICs</span>
2872                 sc = self.data(self.gui.current_trial).ica.scores;
2873                 self.build_3d_gui_components(self.IcaStage);
2874             <span class="keyword">else</span>
2875                 cla(self.h.pc3_axes);
2876                 self.build_3d_gui_components(self.data(self.gui.current_trial).stage);
2877                 <span class="keyword">return</span>;
2878             <span class="keyword">end</span>
2879             
2880             <span class="keyword">if</span> isempty(sc)
2881                 <span class="comment">% Then there's nothing to plot</span>
2882                 <span class="keyword">return</span>;
2883             <span class="keyword">end</span>
2884             
2885             <span class="comment">% Make sure everything is in range</span>
2886             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).x_pc &lt; 1 || self.gui.d(self.gui.current_trial).x_pc &gt; size(sc, 2)
2887                 <span class="comment">% Just set to 1 for now.</span>
2888                 self.gui.d(self.gui.current_trial).x_pc = 1;
2889             <span class="keyword">end</span>
2890             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).y_pc &lt; 1 || self.gui.d(self.gui.current_trial).y_pc &gt; size(sc, 2)
2891                 self.gui.d(self.gui.current_trial).y_pc = 1;
2892             <span class="keyword">end</span>
2893             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).z_pc &lt; 1 || self.gui.d(self.gui.current_trial).z_pc &gt; size(sc, 2)
2894                 self.gui.d(self.gui.current_trial).z_pc = 1;
2895             <span class="keyword">end</span>
2896             
2897             xv = sc(:, self.gui.d(self.gui.current_trial).x_pc);
2898             yv = sc(:, self.gui.d(self.gui.current_trial).y_pc);
2899             zv = sc(:, self.gui.d(self.gui.current_trial).z_pc);
2900             
2901             [az, el] = view(self.h.pc3_axes);
2902             plot3(self.h.pc3_axes, xv, yv, zv, <span class="string">'.k'</span>);
2903             axis(self.h.pc3_axes, <span class="string">'vis3d'</span>);
2904             view(self.h.pc3_axes, az, el);
2905             
2906             popup_str = get(self.h.x_popup, <span class="string">'String'</span>);
2907             xlabel(self.h.pc3_axes, popup_str{self.gui.d(self.gui.current_trial).x_pc});
2908             ylabel(self.h.pc3_axes, popup_str{self.gui.d(self.gui.current_trial).y_pc});
2909             zlabel(self.h.pc3_axes, popup_str{self.gui.d(self.gui.current_trial).z_pc});
2910         <span class="keyword">end</span>
2911         
2912         <a name="_sub111" href="#_subfunctions" class="code">function build_3d_gui_components(self, stage)</a>
2913             <span class="comment">% build_3d_gui_components(self): builds the 3d axis gui</span>
2914             
2915             <span class="keyword">switch</span> stage
2916                 <span class="keyword">case</span> {self.InitStage, self.PreProcessingStage}
2917                     <span class="comment">% There's nothing to do in this case</span>
2918                     set(self.h.x_popup, <span class="string">'String'</span>, {<span class="string">'None'</span>}, <span class="string">'Value'</span>, 1);
2919                     set(self.h.y_popup, <span class="string">'String'</span>, {<span class="string">'None'</span>}, <span class="string">'Value'</span>, 1);
2920                     set(self.h.z_popup, <span class="string">'String'</span>, {<span class="string">'None'</span>}, <span class="string">'Value'</span>, 1);
2921                     <span class="keyword">return</span>;
2922                 <span class="keyword">case</span> self.PcaStage
2923                     popup_str = cellfun(@(n) [<span class="string">'PC '</span> num2str(n)], num2cell(1:size(self.data(self.gui.current_trial).pca.scores, 2)), <span class="keyword">...</span>
2924                         <span class="string">'UniformOutput'</span>, 0);
2925                     set(self.h.x_popup, <span class="string">'String'</span>, popup_str);
2926                     set(self.h.y_popup, <span class="string">'String'</span>, popup_str);
2927                     set(self.h.z_popup, <span class="string">'String'</span>, popup_str);
2928                 <span class="keyword">case</span> self.IcaStage
2929                     popup_str = cellfun(@(n) [<span class="string">'IC '</span> num2str(n)], num2cell(1:size(self.data(self.gui.current_trial).ica.scores, 2)), <span class="keyword">...</span>
2930                         <span class="string">'UniformOutput'</span>, 0);
2931                     set(self.h.x_popup, <span class="string">'String'</span>, popup_str);
2932                     set(self.h.y_popup, <span class="string">'String'</span>, popup_str);
2933                     set(self.h.z_popup, <span class="string">'String'</span>, popup_str);
2934             <span class="keyword">end</span>
2935             
2936             set(self.h.x_popup, <span class="string">'Value'</span>, self.gui.d(self.gui.current_trial).x_pc);
2937             set(self.h.y_popup, <span class="string">'Value'</span>, self.gui.d(self.gui.current_trial).y_pc);
2938             set(self.h.z_popup, <span class="string">'Value'</span>, self.gui.d(self.gui.current_trial).z_pc);
2939         <span class="keyword">end</span>
2940         
2941         <a name="_sub112" href="#_subfunctions" class="code">function build_roi_listbox(self)</a>
2942             <span class="comment">% build_roi_listbox(self): creates the roi_listbox.</span>
2943             
2944             <span class="keyword">if</span> isempty(self.data(self.gui.current_trial).rois)
2945                 <span class="comment">% Then there is nothing in the rois, so create an empty</span>
2946                 <span class="comment">% list.</span>
2947                 self.data(self.gui.current_trial).rois{1} = [];
2948                 self.gui.d(self.gui.current_trial).current_roi_set = 1;
2949                 self.data(self.gui.current_trial).roi_names = {};
2950                 self.data(self.gui.current_trial).roi_names{1} = <span class="string">'ROI_set_1'</span>;
2951                 self.data(self.gui.current_trial).is_component_set = false;
2952             <span class="keyword">end</span>
2953             
2954             <span class="comment">% Check ranges</span>
2955             assert(length(self.data(self.gui.current_trial).rois) == length(self.data(self.gui.current_trial).roi_names));
2956             <span class="keyword">if</span> self.gui.d(self.gui.current_trial).current_roi_set &lt; 1 || self.gui.d(self.gui.current_trial).current_roi_set &gt; length(self.data(self.gui.current_trial).rois)
2957                 self.gui.d(self.gui.current_trial).current_roi_set = length(self.data(self.gui.current_trial).rois);
2958             <span class="keyword">end</span>
2959             
2960             set(self.h.roi_listbox, <span class="string">'String'</span>, self.data(self.gui.current_trial).roi_names, <span class="string">'Value'</span>, self.gui.d(self.gui.current_trial).current_roi_set);
2961         <span class="keyword">end</span>
2962         
2963         <a name="_sub113" href="#_subfunctions" class="code">function build_trial_listbox(self)</a>
2964             <span class="comment">% build_trial_listbox(self): creates the contents of the trial</span>
2965             <span class="comment">% listbox.</span>
2966             
2967             <span class="keyword">if</span> isempty(self.data)
2968                 <span class="comment">% Then something is weird... Perhaps generate the default</span>
2969                 <span class="comment">% data?</span>
2970                 disp(<span class="string">'no data!'</span>);
2971                 <span class="keyword">return</span>;
2972             <span class="keyword">end</span>
2973             
2974             <span class="comment">% @todo: check ranges</span>
2975             <span class="keyword">for</span> i = 1:length(self.data)
2976                 <span class="keyword">if</span> isfield(self.data(i), <span class="string">'trial_name'</span>) &amp;&amp; ~isempty(self.data(i).trial_name)
2977                     self.gui.trial_names{i} = self.data(i).trial_name;
2978                 <span class="keyword">else</span>
2979                     self.data(i).trial_name = [<span class="string">'Trial '</span> num2str(i)];
2980                     self.gui.trial_names{i} = self.data(i).trial_name;
2981                 <span class="keyword">end</span>
2982             <span class="keyword">end</span>
2983             
2984             set(self.h.trial_listbox, <span class="string">'String'</span>, self.gui.trial_names, <span class="string">'Value'</span>, self.gui.current_trial);
2985         <span class="keyword">end</span>
2986         
2987         <a name="_sub114" href="#_subfunctions" class="code">function update_current_roi_set(self)</a>
2988             <span class="comment">% update_current_roi_set(self): synchronizes the current roi</span>
2989             <span class="comment">% set with the roi_editor.</span>
2990             
2991             disp(<span class="string">'update_current_roi_set'</span>);
2992             
2993             self.data(self.gui.current_trial).rois{self.gui.d(self.gui.current_trial).current_roi_set} = self.h.roi_editor.rois.xyrra(:,:,1);
2994             self.update();
2995         <span class="keyword">end</span>
2996         
2997         <a name="_sub115" href="#_subfunctions" class="code">function draw_clustered_rois(self)</a>
2998             <span class="comment">% Ok</span>
2999             disp(<span class="string">'draw_clustered_rois'</span>);
3000             
3001             roi_idx = self.h.roi_editor.selected_rois;
3002             roi_h = self.h.roi_editor.h.rois;
3003             
3004             set(roi_h, <span class="string">'Color'</span>, [0.5, 0.5, 0.5], <span class="string">'Marker'</span>, <span class="string">'none'</span>);
3005             
3006             set(roi_h(roi_idx), <span class="string">'Color'</span>, <span class="string">'w'</span>);
3007             
3008             <span class="comment">% First see if there are other clustered rois</span>
3009             cluster_idx = [];
3010             <span class="keyword">if</span> ~isempty(roi_idx)
3011                 cluster_idx = find(self.data(self.gui.current_trial).cluster.cluster_matrix(roi_idx(1), :));
3012             <span class="keyword">end</span>
3013             
3014             <span class="keyword">if</span> ~isempty(cluster_idx)
3015                 <span class="comment">% Then highlight the clustered rois</span>
3016                 set(roi_h(cluster_idx), <span class="string">'Color'</span>, [0.9, 0.9, 0.9]);
3017             <span class="keyword">end</span>
3018             
3019             <span class="comment">% Draw the estimates</span>
3020             
3021             f = self.h.roi_editor.current_frame;
3022             
3023             set(roi_h(f), <span class="string">'Marker'</span>, <span class="string">'s'</span>, <span class="string">'MarkerSize'</span>, 1, <span class="string">'MarkerFaceColor'</span>, <span class="string">'w'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'w'</span>);
3024             set(roi_h(self.data(self.gui.current_trial).cluster.top3(f, 1)), <span class="string">'Marker'</span>, <span class="string">'s'</span>, <span class="string">'MarkerSize'</span>, 1, <span class="string">'MarkerFaceColor'</span>, <span class="string">'r'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'r'</span>);
3025             set(roi_h(self.data(self.gui.current_trial).cluster.top3(f, 2)), <span class="string">'Marker'</span>, <span class="string">'s'</span>, <span class="string">'MarkerSize'</span>, 1, <span class="string">'MarkerFaceColor'</span>, <span class="string">'g'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'g'</span>);
3026             set(roi_h(self.data(self.gui.current_trial).cluster.top3(f, 3)), <span class="string">'Marker'</span>, <span class="string">'s'</span>, <span class="string">'MarkerSize'</span>, 1, <span class="string">'MarkerFaceColor'</span>, <span class="string">'b'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'b'</span>);
3027             
3028             
3029         <span class="keyword">end</span>
3030         
3031         <a name="_sub116" href="#_subfunctions" class="code">function draw_component_viz(self)</a>
3032             <span class="comment">% draws the component color map onto the ccd image</span>
3033             
3034             <span class="comment">% @todo: checks</span>
3035             
3036             s = self.data(self.gui.current_trial).settings.viz;
3037             
3038             <span class="keyword">if</span> ~isfield(self.data(self.gui.current_trial).viz, <span class="string">'colors'</span>) <span class="keyword">...</span>
3039                     || isempty(self.data(self.gui.current_trial).viz.colors)
3040                 <span class="comment">% Then we don't have the data</span>
3041                 disp(<span class="string">'Run ICA before trying to draw.'</span>);
3042                 self.update();
3043                 <span class="keyword">return</span>;
3044             <span class="keyword">end</span>
3045             
3046             colors = self.data(self.gui.current_trial).viz.colors;
3047             im_data = self.data(self.gui.current_trial).ica.im_data;
3048             component_color_map = zeros(size(self.data(self.gui.current_trial).ica.im_data, 1), size(self.data(self.gui.current_trial).ica.im_data, 2), 3);
3049             
3050             <span class="keyword">for</span> i = 1:size(self.data(self.gui.current_trial).ica.im_data, 3)
3051                 cc = zeros(size(component_color_map));
3052                 
3053                 <span class="keyword">if</span> size(colors, 2) == 1
3054                     <span class="comment">% Then we have a scalar, just do red channel for now</span>
3055                     cc(:,:,1) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_data(:,:,i)) .^ s.map_pow .* colors(i) .^ s.color_pow;
3056                 <span class="keyword">elseif</span> size(colors, 2) == 3
3057                     <span class="comment">% Then we have RGB</span>
3058                     cc(:,:,1) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_data(:,:,i)) .^ s.map_pow .* colors(i, 1) .^ s.color_pow;
3059                     cc(:,:,2) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_data(:,:,i)) .^ s.map_pow .* colors(i, 2) .^ s.color_pow;
3060                     cc(:,:,3) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_data(:,:,i)) .^ s.map_pow .* colors(i, 3) .^ s.color_pow;
3061                 <span class="keyword">elseif</span> size(colors, 2) == 4
3062                     <span class="comment">% Then we have RGBA</span>
3063                     cc(:,:,1) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_data(:,:,i)) .^ s.map_pow .* colors(i, 1) .^ s.color_pow .* colors(i, 4);
3064                     cc(:,:,2) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_data(:,:,i)) .^ s.map_pow .* colors(i, 2) .^ s.color_pow .* colors(i, 4);
3065                     cc(:,:,3) = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(im_data(:,:,i)) .^ s.map_pow .* colors(i, 3) .^ s.color_pow .* colors(i, 4);
3066                 <span class="keyword">else</span>
3067                     <span class="comment">% Something is not right....</span>
3068                     disp(<span class="string">'Incorrect input'</span>);
3069                 <span class="keyword">end</span>
3070                 
3071                 component_color_map = component_color_map + cc;
3072             <span class="keyword">end</span>
3073             
3074             self.data(self.gui.current_trial).viz.component_color_map = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(component_color_map);
3075             self.data(self.gui.current_trial).viz.ccm_x = self.data(self.gui.current_trial).ica.im_x;
3076             self.data(self.gui.current_trial).viz.ccm_y = self.data(self.gui.current_trial).ica.im_y;
3077             <span class="comment">%self.data(self.gui.current_trial).viz.ccm_z = self.data(self.gui.current_trial).ica.im_z;</span>
3078             
3079             nccd = repmat(mean(self.data(self.gui.current_trial).im_data, 3), [1 1 3]);
3080             component_resize = zeros(size(nccd));
3081             
3082             <span class="comment">% These will be real values at some point...</span>
3083             im_x = 1:size(nccd, 2);
3084             im_y = 1:size(nccd, 1);
3085             
3086             [x,y] = meshgrid(self.data(self.gui.current_trial).viz.ccm_x, self.data(self.gui.current_trial).viz.ccm_y);
3087             [xi,yi] = meshgrid(im_x, im_y);
3088             
3089             component_resize(:,:,1) = interp2(x, y, self.data(self.gui.current_trial).viz.component_color_map(:,:,1), xi, yi);
3090             component_resize(:,:,2) = interp2(x, y, self.data(self.gui.current_trial).viz.component_color_map(:,:,2), xi, yi);
3091             component_resize(:,:,3) = interp2(x, y, self.data(self.gui.current_trial).viz.component_color_map(:,:,3), xi, yi);
3092             
3093             component_resize(isnan(component_resize)) = 0;
3094             
3095             self.data(self.gui.current_trial).viz.im_data = <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>((1 - s.alpha) * component_resize + s.alpha * <a href="norm_range.html" class="code" title="function nmat = norm_range(mat, rmin, rmax)">norm_range</a>(nccd));
3096             self.data(self.gui.current_trial).viz.im_x = im_x;
3097             self.data(self.gui.current_trial).viz.im_y = im_y;
3098             
3099             self.gui.d(self.gui.current_trial).last_display = 0;
3100             
3101             self.update();
3102         <span class="keyword">end</span>
3103     <span class="keyword">end</span>
3104     
3105 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 18-Feb-2014 14:58:14 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>